<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Advantage Solutions Success Chart</title>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        /* --- BRAND COLOR PALETTE --- */
        :root {
            --brand-navy: #0C1030;
            --brand-teal: #10C3B0;
            --brand-aqua: #3DE0D2;
            --brand-pink: #E64563;
            --brand-gold: #F4B03A;
            --brand-yellow: #F9C863;
            --light-text: #F2F4F8;
            --card-bg: #131a40;
            --input-bg: #090c26;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--brand-navy) 0%, #050816 100%);
            color: var(--light-text);
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--brand-aqua), var(--brand-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--brand-gold);
            font-size: 1.1rem;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 224, 210, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            color: var(--brand-aqua);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-icon {
            font-size: 2rem;
        }

        .metric-large {
            font-size: 3rem;
            font-weight: 900;
            color: var(--brand-gold);
            line-height: 1;
            margin: 10px 0;
        }

        .metric-label {
            color: var(--light-text);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--brand-teal);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--brand-aqua);
            box-shadow: 0 0 0 3px rgba(61, 224, 210, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow));
            border: none;
            padding: 12px 24px;
            color: var(--brand-navy);
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 15px;
            font-size: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 176, 58, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .funnel-container {
            margin-top: 20px;
        }

        .funnel-stage {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .funnel-stage-label {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .funnel-stage-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-gold);
        }

        .funnel-stage-rate {
            font-size: 0.8rem;
            color: var(--brand-teal);
            margin-left: 10px;
        }

        .coaching-card {
            background: linear-gradient(135deg, rgba(16, 195, 176, 0.1), rgba(61, 224, 210, 0.05));
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--brand-teal);
        }

        .coaching-title {
            color: var(--brand-aqua);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .coaching-content {
            color: var(--light-text);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .priority-high {
            border-left-color: var(--brand-pink);
        }

        .priority-medium {
            border-left-color: var(--brand-gold);
        }

        .priority-low {
            border-left-color: var(--brand-teal);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-gold);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--light-text);
            opacity: 0.7;
            margin-top: 5px;
        }

        .progress-bar-bg {
            background-color: rgba(255,255,255,0.1);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
            transition: width 0.5s ease-in-out;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .alert-success {
            background: rgba(16, 195, 176, 0.2);
            border: 1px solid var(--brand-teal);
            color: var(--brand-aqua);
        }

        .alert-error {
            background: rgba(230, 69, 99, 0.2);
            border: 1px solid var(--brand-pink);
            color: var(--brand-pink);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--brand-teal);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }

        .wide-card {
            grid-column: span 2;
        }

        @media (max-width: 1200px) {
            .wide-card {
                grid-column: span 1;
            }
        }

        /* Circular Progress Indicators */
        .goal-progress-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .circular-progress {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 10;
        }

        .progress-circle-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-circle-fill.dials {
            stroke: var(--brand-teal);
        }

        .progress-circle-fill.conversations {
            stroke: var(--brand-aqua);
        }

        .progress-circle-fill.meetings {
            stroke: var(--brand-gold);
        }

        .progress-circle-fill.sales {
            stroke: var(--brand-pink);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--brand-gold);
            line-height: 1;
        }

        .progress-goal {
            font-size: 0.75rem;
            color: var(--light-text);
            opacity: 0.6;
            margin-top: 2px;
        }

        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--light-text);
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 0.8rem;
            color: var(--brand-teal);
            margin-top: 3px;
        }

        /* Tab styles for Monthly/YTD toggle */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--light-text);
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            color: var(--brand-navy);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="header">
            <h1>AI Advantage Solutions Success Chart</h1>
            <p>Performance Analytics & AI Coaching</p>
            <div style="margin-top: 15px;">
                <a href="sandler-email-generator.html" style="display: inline-block; background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow)); color: var(--brand-navy); padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: 700; transition: transform 0.2s ease;">
                    üìß Open Email Generator
                </a>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">

            <!-- Daily Activity Input Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Activity</h2>
                    <span class="card-icon">üìä</span>
                </div>

                <div class="input-group">
                    <label># of Dials</label>
                    <input type="number" id="input-dials" min="0" value="0">
                </div>

                <div class="input-group">
                    <label># of Conversations</label>
                    <input type="number" id="input-conversations" min="0" value="0">
                </div>

                <div class="input-group">
                    <label># of Discovery Meetings</label>
                    <input type="number" id="input-meetings" min="0" value="0">
                </div>

                <button class="btn-primary" onclick="saveDailyStats()">Save Today's Stats</button>
            </div>

            <!-- Daily Goal Progress Card -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Today's Goal Progress</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div class="goal-progress-container" id="goal-progress-container">
                    <!-- Goal circles will be dynamically inserted here -->
                </div>
            </div>

            <!-- Sales Entry Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Record Sale</h2>
                    <span class="card-icon">üí∞</span>
                </div>

                <div class="input-group">
                    <label>Sale Amount (CAD)</label>
                    <input type="number" id="input-amount" min="0" step="0.01" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label>Client Name</label>
                    <input type="text" id="input-client" placeholder="Client name">
                </div>

                <div class="input-group">
                    <label>Service Type</label>
                    <select id="input-service">
                        <option value="">Select service...</option>
                        <option value="Mixed Income Development">Mixed Income Development</option>
                        <option value="Near Market Rentals">Near Market Rentals</option>
                        <option value="AODA Compliance">AODA Compliance</option>
                        <option value="Tenant Engagement">Tenant Engagement</option>
                        <option value="Process Optimization">Process Optimization</option>
                        <option value="Digital Solutions">Digital Solutions</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="recordSale()">Record Sale</button>
            </div>

            <!-- Conversion Funnel Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Conversion Funnel</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchFunnelTab('monthly')">This Month</button>
                    <button class="tab-btn" onclick="switchFunnelTab('ytd')">Year to Date</button>
                </div>

                <div class="tab-content active" id="funnel-monthly">
                    <div class="funnel-container" id="funnel-container-monthly">
                        <div class="loading">Loading monthly data...</div>
                    </div>
                </div>

                <div class="tab-content" id="funnel-ytd">
                    <div class="funnel-container" id="funnel-container-ytd">
                        <div class="loading">Loading YTD data...</div>
                    </div>
                </div>
            </div>

            <!-- Revenue Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Revenue Overview</h2>
                    <span class="card-icon">üíµ</span>
                </div>

                <div class="metric-large" id="total-revenue">$0</div>
                <div class="metric-label">Total Revenue (CAD)</div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="total-sales">0</div>
                        <div class="stat-label">Total Sales</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-sale">$0</div>
                        <div class="stat-label">Avg Sale Value</div>
                    </div>
                </div>
            </div>

            <!-- Annual Sales Goal Tracker -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">2025 Revenue Goal</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 0.9rem;">Annual Goal (CAD)</label>
                    <input type="number" id="annual-goal" value="120000" min="0" step="1000"
                        style="width: 100%; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--brand-teal); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 1rem;"
                        onchange="updateGoalTracking()">
                </div>

                <div id="goal-breakdown" style="margin-top: 15px;">
                    <!-- Goal breakdown will be inserted here -->
                </div>
            </div>

            <!-- Weekly Performance Chart -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Weekly Performance Trend</h2>
                    <span class="card-icon">üìà</span>
                </div>
                <div class="chart-container">
                    <canvas id="weekly-chart"></canvas>
                </div>
            </div>

            <!-- AI Coaching Insights -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">AI Performance Coach</h2>
                    <span class="card-icon">ü§ñ</span>
                </div>

                <div id="coaching-insights">
                    <div class="loading">Analyzing your performance...</div>
                </div>

                <button class="btn-primary" onclick="generateCoachingInsights()">Refresh Insights</button>
            </div>

            <!-- Cold Call Script Reference -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üìã Cold Call Script</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <p style="opacity: 0.9; margin-bottom: 15px;">Your proven script for mixed-income community providers. Click sections to expand.</p>

                <div style="background: rgba(16, 195, 176, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üìû Opening Script
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--brand-gold);">Opener & Pacing:</strong>
                                <p style="margin-top: 8px; line-height: 1.6;">
                                    "Hi <strong>[Person]</strong>, this is John from AI Advantage Solutions here in Hamilton. I know I'm catching you cold, so I'll be brief."
                                </p>
                                <p style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px;">üí° Mention local connection and respect their time.</p>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--brand-gold);">Value Proposition:</strong>
                                <p style="margin-top: 8px; line-height: 1.6;">
                                    "I help mixed-income community providers like <strong>[Person]</strong> save up to 20 hours per week by automating repetitive tasks‚Äîthings like maintenance requests, tenant communications, and compliance tracking."
                                </p>
                                <p style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px;">üí° Clearly state the benefit (time savings) and how (automation).</p>
                            </div>

                            <div>
                                <strong style="color: var(--brand-gold);">Call to Action:</strong>
                                <p style="margin-top: 8px; line-height: 1.6;">
                                    "I'd love to show you how in a quick 15-minute online meeting. Do you have your calendar handy, or would <strong>[Date]</strong> at <strong>[Time]</strong> work better?"
                                </p>
                                <p style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px;">üí° Use a soft commitment to a short meeting and offer a choice of times.</p>
                            </div>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üõ°Ô∏è Objection: "Not interested"
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <strong style="color: var(--brand-pink);">Response:</strong>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                "I appreciate your honesty. Can I ask‚Äîis it because you've already automated most of your operations, or is this just not a priority right now?"
                            </p>
                            <p style="margin-top: 12px;"><strong>If they answer:</strong></p>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                Listen, then follow up with: "That makes sense. Would it be okay if I followed up in [3-6 months] when things might be different?"
                            </p>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üõ°Ô∏è Objection: "I already have it covered"
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <strong style="color: var(--brand-pink);">Response:</strong>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                "That's great you're thinking about this. Just curious‚Äîare you handling it internally, or working with someone?"
                            </p>
                            <p style="margin-top: 12px;"><strong>Acknowledge and pivot:</strong></p>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                "Got it. Well, if you ever want a second opinion on what else might be possible, I'm happy to share some ideas specific to mixed-income providers. Can I send you a quick case study?"
                            </p>
                        </div>
                    </details>

                    <details>
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üõ°Ô∏è Objection: "Send me some information"
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <strong style="color: var(--brand-pink);">Response:</strong>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                "Absolutely, I can do that. To make sure I send something relevant‚Äîwhat's your biggest time drain right now? Maintenance coordination, leasing, compliance reporting?"
                            </p>
                            <p style="margin-top: 12px;"><strong>Close on the meeting:</strong></p>
                            <p style="margin-top: 8px; line-height: 1.6;">
                                "Perfect. I'll send that over today. How about we schedule 15 minutes next week so I can walk you through how [specific solution] would work for your situation?"
                            </p>
                            <p style="opacity: 0.8; margin-top: 12px; padding: 10px; background: rgba(244, 176, 58, 0.2); border-radius: 6px;">
                                <strong>‚ö†Ô∏è Pro Tip:</strong> Always follow up within 48 hours with a specific meeting time suggestion rather than asking "Did you get a chance to review it?"
                            </p>
                        </div>
                    </details>
                </div>

                <div style="background: linear-gradient(135deg, rgba(244, 176, 58, 0.2), rgba(249, 200, 99, 0.1)); padding: 15px; border-radius: 10px; border-left: 4px solid var(--brand-gold);">
                    <strong style="color: var(--brand-gold);">üéØ Script Adherence Tip:</strong>
                    <p style="margin-top: 8px; line-height: 1.6; opacity: 0.9;">
                        When analyzing your calls below, the AI will check if you followed this script structure and provide specific coaching on improvements!
                    </p>
                </div>
            </div>

            <!-- Sandler Conversation Analysis -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üéôÔ∏è Sandler Conversation Coach</h2>
                    <span class="card-icon">üìû</span>
                </div>

                <p style="opacity: 0.9; margin-bottom: 20px;">Upload a sales call recording or transcript to get detailed Sandler coaching on your conversation execution AND script adherence.</p>

                <div class="input-group">
                    <label>Conversation Title</label>
                    <input type="text" id="conversation-title" placeholder="e.g., Discovery Call - ABC Housing Corp">
                </div>

                <div class="input-group">
                    <label>Type of Call</label>
                    <select id="conversation-type">
                        <option value="cold_call">Cold Call</option>
                        <option value="discovery" selected>Discovery Meeting</option>
                        <option value="demo">Demo/Presentation</option>
                        <option value="close">Closing Call</option>
                        <option value="follow_up">Follow-Up</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Upload Audio or Paste Transcript</label>
                    <input type="file" id="audio-upload" accept=".mp3,.wav,.m4a,.txt" style="margin-bottom: 10px;">
                    <textarea id="transcript-input" rows="6" placeholder="Or paste your conversation transcript here...

Example:
Rep: Hi John, thanks for taking my call. I know you're busy...
Prospect: No problem, what's this about?
Rep: I wanted to learn more about your housing operations..."></textarea>
                </div>

                <button class="btn-primary" onclick="analyzeConversation()">üéØ Analyze with Sandler Coach</button>

                <div id="conversation-analysis-result" style="margin-top: 20px;"></div>
            </div>

            <!-- Recent Conversation Analyses -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üìä Conversation History</h2>
                    <span class="card-icon">üìà</span>
                </div>

                <div id="conversation-history">
                    <div class="loading">Loading conversation analyses...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // REPLACE THESE WITH YOUR SUPABASE PROJECT DETAILS
        const SUPABASE_URL = 'https://qwqlsbccwnwrdpcaccjz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3cWxzYmNjd253cmRwY2FjY2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTA1MDQsImV4cCI6MjA4MDg4NjUwNH0.yWzSV2Nid_T1XiDE0RrskFob9mRUc-m6MbeIiT7huC4';

        // ============================================
        // EDGE FUNCTION CONFIGURATION
        // ============================================
        // For public deployment, conversation analysis uses a secure Supabase Edge Function
        // No API keys needed in this file - they're stored securely on the server
        const USE_EDGE_FUNCTION = true; // Set to true for public deployment

        let supabaseClient;

        // Initialize Supabase client
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error('Supabase initialization error:', error);
            showAlert('Please configure your Supabase credentials in the code.', 'error');
        }

        // ============================================
        // CONFETTI CELEBRATION
        // ============================================

        function celebrateWithConfetti(type = 'default') {
            if (typeof confetti === 'undefined') {
                console.warn('Confetti library not loaded');
                return;
            }

            if (type === 'sale') {
                // Bigger celebration for sales with gold colors
                const count = 200;
                const defaults = {
                    origin: { y: 0.7 },
                    colors: ['#F4B03A', '#F9C863', '#10C3B0', '#3DE0D2']
                };

                function fire(particleRatio, opts) {
                    confetti({
                        ...defaults,
                        ...opts,
                        particleCount: Math.floor(count * particleRatio)
                    });
                }

                fire(0.25, {
                    spread: 26,
                    startVelocity: 55,
                });
                fire(0.2, {
                    spread: 60,
                });
                fire(0.35, {
                    spread: 100,
                    decay: 0.91,
                    scalar: 0.8
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 25,
                    decay: 0.92,
                    scalar: 1.2
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 45,
                });
            } else {
                // Standard celebration for daily stats with teal colors
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#10C3B0', '#3DE0D2', '#F4B03A']
                });
            }
        }

        // ============================================
        // DATA MANAGEMENT FUNCTIONS
        // ============================================

        // Save daily statistics
        async function saveDailyStats() {
            const dials = parseInt(document.getElementById('input-dials').value) || 0;
            const conversations = parseInt(document.getElementById('input-conversations').value) || 0;
            const meetings = parseInt(document.getElementById('input-meetings').value) || 0;

            if (dials === 0 && conversations === 0 && meetings === 0) {
                showAlert('Please enter at least one activity.', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            try {
                const { data, error } = await supabaseClient
                    .from('Daily_Tracker')
                    .upsert({
                        date: today,
                        dials: dials,
                        conversations: conversations,
                        discovery_meetings: meetings
                    }, { onConflict: 'date' });

                if (error) throw error;

                showAlert('Daily stats saved successfully!', 'success');
                celebrateWithConfetti('default');

                // Reset inputs
                document.getElementById('input-dials').value = 0;
                document.getElementById('input-conversations').value = 0;
                document.getElementById('input-meetings').value = 0;

                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error saving daily stats:', error);
                showAlert('Failed to save stats. Please try again.', 'error');
            }
        }

        // Record a sale
        async function recordSale() {
            const amount = parseFloat(document.getElementById('input-amount').value) || 0;
            const client = document.getElementById('input-client').value.trim();
            const service = document.getElementById('input-service').value;

            if (amount === 0) {
                showAlert('Please enter a sale amount.', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            try {
                const { data, error } = await supabaseClient
                    .from('Sales')
                    .insert({
                        date: today,
                        amount_cad: amount,
                        client_name: client,
                        service_type: service
                    });

                if (error) throw error;

                showAlert(`Sale of $${amount.toFixed(2)} CAD recorded!`, 'success');
                celebrateWithConfetti('sale');

                // Reset inputs
                document.getElementById('input-amount').value = '';
                document.getElementById('input-client').value = '';
                document.getElementById('input-service').value = '';

                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error recording sale:', error);
                showAlert('Failed to record sale. Please try again.', 'error');
            }
        }

        // ============================================
        // DASHBOARD DATA LOADING
        // ============================================

        async function loadDashboardData() {
            await Promise.all([
                loadConversionFunnel(),
                loadGoalProgress(),
                loadRevenueSummary(),
                loadWeeklyChart(),
                loadCoachingInsights()
            ]);
        }

        // Load conversion funnel data
        async function loadConversionFunnel() {
            try {
                // Get current date info
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                const currentYear = now.getFullYear().toString();

                // Fetch all daily tracker data for YTD
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (dailyError) throw dailyError;

                // Fetch sales data for YTD
                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (salesError) throw salesError;

                // Calculate monthly metrics
                const monthlyData = dailyData.filter(d => d.date.startsWith(currentMonth));
                const monthlySales = salesData.filter(s => s.date.startsWith(currentMonth));

                const monthlyMetrics = calculateMetrics(monthlyData, monthlySales);

                // Calculate YTD metrics
                const ytdMetrics = calculateMetrics(dailyData, salesData);

                // Render monthly funnel
                renderFunnel('funnel-container-monthly', monthlyMetrics);

                // Render YTD funnel
                renderFunnel('funnel-container-ytd', ytdMetrics);

            } catch (error) {
                console.error('Error loading funnel:', error);
                document.getElementById('funnel-container-monthly').innerHTML = '<p style="color: var(--brand-pink);">Unable to load funnel data.</p>';
                document.getElementById('funnel-container-ytd').innerHTML = '<p style="color: var(--brand-pink);">Unable to load funnel data.</p>';
            }
        }

        // Calculate metrics from daily data
        function calculateMetrics(dailyData, salesData) {
            const totalDials = dailyData.reduce((sum, d) => sum + (d.dials || 0), 0);
            const totalConversations = dailyData.reduce((sum, d) => sum + (d.conversations || 0), 0);
            const totalMeetings = dailyData.reduce((sum, d) => sum + (d.discovery_meetings || 0), 0);
            const totalSales = salesData.length;

            const dialToConvRate = totalDials > 0 ? ((totalConversations / totalDials) * 100).toFixed(1) : 0;
            const convToMeetingRate = totalConversations > 0 ? ((totalMeetings / totalConversations) * 100).toFixed(1) : 0;
            const meetingToSaleRate = totalMeetings > 0 ? ((totalSales / totalMeetings) * 100).toFixed(1) : 0;

            return {
                totalDials,
                totalConversations,
                totalMeetings,
                totalSales,
                dialToConvRate,
                convToMeetingRate,
                meetingToSaleRate
            };
        }

        // Render funnel HTML
        function renderFunnel(containerId, metrics) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üìû Dials</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalDials}</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üí¨ Conversations</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalConversations}</span>
                        <span class="funnel-stage-rate">${metrics.dialToConvRate}%</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">ü§ù Discovery Meetings</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalMeetings}</span>
                        <span class="funnel-stage-rate">${metrics.convToMeetingRate}%</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üí∞ Sales Closed</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalSales}</span>
                        <span class="funnel-stage-rate">${metrics.meetingToSaleRate}%</span>
                    </span>
                </div>
            `;
        }

        // Switch between monthly and YTD tabs
        function switchFunnelTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'monthly') {
                tabs[0].classList.add('active');
                document.getElementById('funnel-monthly').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('funnel-ytd').classList.add('active');
            }
        }

        // Load goal progress circles
        async function loadGoalProgress() {
            try {
                // Define daily goals
                const goals = {
                    dials: 15,
                    conversations: 5,
                    meetings: 2,
                    sales: 1
                };

                // Get today's date
                const today = new Date().toISOString().split('T')[0];

                // Fetch today's activity data
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .eq('date', today)
                    .single();

                // Fetch today's sales
                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .eq('date', today);

                const actual = {
                    dials: dailyData?.dials || 0,
                    conversations: dailyData?.conversations || 0,
                    meetings: dailyData?.discovery_meetings || 0,
                    sales: salesData?.length || 0
                };

                // Render the progress circles
                const container = document.getElementById('goal-progress-container');
                container.innerHTML = `
                    ${createCircularProgress('Dials', actual.dials, goals.dials, 'dials')}
                    ${createCircularProgress('Conversations', actual.conversations, goals.conversations, 'conversations')}
                    ${createCircularProgress('Meetings', actual.meetings, goals.meetings, 'meetings')}
                    ${createCircularProgress('Sales', actual.sales, goals.sales, 'sales')}
                `;

            } catch (error) {
                console.error('Error loading goal progress:', error);
            }
        }

        // Create circular progress indicator HTML
        function createCircularProgress(label, actual, goal, className) {
            const percentage = Math.min((actual / goal) * 100, 100);
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            return `
                <div>
                    <div class="circular-progress">
                        <svg width="140" height="140">
                            <circle class="progress-circle-bg" cx="70" cy="70" r="${radius}"></circle>
                            <circle class="progress-circle-fill ${className}" cx="70" cy="70" r="${radius}"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
                        </svg>
                        <div class="progress-text">
                            <div class="progress-value">${actual}</div>
                            <div class="progress-goal">of ${goal}</div>
                        </div>
                    </div>
                    <div class="progress-label">${label}</div>
                    <div class="progress-percentage">${percentage.toFixed(0)}% Complete</div>
                </div>
            `;
        }

        // Load revenue summary
        async function loadRevenueSummary() {
            try {
                const { data, error } = await supabaseClient
                    .from('Sales')
                    .select('amount_cad');

                if (error) throw error;

                const totalRevenue = data.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const totalSales = data.length;
                const avgSale = totalSales > 0 ? totalRevenue / totalSales : 0;

                document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
                document.getElementById('total-sales').textContent = totalSales;
                document.getElementById('avg-sale').textContent = `$${avgSale.toFixed(2)}`;

                // Update goal tracking
                updateGoalTracking(totalRevenue);
            } catch (error) {
                console.error('Error loading revenue:', error);
            }
        }

        // Update goal tracking breakdown
        function updateGoalTracking(currentRevenue = 0) {
            const annualGoal = parseFloat(document.getElementById('annual-goal').value) || 120000;
            const monthlyGoal = annualGoal / 12;
            const weeklyGoal = annualGoal / 52;

            // Calculate progress
            const yearProgress = (currentRevenue / annualGoal) * 100;

            // Get current month and week revenue
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            // Calculate monthly and weekly revenue (simplified - using YTD for now)
            const monthProgress = Math.min((currentRevenue / monthlyGoal) * 100, 100);
            const weekProgress = Math.min((currentRevenue / weeklyGoal) * 100, 100);

            document.getElementById('goal-breakdown').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem;">Annual Progress</span>
                        <span style="color: var(--brand-gold); font-weight: 600;">$${currentRevenue.toFixed(0)} / $${annualGoal.toFixed(0)}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: ${Math.min(yearProgress, 100)}%;"></div>
                    </div>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--brand-teal);">
                        ${yearProgress.toFixed(1)}% Complete
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-box">
                        <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-teal);">
                            $${monthlyGoal.toFixed(0)}
                        </div>
                        <div class="stat-label">Monthly Target</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-aqua);">
                            $${weeklyGoal.toFixed(0)}
                        </div>
                        <div class="stat-label">Weekly Target</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(16, 195, 176, 0.1); border-radius: 10px;">
                    <div style="font-size: 0.85rem; color: var(--light-text); opacity: 0.8; margin-bottom: 8px;">
                        To hit your annual goal of $${annualGoal.toFixed(0)}:
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        üí∞ Close <strong style="color: var(--brand-gold);">${Math.ceil(annualGoal / 5000)}</strong> deals at $5,000 each<br>
                        üìÖ Average <strong style="color: var(--brand-teal);">${Math.ceil(monthlyGoal / 5000)}</strong> deals per month<br>
                        üìä Need <strong style="color: var(--brand-aqua);">${(weeklyGoal / 5000).toFixed(1)}</strong> deals per week
                    </div>
                </div>
            `;
        }

        // Load weekly performance chart
        let weeklyChart = null;
        async function loadWeeklyChart() {
            try {
                const { data, error } = await supabaseClient
                    .from('Weekly_Performance')
                    .select('*')
                    .order('week_start', { ascending: true })
                    .limit(8);

                if (error) throw error;

                const labels = data.map(week => {
                    const date = new Date(week.week_start);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });

                const dialData = data.map(week => week.total_dials || 0);
                const conversationData = data.map(week => week.total_conversations || 0);
                const meetingData = data.map(week => week.total_meetings || 0);

                const ctx = document.getElementById('weekly-chart').getContext('2d');

                if (weeklyChart) {
                    weeklyChart.destroy();
                }

                weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Dials',
                                data: dialData,
                                borderColor: '#10C3B0',
                                backgroundColor: 'rgba(16, 195, 176, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Conversations',
                                data: conversationData,
                                borderColor: '#F4B03A',
                                backgroundColor: 'rgba(244, 176, 58, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Meetings',
                                data: meetingData,
                                borderColor: '#E64563',
                                backgroundColor: 'rgba(230, 69, 99, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#F2F4F8'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#F2F4F8'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#F2F4F8'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        // ============================================
        // AI COACHING SYSTEM (RAG-like insights)
        // ============================================

        async function loadCoachingInsights() {
            try {
                const { data, error } = await supabaseClient
                    .from('Coaching_Insights')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const container = document.getElementById('coaching-insights');

                if (data.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7;">No insights yet. Click "Refresh Insights" to generate coaching.</p>';
                    return;
                }

                container.innerHTML = data.map(insight => `
                    <div class="coaching-card priority-${insight.priority}">
                        <div class="coaching-title">${insight.title}</div>
                        <div class="coaching-content">${insight.content}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading insights:', error);
                document.getElementById('coaching-insights').innerHTML = '<p style="color: var(--brand-pink);">Unable to load insights.</p>';
            }
        }

        async function generateCoachingInsights() {
            showAlert('Generating AI coaching insights...', 'success');

            try {
                // Fetch recent performance data
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(30);

                if (dailyError) throw dailyError;

                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(30);

                if (salesError) throw salesError;

                // Generate insights based on patterns
                const insights = analyzePerformance(dailyData, salesData);

                // Save insights to database
                for (const insight of insights) {
                    await supabaseClient.from('Coaching_Insights').insert({
                        date: new Date().toISOString().split('T')[0],
                        insight_type: insight.type,
                        title: insight.title,
                        content: insight.content,
                        priority: insight.priority
                    });
                }

                // Reload insights display
                await loadCoachingInsights();
                showAlert('Coaching insights generated!', 'success');
            } catch (error) {
                console.error('Error generating insights:', error);
                showAlert('Failed to generate insights.', 'error');
            }
        }

        // Analyze performance and generate insights with SANDLER SALES METHODOLOGY
        function analyzePerformance(dailyData, salesData) {
            const insights = [];
            const today = new Date().toISOString().split('T')[0];

            if (dailyData.length === 0) {
                insights.push({
                    type: 'alert',
                    title: 'üöÄ Get Started - Sandler Cookbook',
                    content: 'Start tracking your daily activities to unlock Sandler-based coaching insights. Remember: Success in sales = Activity √ó Effectiveness. Log your dials, conversations, and meetings.',
                    priority: 'high'
                });
                return insights;
            }

            // Calculate metrics
            const totalDials = dailyData.reduce((sum, day) => sum + (day.dials || 0), 0);
            const totalConversations = dailyData.reduce((sum, day) => sum + (day.conversations || 0), 0);
            const totalMeetings = dailyData.reduce((sum, day) => sum + (day.discovery_meetings || 0), 0);
            const avgDials = totalDials / dailyData.length;
            const conversionRate = totalDials > 0 ? (totalConversations / totalDials) * 100 : 0;
            const meetingRate = totalConversations > 0 ? (totalMeetings / totalConversations) * 100 : 0;
            const closeRate = totalMeetings > 0 ? (salesData.length / totalMeetings) * 100 : 0;

            // SANDLER INSIGHT 1: Cookbook Consistency - Daily Behavior
            if (avgDials < 10) {
                insights.push({
                    type: 'suggestion',
                    title: 'üìû Sandler Cookbook: Increase Activity',
                    content: `You're averaging ${avgDials.toFixed(1)} dials per day. Sandler principle: "You can't control outcomes, only behaviors." Target 20-30 prospecting calls daily. Block time like a real appointment - no interruptions.`,
                    priority: 'high'
                });
            } else if (avgDials >= 20) {
                insights.push({
                    type: 'milestone',
                    title: 'üåü Sandler Behavior: Excellent Activity',
                    content: `You're averaging ${avgDials.toFixed(1)} dials per day - outstanding cookbook execution! Remember: "Success = Activity √ó Effectiveness". Keep this momentum going.`,
                    priority: 'low'
                });
            }

            // SANDLER INSIGHT 2: Bonding & Rapport - Getting Conversations
            if (conversionRate < 15 && totalDials >= 20) {
                insights.push({
                    type: 'performance',
                    title: 'ü§ù Sandler: Work on Bonding & Rapport',
                    content: `Your dial-to-conversation rate is ${conversionRate.toFixed(1)}%. Sandler tip: People buy from people they trust. Focus on bonding in the first 30 seconds. Ask: "How's your day going?" before jumping into business. Use Negative Reverse Selling: "I'm not sure if we're a fit, but..."`,
                    priority: 'high'
                });
            } else if (conversionRate >= 25) {
                insights.push({
                    type: 'milestone',
                    title: 'üéØ Sandler: Strong Bonding Skills',
                    content: `Your ${conversionRate.toFixed(1)}% conversation rate shows excellent bonding! You're building rapport effectively. Keep using curiosity-based questions and avoiding "show up and throw up" presentations.`,
                    priority: 'low'
                });
            }

            // SANDLER INSIGHT 3: Up-Front Contracts - Meeting Conversion
            if (meetingRate < 20 && totalConversations >= 10) {
                insights.push({
                    type: 'suggestion',
                    title: 'üìã Sandler: Set Up-Front Contracts',
                    content: `${meetingRate.toFixed(1)}% of conversations lead to meetings. Sandler principle: Always set an Up-Front Contract. Ask: "Would it make sense to schedule 15 minutes to explore if we're a fit? At the end, you can tell me 'yes,' 'no,' or 'let's talk again.' Fair enough?" This removes pressure and increases bookings.`,
                    priority: 'high'
                });
            } else if (meetingRate >= 30) {
                insights.push({
                    type: 'milestone',
                    title: 'üìã Sandler: Excellent Up-Front Contracts',
                    content: `${meetingRate.toFixed(1)}% meeting conversion shows you're setting clear expectations! Keep using Up-Front Contracts to build trust and reduce no-shows.`,
                    priority: 'low'
                });
            }

            // SANDLER INSIGHT 4: Pain Funnel & Closing - Revenue Performance
            if (salesData.length > 0) {
                const totalRevenue = salesData.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const avgSale = totalRevenue / salesData.length;

                insights.push({
                    type: 'performance',
                    title: 'üí∞ Sandler: Revenue & Pain Discovery',
                    content: `You've closed ${salesData.length} sales (${closeRate.toFixed(1)}% close rate) with average value of $${avgSale.toFixed(2)} CAD. Total: $${totalRevenue.toFixed(2)} CAD. Sandler reminder: "No pain, no change." Keep using the Pain Funnel in discovery meetings to uncover compelling reasons to buy.`,
                    priority: 'low'
                });

                // Close rate coaching
                if (closeRate < 25 && totalMeetings >= 5) {
                    insights.push({
                        type: 'suggestion',
                        title: 'üîç Sandler: Use the Pain Funnel',
                        content: `Your ${closeRate.toFixed(1)}% close rate suggests qualification gaps. In discovery meetings, use the Pain Funnel: "Tell me more about that... How long has that been a problem? What have you tried? How much is it costing you? What happens if you don't fix it?" Uncover COMPELLING pain, not just technical needs.`,
                        priority: 'high'
                    });
                } else if (closeRate >= 40) {
                    insights.push({
                        type: 'milestone',
                        title: 'üéØ Sandler: Excellent Qualification',
                        content: `Your ${closeRate.toFixed(1)}% close rate shows you're qualifying well! You're uncovering real pain and only moving forward with qualified prospects. This is true Sandler discipline.`,
                        priority: 'low'
                    });
                }
            }

            // SANDLER INSIGHT 5: Budget & Decision - Qualification Discipline
            if (totalMeetings >= 5 && salesData.length === 0) {
                insights.push({
                    type: 'alert',
                    title: 'üíµ Sandler: Qualify Budget & Decision Early',
                    content: `You've held ${totalMeetings} meetings but no sales yet. Sandler tip: Don't waste time on unqualified prospects. In first call, ask: "If this makes sense, what kind of budget have you set aside?" and "Who else needs to be involved in this decision?" Disqualify fast to focus on real opportunities.`,
                    priority: 'high'
                });
            }

            // SANDLER INSIGHT 6: Cookbook Consistency - Daily Discipline
            const activeDays = dailyData.filter(day => (day.dials || 0) > 0).length;
            const consistencyRate = (activeDays / dailyData.length) * 100;

            if (consistencyRate < 70) {
                insights.push({
                    type: 'alert',
                    title: 'üìÖ Sandler Cookbook: Build Consistency',
                    content: `You've been active ${activeDays} out of ${dailyData.length} days (${consistencyRate.toFixed(0)}%). Sandler principle: "The Cookbook is your recipe for success." Treat prospecting time as sacred. Block your calendar and protect it like you would a meeting with your best client. Consistency compounds.`,
                    priority: 'high'
                });
            } else if (consistencyRate >= 85) {
                insights.push({
                    type: 'milestone',
                    title: 'üìñ Sandler Cookbook: Excellent Discipline',
                    content: `${consistencyRate.toFixed(0)}% consistency shows true cookbook discipline! You're treating sales as a science, not an art. This consistent behavior WILL drive predictable results.`,
                    priority: 'low'
                });
            }

            // SANDLER INSIGHT 7: Negative Reverse Selling Reminder
            if (totalConversations >= 10 && conversionRate < 20) {
                insights.push({
                    type: 'suggestion',
                    title: 'üîÑ Sandler: Try Negative Reverse Selling',
                    content: `Low conversation-to-meeting rate? Try Negative Reverse Selling to remove pressure: "I'm not sure if what we do is a fit for you, but would it make sense to spend 10 minutes finding out? Worst case, we'll both know it's not a match." This approach often INCREASES interest by removing the "sales pressure."`,
                    priority: 'medium'
                });
            }

            return insights;
        }

        // ============================================
        // SANDLER CONVERSATION ANALYSIS
        // ============================================

        async function analyzeConversation() {
            const title = document.getElementById('conversation-title').value.trim();
            const type = document.getElementById('conversation-type').value;
            const audioFile = document.getElementById('audio-upload').files[0];
            const transcript = document.getElementById('transcript-input').value.trim();

            if (!title) {
                showAlert('Please enter a conversation title.', 'error');
                return;
            }

            if (!transcript && !audioFile) {
                showAlert('Please upload an audio file or paste a transcript.', 'error');
                return;
            }

            showAlert('üéØ Analyzing conversation with Sandler framework...', 'success');

            try {
                let finalTranscript = transcript;

                // If audio file uploaded, transcribe it first
                if (audioFile && !transcript) {
                    showAlert('üéôÔ∏è Transcribing audio with Whisper...', 'success');

                    try {
                        // Create form data for audio file
                        const formData = new FormData();
                        formData.append('audio', audioFile);

                        // Call transcribe-audio Edge Function
                        const { data: transcriptionData, error: transcriptionError } = await supabaseClient.functions.invoke('transcribe-audio', {
                            body: formData
                        });

                        if (transcriptionError) {
                            throw new Error(transcriptionError.message || 'Failed to transcribe audio');
                        }

                        if (!transcriptionData || !transcriptionData.transcript) {
                            throw new Error('No transcript returned from transcription service');
                        }

                        finalTranscript = transcriptionData.transcript;
                        showAlert('‚úÖ Audio transcribed successfully! Now analyzing with Sandler framework...', 'success');

                        // Show the transcript to the user
                        document.getElementById('transcript-input').value = finalTranscript;

                    } catch (transcriptionError) {
                        console.error('Transcription error:', transcriptionError);
                        showAlert(`Transcription failed: ${transcriptionError.message}. Please paste transcript manually.`, 'error');
                        return;
                    }
                }

                // Analyze transcript with Sandler methodology
                const analysis = await analyzeSandlerConversation(finalTranscript, type);

                // If no analysis (API key not configured), return early
                if (!analysis) {
                    return;
                }

                // Save to database
                const { data, error } = await supabaseClient
                    .from('Conversation_Analyses')
                    .insert({
                        date: new Date().toISOString().split('T')[0],
                        conversation_title: title,
                        conversation_type: type,
                        transcript: finalTranscript,
                        overall_sandler_score: analysis.overall_score,
                        upfront_contract_score: analysis.upfront_contract_score,
                        pain_funnel_score: analysis.pain_funnel_score,
                        budget_discussion_score: analysis.budget_discussion_score,
                        decision_process_score: analysis.decision_process_score,
                        bonding_rapport_score: analysis.bonding_rapport_score,
                        talk_listen_ratio_score: analysis.talk_ratio_score,
                        what_went_well: analysis.what_went_well,
                        areas_to_improve: analysis.areas_to_improve,
                        specific_recommendations: analysis.recommendations,
                        talk_percentage: analysis.talk_percentage,
                        question_count: analysis.question_count,
                        pain_identified: analysis.pain_identified,
                        budget_discussed: analysis.budget_discussed,
                        decision_makers_identified: analysis.decision_makers_identified,
                        upfront_contract_set: analysis.upfront_contract_set,
                        negative_reverse_used: analysis.negative_reverse_used,
                        full_analysis_json: analysis
                    });

                if (error) throw error;

                // Display results
                displayAnalysisResults(analysis);

                // Celebrate with confetti!
                celebrateWithConfetti('default');

                showAlert('‚úÖ Conversation analyzed successfully!', 'success');

                // Clear inputs
                document.getElementById('conversation-title').value = '';
                document.getElementById('transcript-input').value = '';
                document.getElementById('audio-upload').value = '';

                // Reload history
                loadConversationHistory();

            } catch (error) {
                console.error('Error analyzing conversation:', error);
                showAlert('Failed to analyze conversation. Check console for details.', 'error');
            }
        }

        // Analyze conversation using Sandler methodology (with VERIFICATION)
        async function analyzeSandlerConversation(transcript, callType) {
            // Use secure Edge Function for public deployment
            if (USE_EDGE_FUNCTION) {
                try {
                    const { data, error } = await supabaseClient.functions.invoke('analyze-conversation', {
                        body: { transcript, callType }
                    });

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Edge Function Error:', error);
                    showAlert(`AI Analysis failed: ${error.message}`, 'error');
                    return null;
                }
            }

            // Legacy direct API call (NOT SECURE for public deployment)
            // Only use this for local testing
            const sandlerPrompt = `
You are an expert Sandler Sales trainer analyzing a sales conversation.

IMPORTANT: Be FACTUAL and EVIDENCE-BASED. Cite specific quotes from the transcript to support every observation.

Conversation Type: ${callType}

REFERENCE SCRIPT (AI Advantage Solutions):
Opening: "Hi [Person], this is John from AI Advantage Solutions here in Hamilton. I know I'm catching you cold, so I'll be brief."
Value Prop: "I help mixed-income community providers like [Person] save up to 20 hours per week by automating repetitive tasks‚Äîthings like maintenance requests, tenant communications, and compliance tracking."
CTA: "I'd love to show you how in a quick 15-minute online meeting. Do you have your calendar handy, or would [Date] at [Time] work better?"

TRANSCRIPT:
${transcript}

ANALYZE using Sandler Sales System methodology + Script Adherence:

1. SCRIPT ADHERENCE (Score 1-10)
   - Did they follow the opening structure?
   - Did they mention local connection (Hamilton)?
   - Did they state the value prop (20 hours saved, automation)?
   - Did they use the soft CTA (15-minute meeting)?
   - Quote evidence: [what they actually said]

2. UP-FRONT CONTRACT (Score 1-10)
   - Did they set clear expectations at the start?
   - Quote evidence: [exact quote]

3. BONDING & RAPPORT (Score 1-10)
   - Did they build trust before business?
   - Quote evidence: [exact quote]

4. PAIN FUNNEL (Score 1-10)
   - Did they uncover compelling pain?
   - Pain questions asked: [list with quotes]
   - Pain identified: Yes/No with evidence

5. BUDGET (Score 1-10)
   - Did they discuss budget/investment?
   - Quote evidence: [exact quote]

6. DECISION PROCESS (Score 1-10)
   - Did they identify decision-makers?
   - Quote evidence: [exact quote]

7. TALK/LISTEN RATIO (Score 1-10)
   - Estimate: Rep talked X%, Prospect Y%
   - Target: 30% rep / 70% prospect

8. NEGATIVE REVERSE SELLING (Yes/No)
   - Did they remove pressure?
   - Quote evidence if used

9. OBJECTION HANDLING (Score 1-10)
   - If objections came up, how well handled?
   - Did they follow script responses?
   - Quote evidence

Return JSON in this exact format:
{
  "overall_score": 7.5,
  "upfront_contract_score": 6.0,
  "pain_funnel_score": 8.0,
  "budget_discussion_score": 5.0,
  "decision_process_score": 7.0,
  "bonding_rapport_score": 9.0,
  "talk_ratio_score": 6.5,
  "talk_percentage": 45,
  "question_count": 12,
  "pain_identified": true,
  "budget_discussed": false,
  "decision_makers_identified": true,
  "upfront_contract_set": false,
  "negative_reverse_used": true,
  "what_went_well": ["item1", "item2"],
  "areas_to_improve": ["item1", "item2"],
  "recommendations": ["item1", "item2"]
}

ONLY include observations you can PROVE from the transcript.
            `;

            try {
                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': ANTHROPIC_API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-5-20250929',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: sandlerPrompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const analysisText = data.content[0].text;

                // Parse JSON from Claude's response
                const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not parse JSON from Claude response');
                }

                const analysis = JSON.parse(jsonMatch[0]);
                return analysis;

            } catch (error) {
                console.error('Claude API Error:', error);
                showAlert(`AI Analysis failed: ${error.message}`, 'error');

                // Return demo analysis as fallback
                return {
                overall_score: 7.5,
                upfront_contract_score: 6.0,
                pain_funnel_score: 8.0,
                budget_discussion_score: 5.0,
                decision_process_score: 7.0,
                bonding_rapport_score: 9.0,
                talk_ratio_score: 6.5,
                talk_percentage: 45,
                question_count: 12,
                pain_identified: true,
                budget_discussed: false,
                decision_makers_identified: true,
                upfront_contract_set: false,
                negative_reverse_used: true,
                what_went_well: [
                    "Excellent bonding at start - asked about their day",
                    "Strong pain discovery with follow-up questions",
                    "Used negative reverse: 'I'm not sure if we're a fit'",
                    "Good question-to-statement ratio"
                ],
                areas_to_improve: [
                    "No up-front contract set at beginning",
                    "Budget not discussed - qualify earlier",
                    "Talked 45% of time (target: 30%)",
                    "Jumped to solution before completing pain funnel"
                ],
                recommendations: [
                    "Start next call with: 'Would it make sense to spend 15 minutes exploring if we're a fit?'",
                    "After pain questions, ask: 'How much is this costing you per month?'",
                    "Before presenting, ask: 'What kind of budget have you set aside for this?'",
                    "Practice pausing 3 seconds after questions - let prospect fill silence"
                ]
                };
            }
        }

        // Display analysis results with beautiful coaching cards
        function displayAnalysisResults(analysis) {
            const container = document.getElementById('conversation-analysis-result');

            // Build tactical scripts sections
            let tacticalScriptsHTML = '';
            if (analysis.tactical_scripts) {
                const scripts = analysis.tactical_scripts;

                tacticalScriptsHTML = `
                    <h3 style="color: var(--brand-gold); font-size: 1.3rem; margin: 30px 0 15px 0;">
                        üìã Your Tactical Playbook
                    </h3>

                    ${scripts.opening_alternatives ? `
                    <div class="coaching-card priority-medium" style="margin-bottom: 15px;">
                        <div class="coaching-title">üéØ Opening Script Alternatives</div>
                        <div class="coaching-content">
                            <ol style="margin-left: 20px;">
                                ${scripts.opening_alternatives.map(script => `<li style="margin-bottom: 10px;"><strong>"${script}"</strong></li>`).join('')}
                            </ol>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.upfront_contract ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üìù Up-Front Contract Script</div>
                        <div class="coaching-content">
                            <p style="font-size: 1.05rem; line-height: 1.6;"><strong>"${scripts.upfront_contract}"</strong></p>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.pain_funnel_sequence ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üíé Pain Funnel Question Sequence</div>
                        <div class="coaching-content">
                            <p style="margin-bottom: 10px; opacity: 0.9;">Ask these questions in order, and after each answer say: "Tell me more about that"</p>
                            <ol style="margin-left: 20px;">
                                ${scripts.pain_funnel_sequence.map(q => `<li style="margin-bottom: 8px;">${q}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.budget_discussion ? `
                    <div class="coaching-card priority-medium" style="margin-bottom: 15px;">
                        <div class="coaching-title">üí∞ Budget Discussion Script</div>
                        <div class="coaching-content">
                            <p style="font-size: 1.05rem; line-height: 1.6;"><strong>"${scripts.budget_discussion}"</strong></p>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.objection_responses ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üõ°Ô∏è Objection Handling Scripts</div>
                        <div class="coaching-content">
                            ${Object.entries(scripts.objection_responses).map(([objection, response]) => `
                                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <p style="color: var(--brand-pink); margin-bottom: 8px;"><strong>When they say:</strong> "${objection}"</p>
                                    <p style="color: var(--brand-teal);"><strong>You respond:</strong> "${response}"</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
            }

            // Build role-play examples
            let rolePlayHTML = '';
            if (analysis.role_play_examples && analysis.role_play_examples.length > 0) {
                rolePlayHTML = `
                    <div class="coaching-card priority-low" style="margin-bottom: 15px;">
                        <div class="coaching-title">üé≠ Role-Play Practice Scenarios</div>
                        <div class="coaching-content">
                            ${analysis.role_play_examples.map((example, i) => `
                                <div style="margin-bottom: 15px; padding: 12px; background: rgba(16, 195, 176, 0.1); border-radius: 8px;">
                                    <strong style="color: var(--brand-aqua);">Scenario ${i + 1}:</strong>
                                    <p style="margin-top: 8px; line-height: 1.6; white-space: pre-line;">${example}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Build next call playbook
            let nextCallHTML = '';
            if (analysis.next_call_playbook && analysis.next_call_playbook.length > 0) {
                nextCallHTML = `
                    <div class="coaching-card priority-high" style="border: 2px solid var(--brand-gold);">
                        <div class="coaching-title">üöÄ Your Next Call Playbook - USE THESE!</div>
                        <div class="coaching-content">
                            <ol style="margin-left: 20px;">
                                ${analysis.next_call_playbook.map(script => `
                                    <li style="margin-bottom: 12px; font-size: 1.05rem; line-height: 1.6;">${script}</li>
                                `).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(16, 195, 176, 0.2), rgba(61, 224, 210, 0.1)); padding: 25px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="color: var(--brand-aqua); font-size: 1.5rem; margin-bottom: 15px;">
                        üéØ Sandler Execution Score: ${analysis.overall_score}/10
                    </h3>

                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.upfront_contract_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.upfront_contract_score}/10
                            </div>
                            <div class="stat-label">Up-Front Contract</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.pain_funnel_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.pain_funnel_score}/10
                            </div>
                            <div class="stat-label">Pain Funnel</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.budget_discussion_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.budget_discussion_score}/10
                            </div>
                            <div class="stat-label">Budget Discussion</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.bonding_rapport_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.bonding_rapport_score}/10
                            </div>
                            <div class="stat-label">Bonding & Rapport</div>
                        </div>
                    </div>

                    <p style="margin-bottom: 20px; opacity: 0.8; font-size: 0.95rem;">
                        <strong>Talk/Listen Ratio:</strong> You talked ${analysis.talk_percentage}% of the time.
                        ${analysis.talk_percentage > 40 ? '‚ö†Ô∏è Target is 30%. Practice asking more questions and listening.' : '‚úÖ Good balance!'}
                    </p>

                    <div class="coaching-card priority-low" style="margin-bottom: 15px;">
                        <div class="coaching-title">‚úÖ What You Did Well</div>
                        <div class="coaching-content">
                            <ul style="margin-left: 20px;">
                                ${analysis.what_went_well.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">‚ö†Ô∏è Areas to Improve</div>
                        <div class="coaching-content">
                            <ul style="margin-left: 20px;">
                                ${analysis.areas_to_improve.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    ${tacticalScriptsHTML}

                    ${rolePlayHTML}

                    ${nextCallHTML}
                </div>
            `;
        }

        // Load conversation history
        async function loadConversationHistory() {
            try {
                const { data, error } = await supabaseClient
                    .from('Conversation_Analyses')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const container = document.getElementById('conversation-history');

                if (data.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7;">No conversations analyzed yet. Upload your first call above!</p>';
                    return;
                }

                container.innerHTML = data.map(conv => `
                    <div class="history-item" style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; align-items: center;">
                        <div style="font-size: 2rem;">${conv.overall_sandler_score >= 8 ? 'üåü' : conv.overall_sandler_score >= 6 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div>
                            <strong style="color: var(--brand-aqua);">${conv.conversation_title}</strong><br>
                            <span style="opacity: 0.7; font-size: 0.85rem;">${conv.conversation_type.replace('_', ' ')} ‚Ä¢ ${conv.date}</span>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${conv.overall_sandler_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-gold)'};">
                                ${conv.overall_sandler_score}/10
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Sandler Score</div>
                        </div>
                        <button class="btn-secondary" style="width: auto; margin: 0; padding: 8px 16px;" onclick="viewConversationDetails('${conv.id}')">
                            View Details
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading conversation history:', error);
                document.getElementById('conversation-history').innerHTML = '<p style="color: var(--brand-pink);">Unable to load conversation history.</p>';
            }
        }

        // View conversation details (placeholder)
        function viewConversationDetails(id) {
            showAlert('Conversation details view coming soon!', 'success');
            // TODO: Implement detailed view with full transcript and analysis
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ============================================
        // INITIALIZE DASHBOARD
        // ============================================

        window.addEventListener('DOMContentLoaded', () => {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                showAlert('‚ö†Ô∏è Please configure Supabase credentials in the code.', 'error');
            } else {
                loadDashboardData();
                loadConversationHistory();
            }
        });
    </script>
</body>
</html>
