<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sandler Performance - The Revenue Factory</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --brand-navy: #0C1030;
            --brand-teal: #10C3B0;
            --brand-aqua: #3DE0D2;
            --brand-pink: #E64563;
            --brand-gold: #F4B03A;
            --light-text: #F2F4F8;
            --card-bg: #131a40;
            --success-green: #10C3B0;
            --warning-yellow: #F9C863;
            --danger-red: #E64563;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--brand-navy) 0%, #050816 100%);
            color: var(--light-text);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .dashboard-header {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 224, 210, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--brand-aqua), var(--brand-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .user-greeting {
            color: var(--brand-gold);
            font-size: 1.1rem;
        }

        .header-nav a {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(61, 224, 210, 0.1);
            border: 1px solid var(--brand-teal);
            color: var(--brand-aqua);
            text-decoration: none;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .header-nav a:hover {
            background: var(--brand-teal);
            color: white;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 224, 210, 0.1);
            margin-bottom: 25px;
        }

        .card h2 {
            color: var(--brand-gold);
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Sandler Scorecard */
        .scorecard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .overall-score {
            text-align: right;
        }

        .overall-score .score {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--brand-aqua);
        }

        .overall-score .grade {
            font-size: 1.2rem;
            color: var(--brand-gold);
        }

        .overall-score .calls-analyzed {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }

        .component-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .component-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .component-name {
            width: 180px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
        }

        .component-bar-container {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .component-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .component-bar.good { background: linear-gradient(90deg, #10C3B0, #3DE0D2); }
        .component-bar.warning { background: linear-gradient(90deg, #F4B03A, #F9C863); }
        .component-bar.bad { background: linear-gradient(90deg, #E64563, #FF6B8A); }

        .component-score {
            width: 50px;
            text-align: right;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .component-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .badge-strength {
            background: rgba(16,195,176,0.2);
            color: var(--success-green);
        }

        .badge-focus {
            background: rgba(230,69,99,0.2);
            color: var(--danger-red);
        }

        /* Daily Practice Card - Prominent */
        .practice-card {
            background: linear-gradient(135deg, rgba(16,195,176,0.1), rgba(61,224,210,0.05));
            border: 2px solid var(--brand-teal);
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .practice-focus {
            background: rgba(230,69,99,0.15);
            color: var(--danger-red);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .practice-intro {
            color: rgba(255,255,255,0.8);
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.5;
        }

        .script-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid var(--brand-gold);
        }

        .script-situation {
            color: var(--brand-gold);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--light-text);
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(61,224,210,0.1);
            border-radius: 10px;
            font-style: italic;
        }

        .script-why {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .script-why strong {
            color: var(--brand-aqua);
        }

        .practice-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .practice-btn {
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .practice-btn.primary {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            color: white;
        }

        .practice-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--brand-aqua);
            border: 1px solid var(--brand-teal);
        }

        .practice-btn:hover {
            transform: translateY(-2px);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .component-name { width: 140px; font-size: 0.8rem; }
        }

        /* Coaching Messages */
        .coaching-message {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--brand-teal);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .coaching-message:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .coaching-message.unread {
            border-left-color: var(--brand-gold);
            background: rgba(244, 176, 58, 0.05);
        }

        .coaching-message .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .coaching-message .from {
            color: var(--brand-aqua);
            font-weight: 600;
        }

        .coaching-message .date {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        .coaching-message .preview {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .unread-badge {
            background: var(--brand-gold);
            color: var(--brand-navy);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Call Cards with Scores */
        .call-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .call-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .call-info .call-date {
            color: var(--brand-aqua);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .call-info .call-meta {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            margin-top: 3px;
        }

        .call-score-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .call-score-badge.good {
            background: rgba(16,195,176,0.2);
            color: var(--success-green);
        }

        .call-score-badge.warning {
            background: rgba(244,176,58,0.2);
            color: var(--warning-yellow);
        }

        .call-score-badge.bad {
            background: rgba(230,69,99,0.2);
            color: var(--danger-red);
        }

        .call-feedback {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }

        .call-feedback .strength {
            color: var(--success-green);
            font-size: 0.85rem;
        }

        .call-feedback .improve {
            color: var(--warning-yellow);
            font-size: 0.85rem;
        }

        .call-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .call-action-btn {
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .call-action-btn.view {
            background: rgba(59,130,246,0.2);
            color: #60A5FA;
        }

        .call-action-btn.play {
            background: rgba(147,51,234,0.2);
            color: #A78BFA;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid var(--brand-teal);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: white;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-body .coaching-full {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: rgba(255, 255, 255, 0.9);
        }

        .reply-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reply-section h3 {
            color: var(--brand-gold);
            margin-bottom: 15px;
        }

        .reply-section textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            color: var(--light-text);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .reply-section textarea:focus {
            outline: none;
            border-color: var(--brand-teal);
        }

        .reply-section .btn {
            margin-top: 15px;
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            border: none;
            color: white;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reply-section .btn:hover {
            transform: translateY(-2px);
        }

        /* No calls state */
        .no-data-card {
            text-align: center;
            padding: 30px;
            color: rgba(255,255,255,0.6);
        }

        .no-data-card .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Team Accomplishments */
        .team-card {
            background: linear-gradient(135deg, rgba(244,176,58,0.1), rgba(244,176,58,0.02));
            border: 1px solid rgba(244,176,58,0.3);
        }

        .team-stats-grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .team-stat {
            text-align: center;
            padding: 15px 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            min-width: 120px;
        }

        .team-stat.highlight {
            background: rgba(16,195,176,0.15);
            border: 1px solid rgba(16,195,176,0.3);
        }

        .team-stat .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--brand-aqua);
            margin-bottom: 5px;
        }

        .team-stat.highlight .stat-value {
            color: var(--success-green);
        }

        .team-stat .stat-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        /* Personal Achievements/Badges */
        .achievements-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .achievements-section h3 {
            color: var(--brand-gold);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .badges-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .achievement-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            transition: all 0.2s ease;
        }

        .achievement-badge.earned {
            background: rgba(244,176,58,0.15);
            border-color: var(--brand-gold);
            color: var(--brand-gold);
        }

        .achievement-badge.earned .badge-icon {
            transform: scale(1.1);
        }

        .achievement-badge .badge-icon {
            font-size: 1.2rem;
        }

        .achievement-badge .badge-text {
            font-weight: 600;
        }

        .achievement-badge.locked {
            opacity: 0.5;
        }

        /* Script search input focus */
        #script-search-input:focus {
            outline: none;
            border-color: var(--brand-teal);
            background: rgba(255,255,255,0.08);
        }

        #script-search-input::placeholder {
            color: rgba(255,255,255,0.4);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1>My Sandler Performance</h1>
                    <p class="user-greeting" id="user-greeting">Welcome back!</p>
                </div>
                <div class="header-nav">
                    <a href="manager-performance-dashboard.html">Team View</a>
                </div>
            </div>
        </div>

        <!-- Sandler Scorecard -->
        <div class="card" id="scorecard-section">
            <div class="scorecard-header">
                <h2>Your Sandler Scorecard</h2>
                <div class="overall-score">
                    <div class="score" id="overall-score">--</div>
                    <div class="grade" id="overall-grade">No calls analyzed</div>
                    <div class="calls-analyzed" id="calls-analyzed"></div>
                </div>
            </div>
            <div class="component-list" id="component-list">
                <!-- Components will be rendered here -->
            </div>

            <!-- Personal Achievements -->
            <div class="achievements-section">
                <h3>Your Achievements</h3>
                <div class="badges-row" id="achievements-badges">
                    <!-- Badges will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Team Accomplishments -->
        <div class="card team-card">
            <h2>Team Wins This Week</h2>
            <div class="team-stats-grid" id="team-accomplishments">
                <div class="team-stat">
                    <div class="stat-label">Loading team stats...</div>
                </div>
            </div>
        </div>

        <!-- Daily Practice Card -->
        <div class="card practice-card" id="practice-section">
            <div class="practice-header">
                <h2>Today's Practice</h2>
                <span class="practice-focus" id="practice-focus">Loading...</span>
            </div>
            <p class="practice-intro" id="practice-intro">Loading your personalized practice script...</p>
            <div class="script-card" id="script-card">
                <div class="script-situation" id="script-situation">SITUATION</div>
                <div class="script-text" id="script-text">"Loading..."</div>
                <div class="script-why" id="script-why"><strong>Why it works:</strong> Loading...</div>
            </div>
            <div class="practice-actions">
                <button class="practice-btn secondary" onclick="showAnotherScript()">Show Another Script</button>
                <button class="practice-btn primary" onclick="markPracticed()">I'll Try This Today</button>
            </div>
            <div class="script-search" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="script-search-input" placeholder="Search scripts... e.g., 'handling budget objections'"
                        style="flex: 1; padding: 12px 16px; border-radius: 20px; border: 1px solid rgba(61,224,210,0.3); background: rgba(255,255,255,0.05); color: var(--light-text); font-size: 14px;">
                    <button class="practice-btn secondary" onclick="searchScripts()" id="search-scripts-btn">Search</button>
                </div>
                <div id="search-results" style="margin-top: 15px; display: none;"></div>
            </div>
        </div>

        <!-- Bottom Grid -->
        <div class="main-grid">
            <!-- Coaching Messages -->
            <div class="card">
                <h2>
                    Coaching from Manager
                    <span class="unread-badge" id="unread-count" style="display: none;">0</span>
                </h2>
                <div id="coaching-messages-list">
                    <div class="empty-state">
                        <div class="icon">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Recent Calls with Scores -->
            <div class="card">
                <h2>Your Recent Calls</h2>
                <div id="recent-calls-list">
                    <div class="empty-state">
                        <div class="icon">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coaching Detail Modal -->
    <div class="modal" id="coaching-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Coaching Feedback</h2>
                <button class="modal-close" onclick="closeModal()">x</button>
            </div>
            <div class="modal-body">
                <div class="coaching-full" id="coaching-full-content"></div>
                <div class="reply-section" id="reply-section">
                    <h3>Reply to Your Manager</h3>
                    <textarea id="reply-text" placeholder="Type your questions, feedback, or acknowledgment here..."></textarea>
                    <button class="btn" onclick="sendReply()">Send Reply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Analysis Modal -->
    <div class="modal" id="call-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Call Analysis</h2>
                <button class="modal-close" onclick="closeCallModal()">x</button>
            </div>
            <div class="modal-body" id="call-analysis-content">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        const SUPABASE_URL = 'https://qwqlsbccwnwrdpcaccjz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3cWxzYmNjd253cmRwY2FjY2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTA1MDQsImV4cCI6MjA4MDg4NjUwNH0.yWzSV2Nid_T1XiDE0RrskFob9mRUc-m6MbeIiT7huC4';

        // Get user email from URL or default
        const urlParams = new URLSearchParams(window.location.search);
        const USER_EMAIL = urlParams.get('email') || 'sarah.johnson@company.com';
        const USER_NAME = USER_EMAIL.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        let currentCoachingId = null;
        let currentCallId = null;
        let userScores = null;
        let currentScriptIndex = 0;
        let ragScripts = [];  // RAG-powered scripts
        let useRAG = true;    // Toggle for RAG vs fallback

        // ============================================
        // SANDLER COMPONENTS & SCRIPTS LIBRARY
        // ============================================

        const SANDLER_COMPONENTS = {
            'Bonding & Rapport': {
                weight: 0.10,
                scripts: [
                    {
                        situation: "Opening a cold call",
                        script: "Hi [Name], I'm not sure if we should even be talking, but I came across [specific thing] and got curious...",
                        whyItWorks: "Disarms the prospect by removing pressure. Shows you're not desperate and did research."
                    },
                    {
                        situation: "Building genuine connection",
                        script: "Before we dive in, I'm curious - how did you end up in [their role]?",
                        whyItWorks: "Shows genuine interest in them as a person, not just a deal. People love talking about their journey."
                    },
                    {
                        situation: "When prospect seems guarded",
                        script: "I get the sense you've been through this before... Would it help if I shared what typically goes wrong in these conversations?",
                        whyItWorks: "Acknowledges their experience, offers transparency, builds trust through honesty."
                    }
                ]
            },
            'Upfront Contract': {
                weight: 0.15,
                scripts: [
                    {
                        situation: "Starting a discovery call",
                        script: "I have us down for 30 minutes. My goal is to understand your situation - yours might be to figure out if we can help. At the end, it's totally okay to say 'this isn't for us.' Fair?",
                        whyItWorks: "Sets clear expectations, gives permission to say no, removes pressure from both sides."
                    },
                    {
                        situation: "Prospect tries to rush",
                        script: "I want to respect your time. Can we agree that if this doesn't make sense for you, you'll tell me directly? I'd rather know now than chase you for weeks.",
                        whyItWorks: "Shows respect for their time, establishes honest communication, filters out bad fits early."
                    },
                    {
                        situation: "Before a demo",
                        script: "Before I show you anything, let's agree: if you see something that won't work for you, interrupt me. And if it does look right, we'll talk about what happens next. Deal?",
                        whyItWorks: "Prevents 'think it over' objections, gets commitment to honest feedback upfront."
                    }
                ]
            },
            'Pain Funnel': {
                weight: 0.25,
                scripts: [
                    {
                        situation: "Surface-level problem mentioned",
                        script: "Tell me more about that... How long has this been going on? And what have you tried so far?",
                        whyItWorks: "Opens the pain funnel without being pushy. The pause after 'tell me more' creates space for them to share."
                    },
                    {
                        situation: "Going deeper on pain",
                        script: "If you had to put a number on this - what is this costing you? Not just in dollars, but time, stress, opportunities missed?",
                        whyItWorks: "Quantifies pain in multiple dimensions, makes the problem concrete and urgent."
                    },
                    {
                        situation: "Reaching emotional impact",
                        script: "How is this affecting you personally? Beyond the business impact - what does this mean for your role?",
                        whyItWorks: "Connects to personal stakes, creates emotional urgency, differentiates from other vendors."
                    },
                    {
                        situation: "Finding the 'do nothing' cost",
                        script: "What happens if you don't solve this? Not just next quarter, but a year from now?",
                        whyItWorks: "Makes inaction painful, creates urgency without being pushy, helps them sell internally."
                    }
                ]
            },
            'Budget Step': {
                weight: 0.15,
                scripts: [
                    {
                        situation: "Opening budget conversation",
                        script: "Before I show you anything, let's talk about money so neither of us wastes time. Is that okay?",
                        whyItWorks: "Frames budget as mutual respect, not money-grabbing. Gets permission to discuss openly."
                    },
                    {
                        situation: "Direct budget question",
                        script: "What kind of investment have you set aside to solve this problem?",
                        whyItWorks: "Direct without being aggressive. Assumes they have budget, puts ball in their court."
                    },
                    {
                        situation: "When they say 'no budget'",
                        script: "Let me ask it differently - if this solved [their pain], what would that be worth to you? What would you pay to make this problem go away?",
                        whyItWorks: "Reframes from expense to value. Helps them think about ROI rather than cost."
                    }
                ]
            },
            'Decision Step': {
                weight: 0.15,
                scripts: [
                    {
                        situation: "Understanding decision process",
                        script: "Walk me through how a decision like this typically gets made at [company]. Who else would need to be involved?",
                        whyItWorks: "Non-threatening way to uncover stakeholders. 'Typically' removes pressure."
                    },
                    {
                        situation: "Identifying hidden influencers",
                        script: "When you bring this to [other stakeholder], what questions do you think they'll have?",
                        whyItWorks: "Positions you as a partner helping them sell internally, surfaces objections early."
                    },
                    {
                        situation: "Getting timeline clarity",
                        script: "If we were to move forward, what would need to happen between now and a signed agreement?",
                        whyItWorks: "Maps out the full process, identifies potential blockers, creates shared timeline."
                    }
                ]
            },
            'Fulfillment': {
                weight: 0.10,
                scripts: [
                    {
                        situation: "Before presenting solution",
                        script: "Based on what you've told me about [specific pain], let me show you exactly how we address that - and nothing else.",
                        whyItWorks: "Shows you listened, prevents feature dumping, keeps focus on their specific needs."
                    },
                    {
                        situation: "During demo",
                        script: "I'm going to skip the features that don't apply to your situation. Stop me if I miss something you wanted to see.",
                        whyItWorks: "Respects their time, shows confidence, gives them control."
                    }
                ]
            },
            'Post-Sell': {
                weight: 0.05,
                scripts: [
                    {
                        situation: "After verbal commitment",
                        script: "Now that we've agreed to move forward - what could go wrong between now and getting started?",
                        whyItWorks: "Surfaces buyer's remorse before it happens, shows you care about successful implementation."
                    },
                    {
                        situation: "Setting next steps",
                        script: "Let's get specific about next steps so this doesn't get lost. What's the one thing that needs to happen by [date]?",
                        whyItWorks: "Creates accountability, prevents deals from stalling, focuses on single action."
                    }
                ]
            },
            'No Free Consulting': {
                weight: 0.05,
                scripts: [
                    {
                        situation: "Asked for detailed recommendations",
                        script: "I could give you some ideas on that, but honestly, without fully understanding your situation, I'd just be guessing. How about we do this properly once we're working together?",
                        whyItWorks: "Protects your expertise, creates value for partnership, maintains professional boundaries."
                    },
                    {
                        situation: "Prospect wants free audit/analysis",
                        script: "We do offer that kind of deep-dive - it's actually part of our onboarding. That way, you get real recommendations backed by data, not guesses.",
                        whyItWorks: "Reframes 'free' as 'partial', positions paid engagement as higher value."
                    }
                ]
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-greeting').textContent = `Welcome back, ${USER_NAME}!`;

            loadSandlerScores();
            loadCoachingMessages();
            loadRecentCalls();
        });

        // ============================================
        // SANDLER SCORECARD
        // ============================================

        async function loadSandlerScores() {
            try {
                // Fetch calls with methodology scores for this user
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Synced_Conversations?rep_email=eq.${encodeURIComponent(USER_EMAIL)}&order=call_date.desc&limit=30`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to fetch');

                const calls = await response.json();

                // Filter to calls with scores
                const scoredCalls = calls.filter(c =>
                    c.methodology_scores &&
                    c.methodology_scores.overall !== undefined &&
                    Array.isArray(c.methodology_scores.components)
                );

                if (scoredCalls.length === 0) {
                    renderNoScoresState();
                    renderDefaultPractice();
                    renderAchievements(calls); // Still check for any achievements
                    return;
                }

                // Aggregate scores across calls
                const componentScores = {};
                Object.keys(SANDLER_COMPONENTS).forEach(name => {
                    componentScores[name] = { total: 0, count: 0 };
                });

                scoredCalls.forEach(call => {
                    call.methodology_scores.components.forEach(comp => {
                        if (componentScores[comp.name]) {
                            componentScores[comp.name].total += comp.score;
                            componentScores[comp.name].count += 1;
                        }
                    });
                });

                // Calculate averages
                userScores = Object.keys(componentScores).map(name => ({
                    name,
                    score: componentScores[name].count > 0
                        ? Math.round((componentScores[name].total / componentScores[name].count) * 10) / 10
                        : null
                })).filter(s => s.score !== null);

                // Calculate overall
                const overall = userScores.reduce((sum, s) => sum + s.score, 0) / userScores.length;
                const grade = getGrade(overall);

                // Update UI
                document.getElementById('overall-score').textContent = overall.toFixed(1);
                document.getElementById('overall-grade').textContent = grade;
                document.getElementById('calls-analyzed').textContent = `Based on ${scoredCalls.length} analyzed calls`;

                renderComponentBars(userScores);
                renderDailyPractice(userScores);
                renderAchievements(calls); // Pass all calls for badge checking

            } catch (error) {
                console.error('Error loading scores:', error);
                renderNoScoresState();
                renderDefaultPractice();
                renderAchievements([]); // Show locked badges
            }
        }

        function getGrade(score) {
            if (score >= 9.5) return 'A+';
            if (score >= 9.0) return 'A';
            if (score >= 8.5) return 'A-';
            if (score >= 8.0) return 'B+';
            if (score >= 7.5) return 'B';
            if (score >= 7.0) return 'B-';
            if (score >= 6.5) return 'C+';
            if (score >= 6.0) return 'C';
            if (score >= 5.5) return 'C-';
            if (score >= 5.0) return 'D';
            return 'F';
        }

        function renderNoScoresState() {
            document.getElementById('overall-score').textContent = '--';
            document.getElementById('overall-grade').textContent = 'No calls analyzed yet';
            document.getElementById('calls-analyzed').textContent = 'Analyze your calls to see your Sandler scores';

            const list = document.getElementById('component-list');
            list.innerHTML = `
                <div class="no-data-card">
                    <div class="icon">ðŸ“Š</div>
                    <p>No Sandler scores yet.</p>
                    <p style="font-size: 13px; margin-top: 10px;">Your manager will analyze your calls to generate scores.</p>
                </div>
            `;
        }

        function renderComponentBars(scores) {
            const list = document.getElementById('component-list');

            // Sort to find strengths and weaknesses
            const sorted = [...scores].sort((a, b) => a.score - b.score);
            const weakest = sorted[0]?.name;
            const strongest = sorted[sorted.length - 1]?.name;

            list.innerHTML = scores.map(comp => {
                const pct = (comp.score / 10) * 100;
                const colorClass = comp.score >= 8 ? 'good' : comp.score >= 6 ? 'warning' : 'bad';
                const scoreColor = comp.score >= 8 ? '#10C3B0' : comp.score >= 6 ? '#F4B03A' : '#E64563';

                let badge = '';
                if (comp.name === strongest && comp.score >= 7) {
                    badge = '<span class="component-badge badge-strength">Strength</span>';
                } else if (comp.name === weakest && comp.score < 7) {
                    badge = '<span class="component-badge badge-focus">Focus Area</span>';
                }

                return `
                    <div class="component-row">
                        <div class="component-name">${comp.name}${badge}</div>
                        <div class="component-bar-container">
                            <div class="component-bar ${colorClass}" style="width: ${pct}%"></div>
                        </div>
                        <div class="component-score" style="color: ${scoreColor}">${comp.score.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // DAILY PRACTICE (RAG-Enhanced)
        // ============================================

        async function renderDailyPractice(scores) {
            // Find weakest component
            const sorted = [...scores].sort((a, b) => a.score - b.score);
            const weakest = sorted[0];

            if (!weakest) {
                renderDefaultPractice();
                return;
            }

            document.getElementById('practice-focus').textContent = weakest.name;
            document.getElementById('practice-intro').textContent =
                `Your ${weakest.name} score is ${weakest.score.toFixed(1)}/10. Practice this script on your next call:`;

            // Try to fetch RAG-powered scripts first
            if (useRAG) {
                try {
                    ragScripts = await fetchRAGScripts(weakest.name);
                    if (ragScripts.length > 0) {
                        currentScriptIndex = 0;
                        showRAGScript(currentScriptIndex);
                        return;
                    }
                } catch (error) {
                    console.warn('RAG fetch failed, falling back to hardcoded scripts:', error);
                }
            }

            // Fallback to hardcoded scripts
            if (!SANDLER_COMPONENTS[weakest.name]) {
                renderDefaultPractice();
                return;
            }

            const component = SANDLER_COMPONENTS[weakest.name];
            const scripts = component.scripts;

            // Use date seed for consistent daily rotation
            const dayOfYear = Math.floor(Date.now() / 86400000);
            currentScriptIndex = dayOfYear % scripts.length;

            showScript(weakest.name, currentScriptIndex);
        }

        /**
         * Fetch practice scripts from RAG system
         */
        async function fetchRAGScripts(weakComponent) {
            const componentKey = weakComponent.toUpperCase().replace(/\s+/g, '_').replace('&', '');

            const response = await fetch(
                `${SUPABASE_URL}/functions/v1/rag-search`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'scripts_for_weakness',
                        component: componentKey,
                        limit: 5
                    })
                }
            );

            if (!response.ok) {
                throw new Error('RAG search failed');
            }

            const data = await response.json();
            return data.scripts || [];
        }

        /**
         * Display a RAG-retrieved script
         */
        function showRAGScript(index) {
            if (!ragScripts || ragScripts.length === 0) return;

            const script = ragScripts[index % ragScripts.length];

            // Parse the chunk_text which contains SITUATION, SCRIPT, WHY IT WORKS
            const text = script.chunk_text || '';
            const situationMatch = text.match(/SITUATION:\s*(.+?)(?=\n|SCRIPT:|$)/is);
            const scriptMatch = text.match(/SCRIPT:\s*"?(.+?)"?(?=\n\n|WHY IT WORKS:|$)/is);
            const whyMatch = text.match(/WHY IT WORKS:\s*(.+?)$/is);

            const situation = situationMatch ? situationMatch[1].trim() : script.chunk_title || 'Practice Scenario';
            const scriptText = scriptMatch ? scriptMatch[1].trim() : text;
            const whyItWorks = whyMatch ? whyMatch[1].trim() : 'Proven Sandler technique for this situation.';

            document.getElementById('script-situation').textContent = `SITUATION: ${situation}`;
            document.getElementById('script-text').textContent = `"${scriptText}"`;
            document.getElementById('script-why').innerHTML = `<strong>Why it works:</strong> ${whyItWorks}`;

            // Add RAG badge
            const practiceCard = document.getElementById('practice-section');
            if (!practiceCard.querySelector('.rag-badge')) {
                const badge = document.createElement('span');
                badge.className = 'rag-badge';
                badge.style.cssText = 'background: rgba(16,195,176,0.2); color: #10C3B0; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;';
                badge.textContent = 'AI-Powered';
                document.getElementById('practice-focus').parentNode.appendChild(badge);
            }
        }

        function renderDefaultPractice() {
            // Show a default practice script for new users
            document.getElementById('practice-focus').textContent = 'Pain Funnel';
            document.getElementById('practice-intro').textContent =
                'The Pain Funnel is the heart of Sandler. Practice this script on your next call:';

            showScript('Pain Funnel', 0);
        }

        function showScript(componentName, index) {
            const component = SANDLER_COMPONENTS[componentName];
            if (!component) return;

            const script = component.scripts[index % component.scripts.length];

            document.getElementById('script-situation').textContent = `SITUATION: ${script.situation}`;
            document.getElementById('script-text').textContent = `"${script.script}"`;
            document.getElementById('script-why').innerHTML = `<strong>Why it works:</strong> ${script.whyItWorks}`;
        }

        function showAnotherScript() {
            // Small animation feedback
            const card = document.getElementById('script-card');
            card.style.transform = 'scale(0.98)';
            setTimeout(() => card.style.transform = 'scale(1)', 100);

            // Check if we have RAG scripts
            if (ragScripts && ragScripts.length > 0) {
                currentScriptIndex = (currentScriptIndex + 1) % ragScripts.length;
                showRAGScript(currentScriptIndex);
                return;
            }

            // Fallback to hardcoded scripts
            const focusArea = document.getElementById('practice-focus').textContent;
            const component = SANDLER_COMPONENTS[focusArea];
            if (!component) return;

            currentScriptIndex = (currentScriptIndex + 1) % component.scripts.length;
            showScript(focusArea, currentScriptIndex);
        }

        function markPracticed() {
            confetti({ particleCount: 50, spread: 60 });

            const btn = event.target;
            btn.textContent = 'Great! Go crush it!';
            btn.style.background = 'linear-gradient(135deg, #10C3B0, #3DE0D2)';
            setTimeout(() => {
                btn.textContent = "I'll Try This Today";
                btn.style.background = '';
            }, 2000);
        }

        /**
         * Search for scripts using RAG semantic search
         */
        async function searchScripts() {
            const searchInput = document.getElementById('script-search-input');
            const searchBtn = document.getElementById('search-scripts-btn');
            const resultsDiv = document.getElementById('search-results');
            const query = searchInput.value.trim();

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            searchBtn.textContent = 'Searching...';
            searchBtn.disabled = true;
            resultsDiv.style.display = 'none';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/rag-search`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            action: 'search',
                            query: query,
                            contentTypes: ['script', 'component'],
                            matchCount: 5,
                            matchThreshold: 0.4
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                const results = data.results || [];

                if (results.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">
                            No scripts found for "${query}". Try different keywords.
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: var(--brand-gold); font-size: 0.9rem; margin-bottom: 12px;">
                            Found ${results.length} relevant scripts:
                        </div>
                        ${results.map((r, i) => {
                            const text = r.chunk_text || '';
                            const scriptMatch = text.match(/SCRIPT:\s*"?(.+?)"?(?=\n\n|WHY IT WORKS:|$)/is);
                            const preview = scriptMatch ? scriptMatch[1].substring(0, 150) : text.substring(0, 150);

                            return `
                                <div class="search-result-card" style="background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid var(--brand-teal); transition: all 0.2s ease;"
                                     onclick="useSearchResult(${i})"
                                     onmouseover="this.style.background='rgba(255,255,255,0.06)'"
                                     onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                                    <div style="color: var(--brand-aqua); font-weight: 600; margin-bottom: 5px;">
                                        ${r.chunk_title}
                                        <span style="color: rgba(255,255,255,0.4); font-size: 0.8rem; margin-left: 8px;">${Math.round(r.similarity * 100)}% match</span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem; font-style: italic;">
                                        "${preview}..."
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    `;

                    // Store results for selection
                    window.searchResults = results;
                }

                resultsDiv.style.display = 'block';

            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div style="color: var(--danger-red); padding: 15px;">
                        Search failed. RAG system may not be available yet.
                    </div>
                `;
                resultsDiv.style.display = 'block';
            } finally {
                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            }
        }

        /**
         * Use a search result as the current practice script
         */
        function useSearchResult(index) {
            if (!window.searchResults || !window.searchResults[index]) return;

            const result = window.searchResults[index];
            const text = result.chunk_text || '';

            // Parse the chunk_text
            const situationMatch = text.match(/SITUATION:\s*(.+?)(?=\n|SCRIPT:|$)/is);
            const scriptMatch = text.match(/SCRIPT:\s*"?(.+?)"?(?=\n\n|WHY IT WORKS:|$)/is);
            const whyMatch = text.match(/WHY IT WORKS:\s*(.+?)$/is);

            const situation = situationMatch ? situationMatch[1].trim() : result.chunk_title || 'Practice Scenario';
            const scriptText = scriptMatch ? scriptMatch[1].trim() : text;
            const whyItWorks = whyMatch ? whyMatch[1].trim() : 'Proven Sandler technique.';

            // Update the main practice card
            document.getElementById('script-situation').textContent = `SITUATION: ${situation}`;
            document.getElementById('script-text').textContent = `"${scriptText}"`;
            document.getElementById('script-why').innerHTML = `<strong>Why it works:</strong> ${whyItWorks}`;

            // Update focus area if we have component info
            if (result.component_name) {
                const displayName = result.component_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('practice-focus').textContent = displayName;
            }

            // Scroll to practice card
            document.getElementById('practice-section').scrollIntoView({ behavior: 'smooth' });

            // Clear search
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('script-search-input').value = '';

            // Celebration
            confetti({ particleCount: 30, spread: 40, origin: { y: 0.6 } });
        }

        // Handle Enter key in search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('script-search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchScripts();
                    }
                });
            }
        });

        // ============================================
        // COACHING MESSAGES
        // ============================================

        async function loadCoachingMessages() {
            const list = document.getElementById('coaching-messages-list');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Coaching_Messages?rep_email=eq.${encodeURIComponent(USER_EMAIL)}&status=eq.sent&order=sent_at.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to fetch');

                const messages = await response.json();

                if (messages.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ðŸ“­</div>
                            <p>No coaching messages yet.</p>
                            <p style="font-size: 13px; margin-top: 10px;">Your manager will send feedback here.</p>
                        </div>
                    `;
                } else {
                    const unreadCount = messages.filter(m => !m.read_at).length;
                    const unreadBadge = document.getElementById('unread-count');
                    if (unreadCount > 0) {
                        unreadBadge.textContent = unreadCount;
                        unreadBadge.style.display = 'inline-block';
                    }

                    list.innerHTML = messages.map(msg => {
                        const isUnread = !msg.read_at;
                        const date = new Date(msg.sent_at).toLocaleDateString();
                        const managerName = msg.manager_email?.split('@')[0] || 'Manager';
                        return `
                            <div class="coaching-message ${isUnread ? 'unread' : ''}" onclick="openCoaching('${msg.id}')">
                                <div class="header">
                                    <span class="from">${managerName}</span>
                                    <span class="date">${date}${isUnread ? '<span class="unread-badge">NEW</span>' : ''}</span>
                                </div>
                                <div class="preview">${(msg.message_body || msg.coaching_content || '').substring(0, 100)}...</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading coaching:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ðŸ“­</div>
                        <p>No coaching messages yet.</p>
                    </div>
                `;
            }
        }

        async function openCoaching(messageId) {
            currentCoachingId = messageId;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Coaching_Messages?id=eq.${messageId}`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                const [message] = await response.json();
                if (!message) return;

                document.getElementById('coaching-full-content').textContent = message.message_body || message.coaching_content || '';

                // Mark as read
                if (!message.read_at) {
                    await fetch(
                        `${SUPABASE_URL}/rest/v1/Coaching_Messages?id=eq.${messageId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ read_at: new Date().toISOString() })
                        }
                    );
                    loadCoachingMessages();
                }

                // Show/hide reply section
                const replySection = document.getElementById('reply-section');
                if (message.rep_response) {
                    replySection.innerHTML = `
                        <h3>Your Reply</h3>
                        <div style="background: rgba(16,195,176,0.1); padding: 15px; border-radius: 10px; border-left: 3px solid var(--brand-teal);">
                            ${message.rep_response}
                        </div>
                        <p style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 10px;">Sent ${new Date(message.responded_at).toLocaleDateString()}</p>
                    `;
                } else {
                    replySection.innerHTML = `
                        <h3>Reply to Your Manager</h3>
                        <textarea id="reply-text" placeholder="Questions? Feedback? Let your manager know..."></textarea>
                        <button class="btn" onclick="sendReply()">Send Reply</button>
                    `;
                }

                document.getElementById('coaching-modal').classList.add('active');

            } catch (error) {
                console.error('Error opening coaching:', error);
            }
        }

        async function sendReply() {
            const replyText = document.getElementById('reply-text').value.trim();
            if (!replyText || !currentCoachingId) {
                alert('Please enter a reply');
                return;
            }

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Coaching_Messages?id=eq.${currentCoachingId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            rep_response: replyText,
                            responded_at: new Date().toISOString(),
                            status: 'replied'
                        })
                    }
                );

                if (!response.ok) throw new Error('Failed to send reply');

                confetti({ particleCount: 100, spread: 70 });
                alert('Reply sent to your manager!');
                closeModal();
                loadCoachingMessages();

            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Failed to send reply');
            }
        }

        function closeModal() {
            document.getElementById('coaching-modal').classList.remove('active');
            currentCoachingId = null;
        }

        // ============================================
        // RECENT CALLS
        // ============================================

        async function loadRecentCalls() {
            const list = document.getElementById('recent-calls-list');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Synced_Conversations?rep_email=eq.${encodeURIComponent(USER_EMAIL)}&order=call_date.desc&limit=5`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to fetch');

                const calls = await response.json();

                if (calls.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ðŸ“ž</div>
                            <p>No recorded calls yet.</p>
                            <p style="font-size: 13px; margin-top: 10px;">Calls from Fathom/Aircall will appear here.</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = calls.map(call => renderCallCard(call)).join('');
                }
            } catch (error) {
                console.error('Error loading calls:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ðŸ“ž</div>
                        <p>Could not load calls.</p>
                    </div>
                `;
            }
        }

        function renderCallCard(call) {
            const date = new Date(call.call_date).toLocaleDateString();
            const time = new Date(call.call_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const duration = call.duration_minutes ? `${call.duration_minutes} min` : '';
            const sourceIcon = call.source_provider === 'fathom' ? 'ðŸŽ¥' : 'ðŸ“ž';

            // Check for Sandler scores
            const hasScore = call.methodology_scores &&
                             call.methodology_scores.overall !== undefined &&
                             Array.isArray(call.methodology_scores.components);

            let scoreBadge = '';
            let feedback = '';

            if (hasScore) {
                const score = call.methodology_scores.overall;
                const colorClass = score >= 8 ? 'good' : score >= 6 ? 'warning' : 'bad';
                scoreBadge = `<div class="call-score-badge ${colorClass}">${score}/10</div>`;

                // Find strength and area to improve
                const components = call.methodology_scores.components;
                const sorted = [...components].sort((a, b) => b.score - a.score);
                const strength = sorted[0];
                const improve = sorted[sorted.length - 1];

                if (strength && improve) {
                    feedback = `
                        <div class="call-feedback">
                            <div class="strength">âœ… Strong: ${strength.name}</div>
                            <div class="improve">âš ï¸ Work on: ${improve.name}</div>
                        </div>
                    `;
                }
            }

            return `
                <div class="call-card">
                    <div class="call-card-header">
                        <div class="call-info">
                            <div class="call-date">${sourceIcon} ${date} at ${time}</div>
                            <div class="call-meta">${duration}${call.participants?.length ? ` â€¢ ${call.participants.length} participants` : ''}</div>
                        </div>
                        ${scoreBadge}
                    </div>
                    ${feedback}
                    <div class="call-actions">
                        ${hasScore ? `
                            <button class="call-action-btn view" onclick="viewCallAnalysis('${call.id}')">View Analysis</button>
                        ` : `
                            <button class="call-action-btn" style="background: rgba(59,130,246,0.2); color: #60A5FA;" onclick="selfAnalyzeCall('${call.id}')">Analyze My Call</button>
                        `}
                        ${call.recording_url ? `<a href="${call.recording_url}" target="_blank" class="call-action-btn play">Replay</a>` : ''}
                    </div>
                    ${!hasScore && call.ai_summary ? `
                        <div style="margin-top: 8px; color: rgba(255,255,255,0.6); font-size: 13px;">${call.ai_summary.substring(0, 80)}...</div>
                    ` : ''}
                </div>
            `;
        }

        async function viewCallAnalysis(callId) {
            currentCallId = callId;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Synced_Conversations?id=eq.${callId}`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                const [call] = await response.json();
                if (!call || !call.methodology_scores) return;

                const scores = call.methodology_scores;
                const date = new Date(call.call_date).toLocaleDateString();

                const content = document.getElementById('call-analysis-content');
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 3rem; font-weight: 700; color: ${scores.overall >= 8 ? '#10C3B0' : scores.overall >= 6 ? '#F4B03A' : '#E64563'};">
                            ${scores.overall}/10
                        </div>
                        <div style="color: var(--brand-gold); font-size: 1.2rem;">Grade: ${scores.grade || getGrade(scores.overall)}</div>
                        <div style="color: rgba(255,255,255,0.5); margin-top: 5px;">${date}</div>
                    </div>

                    <h3 style="color: var(--brand-aqua); margin-bottom: 15px;">Component Breakdown</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px;">
                        ${scores.components.map(comp => {
                            const pct = (comp.score / 10) * 100;
                            const color = comp.score >= 8 ? '#10C3B0' : comp.score >= 6 ? '#F4B03A' : '#E64563';
                            return `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 150px; font-size: 0.9rem;">${comp.name}</div>
                                    <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                                        <div style="height: 100%; width: ${pct}%; background: ${color}; border-radius: 10px;"></div>
                                    </div>
                                    <div style="width: 40px; text-align: right; color: ${color}; font-weight: 600;">${comp.score}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    ${call.ai_summary ? `
                        <h3 style="color: var(--brand-gold); margin-bottom: 10px;">AI Summary</h3>
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; color: rgba(255,255,255,0.8); line-height: 1.6;">
                            ${call.ai_summary}
                        </div>
                    ` : ''}
                `;

                document.getElementById('call-modal').classList.add('active');

            } catch (error) {
                console.error('Error loading call analysis:', error);
            }
        }

        function closeCallModal() {
            document.getElementById('call-modal').classList.remove('active');
            currentCallId = null;
        }

        // ============================================
        // SELF-ANALYSIS
        // ============================================

        async function selfAnalyzeCall(callId) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Analyzing...';
            btn.disabled = true;

            try {
                // Call the analyze-call Edge Function
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/analyze-call`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({ call_id: callId })
                    }
                );

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Analysis failed');
                }

                confetti({ particleCount: 80, spread: 60 });

                // Reload everything to show new scores
                loadSandlerScores();
                loadRecentCalls();

                // Show the analysis
                setTimeout(() => viewCallAnalysis(callId), 500);

            } catch (error) {
                console.error('Error analyzing call:', error);
                alert('Analysis failed: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ============================================
        // TEAM ACCOMPLISHMENTS
        // ============================================

        async function loadTeamAccomplishments() {
            const container = document.getElementById('team-accomplishments');
            if (!container) return;

            try {
                // Get team stats from Synced_Conversations (last 7 days)
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Synced_Conversations?call_date=gte.${weekAgo.toISOString()}&order=call_date.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to fetch');

                const calls = await response.json();

                // Calculate team stats
                const totalCalls = calls.length;
                const uniqueReps = [...new Set(calls.map(c => c.rep_email))].length;
                const analyzedCalls = calls.filter(c => c.methodology_scores?.overall).length;

                // Find top performer (highest avg score)
                const repScores = {};
                calls.forEach(call => {
                    if (call.methodology_scores?.overall && call.rep_email) {
                        if (!repScores[call.rep_email]) {
                            repScores[call.rep_email] = { total: 0, count: 0 };
                        }
                        repScores[call.rep_email].total += call.methodology_scores.overall;
                        repScores[call.rep_email].count += 1;
                    }
                });

                let topPerformer = null;
                let topScore = 0;
                Object.entries(repScores).forEach(([email, data]) => {
                    const avg = data.total / data.count;
                    if (avg > topScore && data.count >= 2) {
                        topScore = avg;
                        topPerformer = email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                });

                container.innerHTML = `
                    <div class="team-stat">
                        <div class="stat-value">${totalCalls}</div>
                        <div class="stat-label">Team Calls This Week</div>
                    </div>
                    <div class="team-stat">
                        <div class="stat-value">${uniqueReps}</div>
                        <div class="stat-label">Active Reps</div>
                    </div>
                    <div class="team-stat">
                        <div class="stat-value">${analyzedCalls}</div>
                        <div class="stat-label">Calls Analyzed</div>
                    </div>
                    ${topPerformer ? `
                        <div class="team-stat highlight">
                            <div class="stat-value">${topPerformer}</div>
                            <div class="stat-label">Top Performer (${topScore.toFixed(1)} avg)</div>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                console.error('Error loading team accomplishments:', error);
                container.innerHTML = `
                    <div class="team-stat">
                        <div class="stat-label">Team stats loading...</div>
                    </div>
                `;
            }
        }

        // Load team accomplishments on init
        loadTeamAccomplishments();

        // ============================================
        // PERSONAL ACHIEVEMENTS
        // ============================================

        const BADGES = [
            {
                id: 'first_analysis',
                icon: 'ðŸŽ¯',
                name: 'First Steps',
                description: 'Got your first call analyzed',
                check: (calls) => calls.filter(c => c.methodology_scores?.overall).length >= 1
            },
            {
                id: 'five_analyzed',
                icon: 'ðŸ“Š',
                name: 'Getting Serious',
                description: '5 calls analyzed',
                check: (calls) => calls.filter(c => c.methodology_scores?.overall).length >= 5
            },
            {
                id: 'ten_analyzed',
                icon: 'ðŸ†',
                name: 'Committed',
                description: '10 calls analyzed',
                check: (calls) => calls.filter(c => c.methodology_scores?.overall).length >= 10
            },
            {
                id: 'high_scorer',
                icon: 'â­',
                name: 'High Performer',
                description: 'Scored 8+ on a call',
                check: (calls) => calls.some(c => c.methodology_scores?.overall >= 8)
            },
            {
                id: 'perfect_ten',
                icon: 'ðŸ’Ž',
                name: 'Perfect 10',
                description: 'Scored 10/10 on a call',
                check: (calls) => calls.some(c => c.methodology_scores?.overall >= 10)
            },
            {
                id: 'pain_master',
                icon: 'ðŸ”¥',
                name: 'Pain Funnel Pro',
                description: 'Scored 8+ on Pain Funnel',
                check: (calls) => calls.some(c => {
                    const comp = c.methodology_scores?.components?.find(x => x.name === 'Pain Funnel');
                    return comp && comp.score >= 8;
                })
            },
            {
                id: 'upfront_master',
                icon: 'ðŸ¤',
                name: 'Contract King',
                description: 'Scored 8+ on Upfront Contract',
                check: (calls) => calls.some(c => {
                    const comp = c.methodology_scores?.components?.find(x => x.name === 'Upfront Contract');
                    return comp && comp.score >= 8;
                })
            },
            {
                id: 'improving',
                icon: 'ðŸ“ˆ',
                name: 'On The Rise',
                description: 'Score improved over last 3 calls',
                check: (calls) => {
                    const scored = calls.filter(c => c.methodology_scores?.overall)
                        .sort((a, b) => new Date(b.call_date) - new Date(a.call_date))
                        .slice(0, 3);
                    if (scored.length < 3) return false;
                    return scored[0].methodology_scores.overall > scored[2].methodology_scores.overall;
                }
            },
            {
                id: 'consistent',
                icon: 'ðŸŽ–ï¸',
                name: 'Consistent',
                description: '3 calls in a row above 7',
                check: (calls) => {
                    const scored = calls.filter(c => c.methodology_scores?.overall)
                        .sort((a, b) => new Date(b.call_date) - new Date(a.call_date))
                        .slice(0, 3);
                    return scored.length >= 3 && scored.every(c => c.methodology_scores.overall >= 7);
                }
            },
            {
                id: 'self_improver',
                icon: 'ðŸ”¬',
                name: 'Self-Analyzer',
                description: 'Analyzed your own call',
                check: (calls) => calls.filter(c => c.methodology_scores?.overall).length >= 1 // Simplified
            }
        ];

        function renderAchievements(calls) {
            const container = document.getElementById('achievements-badges');
            if (!container) return;

            const earnedBadges = BADGES.filter(badge => badge.check(calls));
            const lockedBadges = BADGES.filter(badge => !badge.check(calls)).slice(0, 3); // Show max 3 locked

            let html = '';

            // Show earned badges first
            earnedBadges.forEach(badge => {
                html += `
                    <div class="achievement-badge earned" title="${badge.description}">
                        <span class="badge-icon">${badge.icon}</span>
                        <span class="badge-text">${badge.name}</span>
                    </div>
                `;
            });

            // Show a few locked badges as goals
            lockedBadges.forEach(badge => {
                html += `
                    <div class="achievement-badge locked" title="${badge.description}">
                        <span class="badge-icon">ðŸ”’</span>
                        <span class="badge-text">${badge.name}</span>
                    </div>
                `;
            });

            if (earnedBadges.length === 0 && lockedBadges.length === 0) {
                html = '<span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">Analyze calls to earn badges!</span>';
            }

            container.innerHTML = html;
        }
    </script>
</body>
</html>
