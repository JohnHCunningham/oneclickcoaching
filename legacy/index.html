<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Advantage Solutions Success Chart</title>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        /* --- BRAND COLOR PALETTE --- */
        :root {
            --brand-navy: #0C1030;
            --brand-teal: #10C3B0;
            --brand-aqua: #3DE0D2;
            --brand-pink: #E64563;
            --brand-gold: #F4B03A;
            --brand-yellow: #F9C863;
            --light-text: #F2F4F8;
            --card-bg: #131a40;
            --input-bg: #090c26;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--brand-navy) 0%, #050816 100%);
            color: var(--light-text);
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--brand-aqua), var(--brand-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--brand-gold);
            font-size: 1.1rem;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 60px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 0 20px;
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 224, 210, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            gap: 15px;
            justify-content: flex-start;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .card-title {
            color: var(--brand-aqua);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-icon {
            font-size: 2rem;
        }

        .metric-large {
            font-size: 3rem;
            font-weight: 900;
            color: var(--brand-gold);
            line-height: 1;
            margin: 10px 0;
            text-align: center;
        }

        .metric-label {
            color: var(--light-text);
            opacity: 0.7;
            font-size: 0.9rem;
            text-align: center;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--brand-teal);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--brand-aqua);
            box-shadow: 0 0 0 3px rgba(61, 224, 210, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow));
            border: none;
            padding: 12px 24px;
            color: var(--brand-navy);
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 15px;
            font-size: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 176, 58, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .funnel-container {
            margin-top: 20px;
            flex: 1;
        }

        .funnel-stage {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .funnel-stage-label {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .funnel-stage-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-gold);
        }

        .funnel-stage-rate {
            font-size: 0.8rem;
            color: var(--brand-teal);
            margin-left: 10px;
        }

        .coaching-card {
            background: linear-gradient(135deg, rgba(16, 195, 176, 0.1), rgba(61, 224, 210, 0.05));
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--brand-teal);
            flex: 1;
        }

        .coaching-title {
            color: var(--brand-aqua);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .coaching-content {
            color: var(--light-text);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .priority-high {
            border-left-color: var(--brand-pink);
        }

        .priority-medium {
            border-left-color: var(--brand-gold);
        }

        .priority-low {
            border-left-color: var(--brand-teal);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            flex: 1;
            align-content: start;
        }

        /* Dynamic content containers */
        #coaching-insights,
        #smart-recommendations,
        #conversation-history,
        #manager-notes-container,
        #active-goals-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 150px;
            justify-content: center;
            align-items: center;
        }

        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-gold);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--light-text);
            opacity: 0.7;
            margin-top: 5px;
        }

        .progress-bar-bg {
            background-color: rgba(255,255,255,0.1);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
            transition: width 0.5s ease-in-out;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .alert-success {
            background: rgba(16, 195, 176, 0.2);
            border: 1px solid var(--brand-teal);
            color: var(--brand-aqua);
        }

        .alert-error {
            background: rgba(230, 69, 99, 0.2);
            border: 1px solid var(--brand-pink);
            color: var(--brand-pink);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--brand-teal);
        }

        /* Manager Notes Styles */
        .manager-note {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--brand-teal);
        }

        .manager-note.type-praise {
            border-left-color: var(--brand-teal);
            background: rgba(16, 195, 176, 0.05);
        }

        .manager-note.type-strength {
            border-left-color: var(--brand-teal);
            background: rgba(16, 195, 176, 0.05);
        }

        .manager-note.type-correction {
            border-left-color: var(--brand-pink);
            background: rgba(230, 69, 99, 0.05);
        }

        .manager-note.type-weakness {
            border-left-color: var(--brand-gold);
            background: rgba(244, 176, 58, 0.05);
        }

        .manager-note.type-goal {
            border-left-color: var(--brand-aqua);
            background: rgba(61, 224, 210, 0.05);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .note-type-badge {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
            background: rgba(61, 224, 210, 0.2);
            color: var(--brand-aqua);
        }

        .note-type-badge.praise {
            background: rgba(16, 195, 176, 0.2);
            color: var(--brand-teal);
        }

        .note-type-badge.strength {
            background: rgba(16, 195, 176, 0.2);
            color: var(--brand-teal);
        }

        .note-type-badge.correction {
            background: rgba(230, 69, 99, 0.2);
            color: var(--brand-pink);
        }

        .note-type-badge.weakness {
            background: rgba(244, 176, 58, 0.2);
            color: var(--brand-gold);
        }

        .note-date {
            font-size: 0.85rem;
            color: rgba(242, 244, 248, 0.5);
        }

        .note-text {
            color: var(--light-text);
            line-height: 1.6;
            font-size: 1rem;
        }

        .note-related-metric {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: var(--brand-teal);
        }

        /* Goal Styles */
        .goal-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--brand-aqua);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .goal-metric-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--brand-aqua);
        }

        .goal-status-badge {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
        }

        .goal-status-badge.active {
            background: rgba(61, 224, 210, 0.2);
            color: var(--brand-aqua);
        }

        .goal-status-badge.achieved {
            background: rgba(16, 195, 176, 0.2);
            color: var(--brand-teal);
        }

        .goal-status-badge.missed {
            background: rgba(230, 69, 99, 0.2);
            color: var(--brand-pink);
        }

        .goal-progress-section {
            margin-bottom: 15px;
        }

        .goal-values {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .goal-current {
            font-weight: 700;
            color: var(--brand-gold);
            font-size: 1.3rem;
        }

        .goal-target {
            color: rgba(242, 244, 248, 0.7);
        }

        .goal-progress-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .goal-progress-fill.achieved {
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-aqua));
        }

        .goal-progress-fill.on-track {
            background: linear-gradient(90deg, var(--brand-gold), var(--brand-yellow));
        }

        .goal-progress-fill.behind {
            background: linear-gradient(90deg, var(--brand-pink), #c13752);
        }

        .goal-notes {
            color: rgba(242, 244, 248, 0.7);
            font-size: 0.9rem;
            font-style: italic;
            line-height: 1.5;
        }

        .goal-period {
            color: rgba(242, 244, 248, 0.6);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }

        .wide-card {
            grid-column: span 2;
        }

        @media (max-width: 1400px) {
            .wide-card {
                grid-column: span 2;
            }
        }

        @media (max-width: 1024px) {
            .wide-card {
                grid-column: span 1;
            }
        }

        .full-width-card {
            grid-column: 1 / -1;
        }

        /* Circular Progress Indicators */
        .goal-progress-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 20px;
            flex: 1;
            align-content: start;
        }

        .circular-progress {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 10;
        }

        .progress-circle-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-circle-fill.dials {
            stroke: var(--brand-teal);
        }

        .progress-circle-fill.conversations {
            stroke: var(--brand-aqua);
        }

        .progress-circle-fill.meetings {
            stroke: var(--brand-gold);
        }

        .progress-circle-fill.sales {
            stroke: var(--brand-pink);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--brand-gold);
            line-height: 1;
        }

        .progress-goal {
            font-size: 0.75rem;
            color: var(--light-text);
            opacity: 0.6;
            margin-top: 2px;
        }

        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--light-text);
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 0.8rem;
            color: var(--brand-teal);
            margin-top: 3px;
        }

        /* Tab styles for Monthly/YTD toggle */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--light-text);
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua));
            color: var(--brand-navy);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="header">
            <div>
                <h1>AI Advantage Solutions Success Chart</h1>
                <p>Performance Analytics & AI Coaching</p>
            </div>

            <!-- Button Container -->
            <div id="header-buttons" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 20px;">
                <a href="sales-email-generator.html" style="display: inline-block; background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow)); color: var(--brand-navy); padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 700; transition: all 0.2s ease; position: relative; z-index: 10; pointer-events: auto; box-shadow: 0 2px 8px rgba(244, 176, 58, 0.3);">
                    üìß Open Email Generator
                </a>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">

            <!-- SECTION 1: SETUP & CONFIGURATION -->
            <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;">
                <h2 style="color: var(--brand-aqua); font-size: 1.5rem; margin: 0;">‚öôÔ∏è Setup & Configuration</h2>
                <button onclick="toggleSetup()" id="setup-toggle-btn" style="background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua)); border: none; padding: 8px 16px; color: var(--brand-navy); font-weight: 700; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s ease;">
                    Hide Setup
                </button>
            </div>

            <div id="setup-section" style="display: contents;">

            <!-- Sales Methodology Selector Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Your Sales Methodology</h2>
                    <span class="card-icon">üìö</span>
                </div>

                <div class="input-group">
                    <label>Which sales framework do you use?</label>
                    <select id="sales-methodology" onchange="saveMethodology()">
                        <option value="meddic">MEDDIC/MEDDPICC</option>
                        <option value="challenger">Challenger Sale</option>
                        <option value="sandler">Sandler Selling System</option>
                        <option value="spin">SPIN Selling</option>
                        <option value="gap">Gap Selling</option>
                    </select>
                </div>

                <div id="methodology-description" style="margin-top: 15px; padding: 15px; background: rgba(16, 195, 176, 0.1); border-radius: 10px; font-size: 0.9rem; line-height: 1.6;">
                    <!-- Methodology description will be inserted here -->
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(244, 176, 58, 0.1); border-radius: 8px; font-size: 0.85rem;">
                    <strong>üí° White-Label Ready:</strong> This platform adapts to YOUR methodology. Coaching analysis and templates customize automatically.
                </div>
            </div>

            <!-- ICP (Ideal Customer Profile) Builder Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ideal Customer Profile (ICP)</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div class="input-group">
                    <label>Target Industry</label>
                    <input type="text" id="icp-industry" placeholder="e.g., Mixed-income housing providers, SaaS companies">
                </div>

                <div class="input-group">
                    <label>Company Size</label>
                    <input type="text" id="icp-company-size" placeholder="e.g., 50-500 employees, $10M-$100M revenue">
                </div>

                <div class="input-group">
                    <label>Target Job Titles</label>
                    <input type="text" id="icp-job-titles" placeholder="e.g., VP Sales, Sales Director, Head of Revenue">
                </div>

                <div class="input-group">
                    <label>Company Characteristics (Qualifiers & Disqualifiers)</label>
                    <textarea id="icp-characteristics" placeholder="e.g., ‚úì Uses Sandler/MEDDIC methodology ‚úì Invested in sales training ‚úì Modern sales tools (Gong, Salesforce) ‚úó <5 sales reps ‚úó B2C companies ‚úó No formal methodology" rows="4"></textarea>
                    <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                        What makes them a good fit? What disqualifies them? Use ‚úì for qualifiers, ‚úó for disqualifiers.
                    </small>
                </div>

                <div class="input-group">
                    <label>Key Pain Points</label>
                    <textarea id="icp-pain-points" placeholder="e.g., Sales reps not executing methodology, inconsistent pipeline, low close rates" rows="3"></textarea>
                </div>

                <div class="input-group">
                    <label>Typical Budget Range</label>
                    <input type="text" id="icp-budget" placeholder="e.g., $500-$2,000/month, $5,000-$25,000/year">
                </div>

                <button class="btn-primary" onclick="saveICP()">Save ICP</button>

                <div id="icp-display" style="margin-top: 20px; padding: 15px; background: rgba(16, 195, 176, 0.1); border-radius: 12px; display: none;">
                    <h3 style="color: var(--brand-gold); font-size: 1rem; margin-bottom: 10px;">Your Ideal Customer:</h3>
                    <div id="icp-summary" style="font-size: 0.9rem; line-height: 1.6;"></div>
                </div>
            </div>

            <!-- Services/Products Manager Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Your Services/Products</h2>
                    <span class="card-icon">üì¶</span>
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="input-group">
                        <label>Service/Product Name</label>
                        <input type="text" id="product-name" placeholder="e.g., AI Sales Coaching - Monthly">
                    </div>

                    <div class="input-group">
                        <label>Price (CAD)</label>
                        <input type="number" id="product-price" min="0" step="0.01" placeholder="5000">
                    </div>

                    <div class="input-group">
                        <label>Description (Optional)</label>
                        <textarea id="product-description" placeholder="Brief description of the service/product" rows="2"></textarea>
                    </div>

                    <button class="btn-primary" onclick="addProduct()">+ Add Product</button>
                </div>

                <div id="products-list" style="display: grid; gap: 10px;">
                    <!-- Products will be listed here -->
                </div>
            </div>

            <!-- Activity Goals Settings Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Activity Goals Settings</h2>
                    <span class="card-icon">‚öôÔ∏è</span>
                </div>

                <div class="input-group">
                    <label>Daily Dials Goal</label>
                    <input type="number" id="goal-dials" min="1" value="15">
                </div>

                <div class="input-group">
                    <label>Daily Conversations Goal</label>
                    <input type="number" id="goal-conversations" min="1" value="5">
                </div>

                <div class="input-group">
                    <label>Daily Meetings Goal</label>
                    <input type="number" id="goal-meetings" min="1" value="2">
                </div>

                <div class="input-group">
                    <label>Daily Sales Goal</label>
                    <input type="number" id="goal-sales" min="1" value="1">
                </div>

                <button class="btn-primary" onclick="saveActivityGoals()">Save Goals</button>
            </div>

            <!-- Sales Scripts Editor Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Your Sales Scripts</h2>
                    <span class="card-icon">üìù</span>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: rgba(61, 224, 210, 0.1); border-radius: 10px; font-size: 0.9rem;">
                    <strong>‚ú® AI-Powered:</strong> Describe your business below and let Claude rewrite your scripts to match your unique value proposition.
                </div>

                <div class="input-group">
                    <label>Business Description</label>
                    <textarea id="script-business-description" placeholder="e.g., I help mixed-income community housing providers in Hamilton save up to 20 hours per week by automating repetitive tasks like maintenance requests, tenant communications, and compliance tracking." rows="3"></textarea>
                    <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                        What do you do? Who do you help? What problems do you solve?
                    </small>
                </div>

                <div class="input-group">
                    <label>Ideal Customer Profile (ICP)</label>
                    <textarea id="script-icp" placeholder="e.g., Company Size: 50-200 employees, Sales Team: 10-50 reps, Revenue: $10M-$100M, Industry: B2B SaaS, Uses methodology: Sandler/MEDDIC, Modern sales tools: Salesforce/Gong" rows="4"></textarea>
                    <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                        Who is your ideal customer? Company characteristics, qualifiers, and disqualifiers.
                    </small>
                </div>

                <div class="input-group">
                    <label>Opening Script (Cold Call)</label>
                    <textarea id="script-opening" placeholder='e.g., "Hi [Name], this is [Your Name] from [Company] here in [Location]. I know I\'m catching you cold, so I\'ll be brief."' rows="3"></textarea>
                </div>

                <div class="input-group">
                    <label>Value Proposition</label>
                    <textarea id="script-value-prop" placeholder='e.g., "I help [Target Customer] save up to [Specific Benefit] by [How You Do It]."' rows="3"></textarea>
                </div>

                <div class="input-group">
                    <label>Call to Action (CTA)</label>
                    <textarea id="script-cta" placeholder='e.g., "I\'d love to show you how in a quick 15-minute online meeting. Do you have your calendar handy, or would [Date] at [Time] work better?"' rows="3"></textarea>
                </div>

                <div class="input-group">
                    <label>Objection Handling Template</label>
                    <textarea id="script-objections" placeholder='e.g., "I understand. A lot of our clients felt the same way initially. What if we could show you [specific outcome] in the first 30 days?"' rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="saveScripts()">üíæ Save Scripts</button>
                    <button class="btn-primary" onclick="rewriteScriptsWithAI()" style="background: linear-gradient(135deg, var(--brand-pink), #c13752);">
                        ‚ú® Rewrite Scripts with AI
                    </button>
                </div>

                <div id="scripts-rewrite-status" style="margin-top: 15px; display: none;"></div>
            </div>

            </div><!-- End setup-section -->

            <!-- SECTION 2: DAILY ACTIONS -->
            <h2 style="grid-column: 1 / -1; color: var(--brand-aqua); margin: 30px 0 10px 0; font-size: 1.5rem;">üìù Daily Actions</h2>

            <!-- Daily Activity Input Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Activity</h2>
                    <span class="card-icon">üìä</span>
                </div>

                <div class="input-group">
                    <label># of Dials</label>
                    <input type="number" id="input-dials" min="0" value="0">
                </div>

                <div class="input-group">
                    <label># of Conversations</label>
                    <input type="number" id="input-conversations" min="0" value="0">
                </div>

                <div class="input-group">
                    <label># of Discovery Meetings</label>
                    <input type="number" id="input-meetings" min="0" value="0">
                </div>

                <button class="btn-primary" onclick="saveDailyStats()">Save Today's Stats</button>
            </div>

            <!-- Sales Entry Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Record Sale</h2>
                    <span class="card-icon">üí∞</span>
                </div>

                <div class="input-group">
                    <label>Select Product/Service</label>
                    <select id="input-product" onchange="selectProduct()">
                        <option value="">Select a product...</option>
                        <!-- Products will be loaded dynamically -->
                    </select>
                    <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                        No products? Add them in "Your Services/Products" section above
                    </small>
                </div>

                <div class="input-group">
                    <label>Sale Amount (CAD)</label>
                    <input type="number" id="input-amount" min="0" step="0.01" placeholder="0.00">
                    <small style="opacity: 0.7; font-size: 0.85rem; margin-top: 5px; display: block;">
                        Auto-filled from product, or enter custom amount
                    </small>
                </div>

                <div class="input-group">
                    <label>Client Name</label>
                    <input type="text" id="input-client" placeholder="Client name">
                </div>

                <button class="btn-primary" onclick="recordSale()">Record Sale</button>
            </div>

            <!-- Cold Call Script Reference -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üìã Cold Call Script</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <p style="opacity: 0.9; margin-bottom: 15px;">Your personalized sales script. Click sections to expand.</p>

                <div id="script-display-container" style="background: rgba(16, 195, 176, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üìû Opening Script
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <strong style="color: var(--brand-gold);">Your Opening:</strong>
                                <p id="display-opening" style="margin-top: 8px; line-height: 1.6;">
                                    No script saved yet. Add your opening script in the Setup section above.
                                </p>
                            </div>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üíé Value Proposition
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <strong style="color: var(--brand-gold);">Your Value Prop:</strong>
                                <p id="display-value-prop" style="margin-top: 8px; line-height: 1.6;">
                                    No value proposition saved yet. Add it in the Setup section above.
                                </p>
                            </div>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üéØ Call to Action
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <strong style="color: var(--brand-gold);">Your CTA:</strong>
                                <p id="display-cta" style="margin-top: 8px; line-height: 1.6;">
                                    No call to action saved yet. Add it in the Setup section above.
                                </p>
                            </div>
                        </div>
                    </details>

                    <details>
                        <summary style="cursor: pointer; font-weight: 700; color: var(--brand-aqua); font-size: 1.1rem; margin-bottom: 10px;">
                            üõ°Ô∏è Objection Handling
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <strong style="color: var(--brand-pink);">Your Response:</strong>
                            <p id="display-objections" style="margin-top: 8px; line-height: 1.6;">
                                No objection handling saved yet. Add it in the Setup section above.
                            </p>
                        </div>
                    </details>
                </div>

                <div style="background: linear-gradient(135deg, rgba(244, 176, 58, 0.2), rgba(249, 200, 99, 0.1)); padding: 15px; border-radius: 10px; border-left: 4px solid var(--brand-gold);">
                    <strong style="color: var(--brand-gold);">üéØ Script Adherence Tip:</strong>
                    <p style="margin-top: 8px; line-height: 1.6; opacity: 0.9;">
                        When analyzing your calls below, the AI will check if you followed this script structure and provide specific coaching on improvements!
                    </p>
                </div>
            </div>

            <!-- SECTION 3: PERFORMANCE TRACKING -->
            <h2 style="grid-column: 1 / -1; color: var(--brand-aqua); margin: 30px 0 10px 0; font-size: 1.5rem;">üìä Performance Tracking</h2>

            <!-- Daily Goal Progress Card -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Today's Goal Progress</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div class="goal-progress-container" id="goal-progress-container">
                    <!-- Goal circles will be dynamically inserted here -->
                </div>
            </div>

            <!-- Conversion Funnel Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Conversion Funnel</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchFunnelTab('monthly')">This Month</button>
                    <button class="tab-btn" onclick="switchFunnelTab('ytd')">Year to Date</button>
                </div>

                <div class="tab-content active" id="funnel-monthly">
                    <div class="funnel-container" id="funnel-container-monthly">
                        <div class="loading">Loading monthly data...</div>
                    </div>
                </div>

                <div class="tab-content" id="funnel-ytd">
                    <div class="funnel-container" id="funnel-container-ytd">
                        <div class="loading">Loading YTD data...</div>
                    </div>
                </div>
            </div>

            <!-- Weekly Performance Chart -->
            <div class="card full-width-card">
                <div class="card-header">
                    <h2 class="card-title">Weekly Performance Trend</h2>
                    <span class="card-icon">üìà</span>
                </div>
                <div class="chart-container">
                    <canvas id="weekly-chart"></canvas>
                </div>
            </div>

            <!-- SECTION 4: REVENUE & GOALS -->
            <h2 style="grid-column: 1 / -1; color: var(--brand-aqua); margin: 30px 0 10px 0; font-size: 1.5rem;">üí∞ Revenue & Goals</h2>

            <!-- Revenue Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Revenue Overview</h2>
                    <span class="card-icon">üíµ</span>
                </div>

                <div class="metric-large" id="total-revenue">$0</div>
                <div class="metric-label">Total Revenue (CAD)</div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="total-sales">0</div>
                        <div class="stat-label">Total Sales</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-sale">$0</div>
                        <div class="stat-label">Avg Sale Value</div>
                    </div>
                </div>
            </div>

            <!-- Sales Quota Tracking Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Sales Quota Tracking</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 0.9rem;">Monthly Sales Quota (CAD)</label>
                    <input type="number" id="monthly-quota" value="10000" min="0" step="1000"
                        style="width: 100%; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--brand-teal); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 1rem;"
                        onchange="updateQuotaTracking()">
                </div>

                <div id="quota-tracking-mtd" style="margin-bottom: 25px;">
                    <!-- MTD quota tracking will be inserted here -->
                </div>

                <div id="quota-tracking-ytd">
                    <!-- YTD quota tracking will be inserted here -->
                </div>
            </div>

            <!-- Annual Sales Goal Tracker -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">2025 Revenue Goal</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 0.9rem;">Annual Goal (CAD)</label>
                    <input type="number" id="annual-goal" value="120000" min="0" step="1000"
                        style="width: 100%; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--brand-teal); padding: 10px; border-radius: 8px; font-weight: 600; font-size: 1rem;"
                        onchange="updateGoalTracking()">
                </div>

                <div id="goal-breakdown" style="margin-top: 15px;">
                    <!-- Goal breakdown will be inserted here -->
                </div>
            </div>

            <!-- SECTION 5: MANAGER FEEDBACK & GOALS -->
            <h2 style="grid-column: 1 / -1; color: var(--brand-aqua); margin: 30px 0 10px 0; font-size: 1.5rem;">üë®‚Äçüíº Manager Feedback & Goals</h2>

            <!-- Manager Notes -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Coaching Notes from Your Manager</h2>
                    <span class="card-icon">üí¨</span>
                </div>

                <div id="manager-notes-loading" class="loading" style="display: none;">Loading feedback...</div>
                <div id="manager-notes-container">
                    <p style="text-align: center; opacity: 0.6; padding: 30px;">No coaching notes yet</p>
                </div>
            </div>

            <!-- Active Goals -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Your Active Goals</h2>
                    <span class="card-icon">üéØ</span>
                </div>

                <div id="active-goals-loading" class="loading" style="display: none;">Loading goals...</div>
                <div id="active-goals-container">
                    <p style="text-align: center; opacity: 0.6; padding: 30px;">No active goals set</p>
                </div>
            </div>

            <!-- SECTION 6: AI COACHING & INSIGHTS -->
            <h2 style="grid-column: 1 / -1; color: var(--brand-aqua); margin: 30px 0 10px 0; font-size: 1.5rem;">ü§ñ AI Coaching & Insights</h2>

            <!-- AI Coaching Insights -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">AI Performance Coach</h2>
                    <span class="card-icon">ü§ñ</span>
                </div>

                <div id="coaching-insights">
                    <div class="loading">Analyzing your performance...</div>
                </div>

                <button class="btn-primary" onclick="generateCoachingInsights()">Refresh Insights</button>
            </div>

            <!-- Smart Goal Calculator Card -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">Smart Activity Recommendations</h2>
                    <span class="card-icon">üß†</span>
                </div>

                <p style="opacity: 0.9; margin-bottom: 20px;">Based on your historical conversion rates and sales quota, here's what you need to do:</p>

                <div id="smart-recommendations">
                    <div class="loading">Calculating recommendations...</div>
                </div>
            </div>

            <!-- Sales Conversation Analysis -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üéôÔ∏è Sales Conversation Coach</h2>
                    <span class="card-icon">üìû</span>
                </div>

                <p style="opacity: 0.9; margin-bottom: 20px;">Upload a sales call recording or transcript to get detailed coaching on your conversation execution based on your selected sales methodology.</p>

                <div class="input-group">
                    <label>Conversation Title</label>
                    <input type="text" id="conversation-title" placeholder="e.g., Discovery Call - ABC Housing Corp">
                </div>

                <div class="input-group">
                    <label>Type of Call</label>
                    <select id="conversation-type">
                        <option value="cold_call">Cold Call</option>
                        <option value="discovery" selected>Discovery Meeting</option>
                        <option value="demo">Demo/Presentation</option>
                        <option value="close">Closing Call</option>
                        <option value="follow_up">Follow-Up</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Upload Audio or Paste Transcript</label>
                    <input type="file" id="audio-upload" accept=".mp3,.wav,.m4a,.txt" style="margin-bottom: 10px;">
                    <textarea id="transcript-input" rows="6" placeholder="Or paste your conversation transcript here...

Example:
Rep: Hi John, thanks for taking my call. I know you're busy...
Prospect: No problem, what's this about?
Rep: I wanted to learn more about your housing operations..."></textarea>
                </div>

                <button class="btn-primary" onclick="analyzeConversation()">üéØ Analyze Sales Conversation</button>

                <div id="conversation-analysis-result" style="margin-top: 20px;"></div>
            </div>

            <!-- Recent Conversation Analyses -->
            <div class="card wide-card">
                <div class="card-header">
                    <h2 class="card-title">üìä Conversation History</h2>
                    <span class="card-icon">üìà</span>
                </div>

                <div id="conversation-history">
                    <div class="loading">Loading conversation analyses...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Notification Panel (Hidden by default) -->
    <div id="notification-panel" style="display: none; position: fixed; top: 80px; right: 20px; width: 400px; max-width: calc(100vw - 40px); max-height: 600px; background: var(--card-bg); border: 2px solid var(--brand-teal); border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;">
        <div style="background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua)); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: white; font-size: 18px;">üì¨ Coaching Messages</h3>
            <div style="display: flex; gap: 10px;">
                <button id="mark-all-read-btn" onclick="markAllAsRead()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">Mark All Read</button>
                <button onclick="toggleNotificationPanel()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">√ó</button>
            </div>
        </div>

        <div id="notification-list" style="padding: 15px; overflow-y: auto; max-height: 520px;">
            <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                <p>Loading messages...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // REPLACE THESE WITH YOUR SUPABASE PROJECT DETAILS
        const SUPABASE_URL = 'https://qwqlsbccwnwrdpcaccjz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3cWxzYmNjd253cmRwY2FjY2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMTA1MDQsImV4cCI6MjA4MDg4NjUwNH0.yWzSV2Nid_T1XiDE0RrskFob9mRUc-m6MbeIiT7huC4';

        // ============================================
        // EDGE FUNCTION CONFIGURATION
        // ============================================
        // Conversation analysis uses a secure Supabase Edge Function
        // API keys are stored securely on the server, never exposed to the client

        let supabaseClient;

        // Initialize Supabase client (with proper error handling)
        function initializeSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    console.error('Supabase library not loaded');
                    showAlert('Supabase library failed to load. Please refresh the page.', 'error');
                    return false;
                }
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized successfully');
                return true;
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showAlert('Please configure your Supabase credentials in the code.', 'error');
                return false;
            }
        }

        // Initialize immediately (will be called again in DOMContentLoaded as backup)
        initializeSupabase();

        // ============================================
        // AUTHENTICATION CHECK
        // ============================================

        let currentUser = null;
        let userEmail = '';

        async function checkAuthentication() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();

            if (error) {
                console.error('Auth check error:', error);
                redirectToLogin();
                return false;
            }

            if (!session) {
                redirectToLogin();
                return false;
            }

            // Store current user info
            currentUser = session.user;
            userEmail = currentUser.email;

            // Display user info in header
            updateUserDisplay();

            return true;
        }

        function redirectToLogin() {
            window.location.href = 'login.html';
        }

        // ============================================
        // ROLE MANAGEMENT
        // ============================================

        async function checkIfManager() {
            try {
                const { data, error } = await supabaseClient.rpc('is_manager');

                if (error) {
                    console.error('Error checking manager status:', error);
                    return false;
                }

                return data === true;
            } catch (error) {
                console.error('Error checking manager status:', error);
                return false;
            }
        }

        async function getUserAccount() {
            try {
                const { data, error } = await supabaseClient.rpc('get_user_account');

                if (error) throw error;

                if (data && data.length > 0) {
                    return data[0];
                }

                return null;
            } catch (error) {
                console.error('Error getting user account:', error);
                return null;
            }
        }

        // ============================================
        // NOTIFICATION FUNCTIONS
        // ============================================

        async function fetchUnreadCount() {
            try {
                const { data, error } = await supabaseClient.rpc('get_unread_message_count');

                if (error) throw error;

                const badge = document.getElementById('notification-badge');
                if (badge) {
                    if (data > 0) {
                        badge.textContent = data > 9 ? '9+' : data;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                return data;
            } catch (error) {
                console.error('Error fetching unread count:', error);
                return 0;
            }
        }

        async function fetchMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('User_Messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                displayMessages(data || []);
                return data;
            } catch (error) {
                console.error('Error fetching messages:', error);
                displayMessages([]);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('notification-list');

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        <p style="font-size: 48px; margin-bottom: 10px;">üì≠</p>
                        <p>No coaching messages yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const date = new Date(msg.created_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                const priorityColors = {
                    high: 'var(--brand-pink)',
                    medium: 'var(--brand-gold)',
                    low: 'var(--brand-teal)'
                };

                const priorityEmoji = {
                    high: 'üî¥',
                    medium: 'üü°',
                    low: 'üü¢'
                };

                return `
                    <div class="message-item" data-message-id="${msg.id}" style="
                        background: ${msg.is_read ? 'rgba(255,255,255,0.03)' : 'rgba(16, 195, 176, 0.1)'};
                        border: 1px solid ${msg.is_read ? 'rgba(255,255,255,0.1)' : 'var(--brand-teal)'};
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onclick="viewMessage('${msg.id}', ${!msg.is_read})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <span style="background: ${priorityColors[msg.priority]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-right: 8px;">
                                    ${priorityEmoji[msg.priority]} ${msg.priority.toUpperCase()}
                                </span>
                                ${!msg.is_read ? '<span style="background: var(--brand-pink); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">NEW</span>' : ''}
                            </div>
                            <span style="font-size: 12px; opacity: 0.7; white-space: nowrap;">${dateStr} ${timeStr}</span>
                        </div>

                        <h4 style="margin: 8px 0; color: var(--brand-teal); font-size: 14px;">${msg.subject}</h4>

                        ${msg.related_metric ? `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">üìä ${msg.related_metric}</div>` : ''}

                        <p style="margin: 0; font-size: 13px; opacity: 0.9; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                            ${msg.message_body.substring(0, 150)}${msg.message_body.length > 150 ? '...' : ''}
                        </p>

                        <div style="margin-top: 10px; font-size: 11px; opacity: 0.6;">
                            From: ${msg.from_name || msg.from_email}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewMessage(messageId, isUnread) {
            try {
                // Fetch full message
                const { data: msg, error } = await supabaseClient
                    .from('Coaching_Messages')
                    .select('*, from_user:from_user_id(email, raw_user_meta_data)')
                    .eq('id', messageId)
                    .single();

                if (error) throw error;

                // Mark as read if unread
                if (isUnread) {
                    await supabaseClient.rpc('mark_message_as_read', { message_id: messageId });
                    await fetchUnreadCount();
                    await fetchMessages(); // Refresh list
                }

                // Display full message in modal
                const date = new Date(msg.created_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                alert(`üì¨ ${msg.subject}\n\n${msg.message_body}\n\n---\nFrom: ${msg.from_user?.raw_user_meta_data?.full_name || msg.from_user?.email}\nDate: ${dateStr} at ${timeStr}\nMetric: ${msg.related_metric || 'General'}`);

            } catch (error) {
                console.error('Error viewing message:', error);
                alert('Error loading message. Please try again.');
            }
        }

        async function markAllAsRead() {
            try {
                const { data, error } = await supabaseClient.rpc('mark_all_messages_as_read');

                if (error) throw error;

                if (data > 0) {
                    await fetchUnreadCount();
                    await fetchMessages();
                    alert(`‚úÖ Marked ${data} message${data > 1 ? 's' : ''} as read`);
                } else {
                    alert('No unread messages');
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                alert('Error marking messages as read. Please try again.');
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            const isHidden = panel.style.display === 'none';

            if (isHidden) {
                panel.style.display = 'block';
                fetchMessages(); // Load messages when opening
            } else {
                panel.style.display = 'none';
            }
        }

        // Poll for new messages every 30 seconds
        setInterval(() => {
            if (currentUser) {
                fetchUnreadCount();
            }
        }, 30000);

        // Fetch initial unread count
        setTimeout(() => {
            if (currentUser) {
                fetchUnreadCount();
            }
        }, 2000);

        function updateUserDisplay() {
            const header = document.querySelector('.header h1');
            if (header && currentUser) {
                const userName = currentUser.user_metadata?.full_name || currentUser.email;
                header.innerHTML = `Daily Tracker <span style="font-size: 0.5em; color: var(--brand-teal); font-weight: normal;">| ${userName}</span>`;
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabaseClient.auth.signOut();
                redirectToLogin();
            }
        }

        // Add logout button to page
        function addLogoutButton() {
            const buttonContainer = document.getElementById('header-buttons');
            if (buttonContainer) {
                // Check if user is manager using database role
                checkIfManager().then(isManager => {
                    if (isManager) {
                        // Team Dashboard button (NEW - with celebration system)
                        const adminBtn = document.createElement('a');
                        adminBtn.href = 'manager-performance-dashboard.html';
                        adminBtn.textContent = 'üéØ Team Performance';
                        adminBtn.style.cssText = 'display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, var(--brand-teal), var(--brand-aqua)); color: white; text-decoration: none; border-radius: 25px; font-weight: 700; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(16, 195, 176, 0.3); position: relative; z-index: 10; pointer-events: auto;';
                        buttonContainer.appendChild(adminBtn);

                        // Fireflies Auto-Sync button
                        const firefliesBtn = document.createElement('a');
                        firefliesBtn.href = 'fireflies-settings.html';
                        firefliesBtn.textContent = 'üî• Auto-Sync';
                        firefliesBtn.style.cssText = 'display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #FF6B35, #FF8C42); color: white; text-decoration: none; border-radius: 25px; font-weight: 700; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3); position: relative; z-index: 10; pointer-events: auto;';
                        firefliesBtn.title = 'Fireflies Auto-Sync Settings';
                        buttonContainer.appendChild(firefliesBtn);
                    }
                });

                // Add notification bell
                const notifBtn = document.createElement('button');
                notifBtn.id = 'notification-bell';
                notifBtn.innerHTML = 'üîî';
                notifBtn.style.cssText = 'padding: 12px 20px; background: linear-gradient(135deg, var(--brand-gold), var(--brand-yellow)); color: var(--brand-navy); border: none; border-radius: 25px; font-size: 20px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(244, 176, 58, 0.3); position: relative; z-index: 10; pointer-events: auto;';
                notifBtn.onclick = toggleNotificationPanel;

                // Add badge for unread count
                const badge = document.createElement('span');
                badge.id = 'notification-badge';
                badge.style.cssText = 'position: absolute; top: 5px; right: 5px; background: var(--brand-pink); color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;';
                notifBtn.appendChild(badge);

                buttonContainer.appendChild(notifBtn);

                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Logout';
                logoutBtn.style.cssText = 'padding: 12px 24px; background: white; color: var(--brand-navy); border: 2px solid var(--brand-navy); border-radius: 25px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2); position: relative; z-index: 10; pointer-events: auto;';
                logoutBtn.onclick = handleLogout;
                buttonContainer.appendChild(logoutBtn);
            }
        }

        // Check auth on page load
        checkAuthentication().then(isAuthenticated => {
            if (isAuthenticated) {
                addLogoutButton();
                // Continue with normal page initialization
                console.log('User authenticated:', userEmail);
            }
        });

        // ============================================
        // CONFETTI CELEBRATION
        // ============================================

        function celebrateWithConfetti(type = 'default') {
            if (typeof confetti === 'undefined') {
                console.warn('Confetti library not loaded');
                return;
            }

            if (type === 'sale') {
                // Bigger celebration for sales with gold colors
                const count = 200;
                const defaults = {
                    origin: { y: 0.7 },
                    colors: ['#F4B03A', '#F9C863', '#10C3B0', '#3DE0D2']
                };

                function fire(particleRatio, opts) {
                    confetti({
                        ...defaults,
                        ...opts,
                        particleCount: Math.floor(count * particleRatio)
                    });
                }

                fire(0.25, {
                    spread: 26,
                    startVelocity: 55,
                });
                fire(0.2, {
                    spread: 60,
                });
                fire(0.35, {
                    spread: 100,
                    decay: 0.91,
                    scalar: 0.8
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 25,
                    decay: 0.92,
                    scalar: 1.2
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 45,
                });
            } else {
                // Standard celebration for daily stats with teal colors
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#10C3B0', '#3DE0D2', '#F4B03A']
                });
            }
        }

        // ============================================
        // DATA MANAGEMENT FUNCTIONS
        // ============================================

        // Save daily statistics
        async function saveDailyStats() {
            const dials = parseInt(document.getElementById('input-dials').value) || 0;
            const conversations = parseInt(document.getElementById('input-conversations').value) || 0;
            const meetings = parseInt(document.getElementById('input-meetings').value) || 0;

            if (dials === 0 && conversations === 0 && meetings === 0) {
                showAlert('Please enter at least one activity.', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            try {
                const { data, error } = await supabaseClient
                    .from('Daily_Tracker')
                    .upsert({
                        user_id: currentUser.id,
                        date: today,
                        dials: dials,
                        conversations: conversations,
                        discovery_meetings: meetings
                    }, { onConflict: 'user_id,date' });

                if (error) throw error;

                showAlert('Daily stats saved successfully!', 'success');
                celebrateWithConfetti('default');

                // Reset inputs
                document.getElementById('input-dials').value = 0;
                document.getElementById('input-conversations').value = 0;
                document.getElementById('input-meetings').value = 0;

                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error saving daily stats:', error);
                showAlert('Failed to save stats. Please try again.', 'error');
            }
        }

        // Record a sale
        async function recordSale() {
            const amount = parseFloat(document.getElementById('input-amount').value) || 0;
            const client = document.getElementById('input-client').value.trim();
            const service = document.getElementById('input-service').value;

            if (amount === 0) {
                showAlert('Please enter a sale amount.', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            try {
                const { data, error } = await supabaseClient
                    .from('Sales')
                    .insert({
                        user_id: currentUser.id,
                        date: today,
                        amount_cad: amount,
                        client_name: client,
                        service_type: service
                    });

                if (error) throw error;

                showAlert(`Sale of $${amount.toFixed(2)} CAD recorded!`, 'success');
                celebrateWithConfetti('sale');

                // Reset inputs
                document.getElementById('input-amount').value = '';
                document.getElementById('input-client').value = '';
                document.getElementById('input-service').value = '';

                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error recording sale:', error);
                showAlert('Failed to record sale. Please try again.', 'error');
            }
        }

        // ============================================
        // MANAGER FEEDBACK & GOALS
        // ============================================

        async function loadManagerNotes() {
            const container = document.getElementById('manager-notes-container');
            const loading = document.getElementById('manager-notes-loading');

            try {
                const { data: session } = await supabase.auth.getSession();
                if (!session || !session.session) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">Please sign in to view manager feedback</p>';
                    return;
                }

                loading.style.display = 'block';

                const { data: notes, error } = await supabase
                    .from('Manager_Notes')
                    .select('*')
                    .eq('user_id', session.session.user.id)
                    .eq('is_visible_to_user', true)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                loading.style.display = 'none';

                if (!notes || notes.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">No coaching notes yet</p>';
                    return;
                }

                container.innerHTML = notes.map(note => {
                    const createdDate = new Date(note.created_at).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    return `
                        <div class="manager-note type-${note.note_type}">
                            <div class="note-header">
                                <div class="note-type-badge ${note.note_type}">${note.note_type.toUpperCase()}</div>
                                <div class="note-date">${createdDate}</div>
                            </div>
                            <div class="note-text">${note.note_text}</div>
                            ${note.related_metric ? `
                                <div class="note-related-metric">
                                    üìä Related to: ${note.related_metric}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading manager notes:', error);
                loading.style.display = 'none';
                container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">No coaching notes yet</p>';
            }
        }

        async function loadActiveGoals() {
            const container = document.getElementById('active-goals-container');
            const loading = document.getElementById('active-goals-loading');

            try {
                const { data: session } = await supabase.auth.getSession();
                if (!session || !session.session) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">Please sign in to view goals</p>';
                    return;
                }

                loading.style.display = 'block';

                const { data: goals, error } = await supabase
                    .from('User_Goals')
                    .select('*')
                    .eq('user_id', session.session.user.id)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                loading.style.display = 'none';

                if (!goals || goals.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">No active goals set</p>';
                    return;
                }

                container.innerHTML = goals.map(goal => {
                    const progressPercent = goal.target_value > 0
                        ? Math.min((goal.current_value / goal.target_value) * 100, 100)
                        : 0;

                    const progressClass = progressPercent >= 100 ? 'achieved'
                        : progressPercent >= 70 ? 'on-track'
                        : 'behind';

                    const startDate = new Date(goal.start_date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });

                    const endDateStr = goal.end_date ? new Date(goal.end_date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }) : 'Ongoing';

                    return `
                        <div class="goal-card">
                            <div class="goal-header">
                                <div class="goal-metric-name">${goal.metric_type.replace(/_/g, ' ')}</div>
                                <div class="goal-status-badge ${goal.status}">${goal.status.toUpperCase()}</div>
                            </div>
                            <div class="goal-progress-section">
                                <div class="goal-values">
                                    <div>
                                        <span class="goal-current">${goal.current_value}</span>
                                        <span class="goal-target">/ ${goal.target_value}</span>
                                    </div>
                                    <div style="color: var(--brand-aqua); font-weight: 700;">
                                        ${progressPercent.toFixed(0)}%
                                    </div>
                                </div>
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill ${progressClass}"
                                         style="width: ${progressPercent}%"></div>
                                </div>
                                <div class="goal-period">
                                    ${goal.period.charAt(0).toUpperCase() + goal.period.slice(1)} Goal ‚Ä¢ ${startDate} - ${endDateStr}
                                </div>
                            </div>
                            ${goal.notes ? `
                                <div class="goal-notes">
                                    üí¨ ${goal.notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading active goals:', error);
                loading.style.display = 'none';
                container.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 30px;">No active goals set</p>';
            }
        }

        // ============================================
        // DASHBOARD DATA LOADING
        // ============================================

        async function loadDashboardData() {
            await Promise.all([
                loadConversionFunnel(),
                loadGoalProgress(),
                loadRevenueSummary(),
                loadWeeklyChart(),
                loadCoachingInsights(),
                calculateSmartRecommendations(),
                loadManagerNotes(),
                loadActiveGoals()
            ]);
        }

        // Load conversion funnel data
        async function loadConversionFunnel() {
            try {
                // Get current date info
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                const currentYear = now.getFullYear().toString();

                // Fetch all daily tracker data for YTD
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (dailyError) throw dailyError;

                // Fetch sales data for YTD
                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (salesError) throw salesError;

                // Calculate monthly metrics
                const monthlyData = dailyData.filter(d => d.date.startsWith(currentMonth));
                const monthlySales = salesData.filter(s => s.date.startsWith(currentMonth));

                const monthlyMetrics = calculateMetrics(monthlyData, monthlySales);

                // Calculate YTD metrics
                const ytdMetrics = calculateMetrics(dailyData, salesData);

                // Render monthly funnel
                renderFunnel('funnel-container-monthly', monthlyMetrics);

                // Render YTD funnel
                renderFunnel('funnel-container-ytd', ytdMetrics);

            } catch (error) {
                console.error('Error loading funnel:', error);
                document.getElementById('funnel-container-monthly').innerHTML = '<p style="color: var(--brand-pink);">Unable to load funnel data.</p>';
                document.getElementById('funnel-container-ytd').innerHTML = '<p style="color: var(--brand-pink);">Unable to load funnel data.</p>';
            }
        }

        // Calculate metrics from daily data
        function calculateMetrics(dailyData, salesData) {
            const totalDials = dailyData.reduce((sum, d) => sum + (d.dials || 0), 0);
            const totalConversations = dailyData.reduce((sum, d) => sum + (d.conversations || 0), 0);
            const totalMeetings = dailyData.reduce((sum, d) => sum + (d.discovery_meetings || 0), 0);
            const totalSales = salesData.length;

            const dialToConvRate = totalDials > 0 ? ((totalConversations / totalDials) * 100).toFixed(1) : 0;
            const convToMeetingRate = totalConversations > 0 ? ((totalMeetings / totalConversations) * 100).toFixed(1) : 0;
            const meetingToSaleRate = totalMeetings > 0 ? ((totalSales / totalMeetings) * 100).toFixed(1) : 0;

            return {
                totalDials,
                totalConversations,
                totalMeetings,
                totalSales,
                dialToConvRate,
                convToMeetingRate,
                meetingToSaleRate
            };
        }

        // Render funnel HTML
        function renderFunnel(containerId, metrics) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üìû Dials</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalDials}</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üí¨ Conversations</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalConversations}</span>
                        <span class="funnel-stage-rate">${metrics.dialToConvRate}%</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">ü§ù Discovery Meetings</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalMeetings}</span>
                        <span class="funnel-stage-rate">${metrics.convToMeetingRate}%</span>
                    </span>
                </div>
                <div class="funnel-stage">
                    <span class="funnel-stage-label">üí∞ Sales Closed</span>
                    <span>
                        <span class="funnel-stage-value">${metrics.totalSales}</span>
                        <span class="funnel-stage-rate">${metrics.meetingToSaleRate}%</span>
                    </span>
                </div>
            `;
        }

        // Switch between monthly and YTD tabs
        function switchFunnelTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'monthly') {
                tabs[0].classList.add('active');
                document.getElementById('funnel-monthly').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('funnel-ytd').classList.add('active');
            }
        }

        // Save activity goals to localStorage
        async function saveActivityGoals() {
            try {
                const goals = {
                    dials: parseInt(document.getElementById('goal-dials').value) || 15,
                    conversations: parseInt(document.getElementById('goal-conversations').value) || 5,
                    meetings: parseInt(document.getElementById('goal-meetings').value) || 2,
                    sales: parseInt(document.getElementById('goal-sales').value) || 1
                };

                localStorage.setItem('activityGoals', JSON.stringify(goals));
                showAlert('Activity goals saved successfully!', 'success');

                // Refresh goal progress display (async but don't await to avoid blocking)
                loadGoalProgress().catch(err => console.error('Error loading goal progress:', err));
                calculateSmartRecommendations().catch(err => console.error('Error calculating recommendations:', err));
            } catch (error) {
                console.error('Error saving activity goals:', error);
                showAlert('Failed to save activity goals. Please try again.', 'error');
            }
        }

        // Get activity goals from localStorage
        function getActivityGoals() {
            const saved = localStorage.getItem('activityGoals');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                dials: 15,
                conversations: 5,
                meetings: 2,
                sales: 1
            };
        }

        // Load activity goals into form
        function loadActivityGoalsForm() {
            const goals = getActivityGoals();
            document.getElementById('goal-dials').value = goals.dials;
            document.getElementById('goal-conversations').value = goals.conversations;
            document.getElementById('goal-meetings').value = goals.meetings;
            document.getElementById('goal-sales').value = goals.sales;
        }

        // Load goal progress circles
        async function loadGoalProgress() {
            try {
                // Get custom daily goals from localStorage
                const goals = getActivityGoals();

                // Get today's date
                const today = new Date().toISOString().split('T')[0];

                // Fetch today's activity data
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .eq('date', today)
                    .single();

                // Fetch today's sales
                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .eq('date', today);

                const actual = {
                    dials: dailyData?.dials || 0,
                    conversations: dailyData?.conversations || 0,
                    meetings: dailyData?.discovery_meetings || 0,
                    sales: salesData?.length || 0
                };

                // Render the progress circles
                const container = document.getElementById('goal-progress-container');
                container.innerHTML = `
                    ${createCircularProgress('Dials', actual.dials, goals.dials, 'dials')}
                    ${createCircularProgress('Conversations', actual.conversations, goals.conversations, 'conversations')}
                    ${createCircularProgress('Meetings', actual.meetings, goals.meetings, 'meetings')}
                    ${createCircularProgress('Sales', actual.sales, goals.sales, 'sales')}
                `;

            } catch (error) {
                console.error('Error loading goal progress:', error);
            }
        }

        // Create circular progress indicator HTML
        function createCircularProgress(label, actual, goal, className) {
            const percentage = Math.min((actual / goal) * 100, 100);
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            return `
                <div>
                    <div class="circular-progress">
                        <svg width="140" height="140">
                            <circle class="progress-circle-bg" cx="70" cy="70" r="${radius}"></circle>
                            <circle class="progress-circle-fill ${className}" cx="70" cy="70" r="${radius}"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
                        </svg>
                        <div class="progress-text">
                            <div class="progress-value">${actual}</div>
                            <div class="progress-goal">of ${goal}</div>
                        </div>
                    </div>
                    <div class="progress-label">${label}</div>
                    <div class="progress-percentage">${percentage.toFixed(0)}% Complete</div>
                </div>
            `;
        }

        // Load revenue summary
        async function loadRevenueSummary() {
            try {
                const { data, error } = await supabaseClient
                    .from('Sales')
                    .select('amount_cad, date');

                if (error) throw error;

                const totalRevenue = data.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const totalSales = data.length;
                const avgSale = totalSales > 0 ? totalRevenue / totalSales : 0;

                document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
                document.getElementById('total-sales').textContent = totalSales;
                document.getElementById('avg-sale').textContent = `$${avgSale.toFixed(2)}`;

                // Update goal tracking and quota tracking
                updateGoalTracking(totalRevenue);
                updateQuotaTracking(data);
            } catch (error) {
                console.error('Error loading revenue:', error);
            }
        }

        // Update quota tracking (MTD and YTD)
        async function updateQuotaTracking(salesData = null) {
            try {
                // If salesData not provided, fetch it
                if (!salesData) {
                    const { data, error } = await supabaseClient
                        .from('Sales')
                        .select('amount_cad, date');

                    if (error) throw error;
                    salesData = data;
                }

                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                const currentYear = now.getFullYear().toString();

                // Get monthly quota from input or localStorage
                const monthlyQuota = parseFloat(document.getElementById('monthly-quota').value) || 10000;
                localStorage.setItem('monthlyQuota', monthlyQuota);

                // Calculate MTD revenue
                const mtdSales = salesData.filter(s => s.date.startsWith(currentMonth));
                const mtdRevenue = mtdSales.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const mtdProgress = (mtdRevenue / monthlyQuota) * 100;

                // Calculate YTD revenue
                const ytdSales = salesData.filter(s => s.date.startsWith(currentYear));
                const ytdRevenue = ytdSales.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const ytdQuota = monthlyQuota * now.getMonth() + monthlyQuota; // Quota for months passed + current month
                const ytdProgress = (ytdRevenue / ytdQuota) * 100;

                // Render MTD tracking
                document.getElementById('quota-tracking-mtd').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--brand-aqua);">Month to Date</span>
                            <span style="color: var(--brand-gold); font-weight: 600;">
                                $${mtdRevenue.toFixed(0)} / $${monthlyQuota.toFixed(0)}
                            </span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${Math.min(mtdProgress, 100)}%;"></div>
                        </div>
                        <div style="text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--brand-teal);">
                            ${mtdProgress.toFixed(1)}% Complete
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(16, 195, 176, 0.1); border-radius: 8px; font-size: 0.9rem;">
                            ${mtdProgress >= 100 ? 'üéâ Monthly quota achieved!' :
                              `üéØ $${(monthlyQuota - mtdRevenue).toFixed(0)} remaining to hit quota`}
                        </div>
                    </div>
                `;

                // Render YTD tracking
                document.getElementById('quota-tracking-ytd').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--brand-aqua);">Year to Date</span>
                            <span style="color: var(--brand-gold); font-weight: 600;">
                                $${ytdRevenue.toFixed(0)} / $${ytdQuota.toFixed(0)}
                            </span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${Math.min(ytdProgress, 100)}%;"></div>
                        </div>
                        <div style="text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--brand-teal);">
                            ${ytdProgress.toFixed(1)}% Complete
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(244, 176, 58, 0.1); border-radius: 8px; font-size: 0.9rem;">
                            üìä ${mtdSales.length} sales this month ‚Ä¢ ${ytdSales.length} sales YTD
                        </div>
                    </div>
                `;

                // Load smart recommendations after quota tracking is updated
                calculateSmartRecommendations();

            } catch (error) {
                console.error('Error updating quota tracking:', error);
            }
        }

        // Update goal tracking breakdown
        function updateGoalTracking(currentRevenue = 0) {
            const annualGoal = parseFloat(document.getElementById('annual-goal').value) || 120000;
            const monthlyGoal = annualGoal / 12;
            const weeklyGoal = annualGoal / 52;

            // Calculate progress
            const yearProgress = (currentRevenue / annualGoal) * 100;

            // Get current month and week revenue
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            // Calculate monthly and weekly revenue (simplified - using YTD for now)
            const monthProgress = Math.min((currentRevenue / monthlyGoal) * 100, 100);
            const weekProgress = Math.min((currentRevenue / weeklyGoal) * 100, 100);

            document.getElementById('goal-breakdown').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem;">Annual Progress</span>
                        <span style="color: var(--brand-gold); font-weight: 600;">$${currentRevenue.toFixed(0)} / $${annualGoal.toFixed(0)}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: ${Math.min(yearProgress, 100)}%;"></div>
                    </div>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--brand-teal);">
                        ${yearProgress.toFixed(1)}% Complete
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-box">
                        <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-teal);">
                            $${monthlyGoal.toFixed(0)}
                        </div>
                        <div class="stat-label">Monthly Target</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-aqua);">
                            $${weeklyGoal.toFixed(0)}
                        </div>
                        <div class="stat-label">Weekly Target</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(16, 195, 176, 0.1); border-radius: 10px;">
                    <div style="font-size: 0.85rem; color: var(--light-text); opacity: 0.8; margin-bottom: 8px;">
                        To hit your annual goal of $${annualGoal.toFixed(0)}:
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        üí∞ Close <strong style="color: var(--brand-gold);">${Math.ceil(annualGoal / 5000)}</strong> deals at $5,000 each<br>
                        üìÖ Average <strong style="color: var(--brand-teal);">${Math.ceil(monthlyGoal / 5000)}</strong> deals per month<br>
                        üìä Need <strong style="color: var(--brand-aqua);">${(weeklyGoal / 5000).toFixed(1)}</strong> deals per week
                    </div>
                </div>
            `;
        }

        // Calculate smart activity recommendations based on historical conversion rates
        async function calculateSmartRecommendations() {
            try {
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7);
                const currentYear = now.getFullYear().toString();

                // Fetch historical data
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (dailyError) throw dailyError;

                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .gte('date', `${currentYear}-01-01`);

                if (salesError) throw salesError;

                // Calculate historical conversion rates
                const totalDials = dailyData.reduce((sum, d) => sum + (d.dials || 0), 0);
                const totalConversations = dailyData.reduce((sum, d) => sum + (d.conversations || 0), 0);
                const totalMeetings = dailyData.reduce((sum, d) => sum + (d.discovery_meetings || 0), 0);
                const totalSales = salesData.length;

                // Calculate conversion rates (with minimum data validation)
                // Ensure we never divide by zero - use defaults if insufficient data
                let dialToConvRate = 0.25; // default 25%
                if (totalDials > 0 && totalConversations > 0) {
                    dialToConvRate = Math.max(totalConversations / totalDials, 0.05); // minimum 5%
                }

                let convToMeetingRate = 0.30; // default 30%
                if (totalConversations > 0 && totalMeetings > 0) {
                    convToMeetingRate = Math.max(totalMeetings / totalConversations, 0.05); // minimum 5%
                }

                let meetingToSaleRate = 0.25; // default 25%
                if (totalMeetings > 0 && totalSales > 0) {
                    meetingToSaleRate = Math.max(totalSales / totalMeetings, 0.05); // minimum 5%
                }

                // Get monthly quota and calculate average sale value
                const monthlyQuota = parseFloat(document.getElementById('monthly-quota').value) || 10000;
                const avgSaleValue = totalSales > 0 ? salesData.reduce((sum, s) => sum + parseFloat(s.amount_cad), 0) / totalSales : 5000;

                // Calculate MTD sales
                const mtdSales = salesData.filter(s => s.date.startsWith(currentMonth));
                const mtdRevenue = mtdSales.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const remainingQuota = monthlyQuota - mtdRevenue;

                // Calculate days remaining in month
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const daysRemaining = daysInMonth - now.getDate() + 1;

                // Calculate what's needed
                const salesNeeded = Math.ceil(remainingQuota / avgSaleValue);
                const meetingsNeeded = Math.ceil(salesNeeded / meetingToSaleRate);
                const conversationsNeeded = Math.ceil(meetingsNeeded / convToMeetingRate);
                const dialsNeeded = Math.ceil(conversationsNeeded / dialToConvRate);

                // Calculate daily requirements
                const dailySalesNeeded = (salesNeeded / daysRemaining).toFixed(1);
                const dailyMeetingsNeeded = Math.ceil(meetingsNeeded / daysRemaining);
                const dailyConversationsNeeded = Math.ceil(conversationsNeeded / daysRemaining);
                const dailyDialsNeeded = Math.ceil(dialsNeeded / daysRemaining);

                // Render recommendations
                const container = document.getElementById('smart-recommendations');

                if (remainingQuota <= 0) {
                    container.innerHTML = `
                        <div style="padding: 20px; background: linear-gradient(135deg, rgba(16, 195, 176, 0.2), rgba(61, 224, 210, 0.1)); border-radius: 12px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
                            <h3 style="color: var(--brand-gold); font-size: 1.5rem; margin-bottom: 10px;">Monthly Quota Achieved!</h3>
                            <p style="opacity: 0.9;">You've hit your monthly sales quota of $${monthlyQuota.toFixed(0)}. Keep up the great work!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(244, 176, 58, 0.2), rgba(249, 200, 99, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--brand-gold); font-size: 1.2rem; margin-bottom: 15px;">üìä Your Historical Conversion Rates</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-teal);">
                                    ${(dialToConvRate * 100).toFixed(1)}%
                                </div>
                                <div class="stat-label">Dial ‚Üí Conversation</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-aqua);">
                                    ${(convToMeetingRate * 100).toFixed(1)}%
                                </div>
                                <div class="stat-label">Conversation ‚Üí Meeting</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-gold);">
                                    ${(meetingToSaleRate * 100).toFixed(1)}%
                                </div>
                                <div class="stat-label">Meeting ‚Üí Sale</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" style="font-size: 1.3rem; color: var(--brand-pink);">
                                    $${avgSaleValue.toFixed(0)}
                                </div>
                                <div class="stat-label">Avg Sale Value</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(16, 195, 176, 0.2), rgba(61, 224, 210, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--brand-aqua); font-size: 1.2rem; margin-bottom: 15px;">üéØ To Hit Your Monthly Quota</h3>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 8px;">
                                You need $${remainingQuota.toFixed(0)} more in the next ${daysRemaining} days
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--brand-gold); font-size: 1.1rem;">Total Activities Needed (Rest of Month):</strong>
                            <div class="stats-grid" style="margin-top: 10px;">
                                <div class="stat-box">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--brand-teal);">
                                        ${dialsNeeded}
                                    </div>
                                    <div class="stat-label">Dials Needed</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--brand-aqua);">
                                        ${conversationsNeeded}
                                    </div>
                                    <div class="stat-label">Conversations Needed</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--brand-gold);">
                                        ${meetingsNeeded}
                                    </div>
                                    <div class="stat-label">Meetings Needed</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--brand-pink);">
                                        ${salesNeeded}
                                    </div>
                                    <div class="stat-label">Sales Needed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(230, 69, 99, 0.2), rgba(244, 176, 58, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid var(--brand-pink);">
                        <h3 style="color: var(--brand-pink); font-size: 1.3rem; margin-bottom: 15px;">üöÄ YOUR DAILY ACTION PLAN</h3>
                        <p style="margin-bottom: 15px; font-size: 1.05rem; opacity: 0.9;">
                            Based on your conversion rates, here's what you need to do EVERY DAY for the next ${daysRemaining} days:
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; border: 2px solid var(--brand-teal);">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--brand-teal);">
                                    ${dailyDialsNeeded}
                                </div>
                                <div style="font-size: 0.9rem; margin-top: 5px;">Dials/Day</div>
                            </div>
                            <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; border: 2px solid var(--brand-aqua);">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--brand-aqua);">
                                    ${dailyConversationsNeeded}
                                </div>
                                <div style="font-size: 0.9rem; margin-top: 5px;">Conversations/Day</div>
                            </div>
                            <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; border: 2px solid var(--brand-gold);">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--brand-gold);">
                                    ${dailyMeetingsNeeded}
                                </div>
                                <div style="font-size: 0.9rem; margin-top: 5px;">Meetings/Day</div>
                            </div>
                            <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; border: 2px solid var(--brand-pink);">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--brand-pink);">
                                    ${dailySalesNeeded}
                                </div>
                                <div style="font-size: 0.9rem; margin-top: 5px;">Sales/Day</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(244, 176, 58, 0.2); border-radius: 8px; font-size: 0.95rem; line-height: 1.6;">
                            üí° <strong>Pro Tip:</strong> These numbers are based on YOUR actual historical conversion rates. As you track more data, these recommendations will become even more accurate!
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error calculating recommendations:', error);
                document.getElementById('smart-recommendations').innerHTML = `
                    <p style="opacity: 0.7;">Start tracking your daily activities to see personalized recommendations based on your conversion rates!</p>
                `;
            }
        }

        // Load weekly performance chart
        let weeklyChart = null;
        async function loadWeeklyChart() {
            try {
                const { data, error } = await supabaseClient
                    .from('Weekly_Performance')
                    .select('*')
                    .order('week_start', { ascending: true })
                    .limit(8);

                if (error) throw error;

                const labels = data.map(week => {
                    const date = new Date(week.week_start);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });

                const dialData = data.map(week => week.total_dials || 0);
                const conversationData = data.map(week => week.total_conversations || 0);
                const meetingData = data.map(week => week.total_meetings || 0);

                const ctx = document.getElementById('weekly-chart').getContext('2d');

                if (weeklyChart) {
                    weeklyChart.destroy();
                }

                weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Dials',
                                data: dialData,
                                borderColor: '#10C3B0',
                                backgroundColor: 'rgba(16, 195, 176, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Conversations',
                                data: conversationData,
                                borderColor: '#F4B03A',
                                backgroundColor: 'rgba(244, 176, 58, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Meetings',
                                data: meetingData,
                                borderColor: '#E64563',
                                backgroundColor: 'rgba(230, 69, 99, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#F2F4F8'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#F2F4F8'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#F2F4F8'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        // ============================================
        // AI COACHING SYSTEM (RAG-like insights)
        // ============================================

        async function loadCoachingInsights() {
            try {
                const { data, error } = await supabaseClient
                    .from('Coaching_Insights')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const container = document.getElementById('coaching-insights');

                if (data.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7;">No insights yet. Click "Refresh Insights" to generate coaching.</p>';
                    return;
                }

                container.innerHTML = data.map(insight => `
                    <div class="coaching-card priority-${insight.priority}">
                        <div class="coaching-title">${insight.title}</div>
                        <div class="coaching-content">${insight.content}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading insights:', error);
                document.getElementById('coaching-insights').innerHTML = '<p style="color: var(--brand-pink);">Unable to load insights.</p>';
            }
        }

        async function generateCoachingInsights() {
            showAlert('Generating AI coaching insights...', 'success');

            try {
                // Fetch recent performance data
                const { data: dailyData, error: dailyError } = await supabaseClient
                    .from('Daily_Tracker')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(30);

                if (dailyError) throw dailyError;

                const { data: salesData, error: salesError } = await supabaseClient
                    .from('Sales')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(30);

                if (salesError) throw salesError;

                // Generate insights based on patterns
                const insights = analyzePerformance(dailyData, salesData);

                // Save insights to database
                for (const insight of insights) {
                    await supabaseClient.from('Coaching_Insights').insert({
                        user_id: currentUser.id,
                        date: new Date().toISOString().split('T')[0],
                        insight_type: insight.type,
                        title: insight.title,
                        content: insight.content,
                        priority: insight.priority
                    });
                }

                // Reload insights display
                await loadCoachingInsights();
                showAlert('Coaching insights generated!', 'success');
                celebrateWithConfetti('default');
            } catch (error) {
                console.error('Error generating insights:', error);
                showAlert('Failed to generate insights.', 'error');
            }
        }

        // Analyze performance and generate insights with SELECTED SALES METHODOLOGY
        function analyzePerformance(dailyData, salesData) {
            const insights = [];
            const today = new Date().toISOString().split('T')[0];
            const methodologyInfo = getMethodologyInfo();
            const methodologyName = methodologyInfo.name;

            if (dailyData.length === 0) {
                insights.push({
                    type: 'alert',
                    title: 'üöÄ Get Started with Your Sales Tracking',
                    content: `Start tracking your daily activities to unlock ${methodologyName}-based coaching insights. Remember: Success in sales = Activity √ó Effectiveness. Log your dials, conversations, and meetings.`,
                    priority: 'high'
                });
                return insights;
            }

            // Calculate metrics
            const totalDials = dailyData.reduce((sum, day) => sum + (day.dials || 0), 0);
            const totalConversations = dailyData.reduce((sum, day) => sum + (day.conversations || 0), 0);
            const totalMeetings = dailyData.reduce((sum, day) => sum + (day.discovery_meetings || 0), 0);
            const avgDials = totalDials / dailyData.length;
            const conversionRate = totalDials > 0 ? (totalConversations / totalDials) * 100 : 0;
            const meetingRate = totalConversations > 0 ? (totalMeetings / totalConversations) * 100 : 0;
            const closeRate = totalMeetings > 0 ? (salesData.length / totalMeetings) * 100 : 0;

            // INSIGHT 1: Daily Activity - Consistency & Volume (SELF-DIRECTED ACTIONS)
            if (avgDials < 10) {
                insights.push({
                    type: 'suggestion',
                    title: 'üìû Your Next Action: Increase Daily Dials',
                    content: `Current average: ${avgDials.toFixed(1)} dials/day. **ACTION PLAN:** (1) Block 9-11am daily for prospecting - treat it like a client meeting. (2) Set a daily goal of 20 dials minimum. (3) Use this script to start: "Hi [Name], this is [You] with [Company]. I know I'm catching you cold - do you have 30 seconds?" Sales principle: Control your behaviors, not outcomes.`,
                    priority: 'high'
                });
            } else if (avgDials >= 20) {
                insights.push({
                    type: 'milestone',
                    title: 'üåü Winning Behavior: High Activity Level',
                    content: `You're crushing it with ${avgDials.toFixed(1)} dials/day! **KEEP DOING:** Maintain this daily prospecting block. Your consistent activity is building momentum. Success = Activity √ó Effectiveness. Now focus on improving conversion rates.`,
                    priority: 'low'
                });
            }

            // INSIGHT 2: Dial to Conversation Conversion (SPECIFIC SCRIPTS)
            if (conversionRate < 15 && totalDials >= 20) {
                insights.push({
                    type: 'performance',
                    title: 'ü§ù Your Script: Boost Conversation Rate',
                    content: `Current rate: ${conversionRate.toFixed(1)}%. **USE THIS OPENER:** "Hi [Name], [You] with [Company]. I know I'm catching you cold - do you have 30 seconds? ...Great! I'm calling because [specific reason]. I'm not even sure if we're a fit, but would it make sense to spend 10 minutes exploring that?" **KEY:** Remove pressure. People trust low-pressure reps.`,
                    priority: 'high'
                });
            } else if (conversionRate >= 25) {
                insights.push({
                    type: 'milestone',
                    title: 'üéØ Winning Behavior: Strong Rapport Building',
                    content: `Your ${conversionRate.toFixed(1)}% conversation rate is excellent! **KEEP DOING:** Your opening approach is working. Continue with curiosity-based questions and no-pressure language. This is building trust fast.`,
                    priority: 'low'
                });
            }

            // INSIGHT 3: Conversation to Meeting Conversion (CLEAR CTA SCRIPT)
            if (meetingRate < 20 && totalConversations >= 10) {
                insights.push({
                    type: 'suggestion',
                    title: 'üìã Your Script: Book More Meetings',
                    content: `Current rate: ${meetingRate.toFixed(1)}%. **SAY THIS EXACTLY:** "Would it make sense to schedule 15 minutes to explore if we're a fit? At the end, you can tell me 'yes,' 'no,' or 'let's talk again.' Fair enough?" **THEN:** Stay silent. Let them respond. **ACTION:** Use this on your next 5 calls and track results.`,
                    priority: 'high'
                });
            } else if (meetingRate >= 30) {
                insights.push({
                    type: 'milestone',
                    title: 'üìã Winning Behavior: Strong Meeting Conversion',
                    content: `${meetingRate.toFixed(1)}% meeting conversion is excellent! **KEEP DOING:** Your clear expectations approach is working. Prospects appreciate the transparency and it builds trust. Continue this exact pattern.`,
                    priority: 'low'
                });
            }

            // INSIGHT 4: Revenue Performance & Discovery
            if (salesData.length > 0) {
                const totalRevenue = salesData.reduce((sum, sale) => sum + parseFloat(sale.amount_cad), 0);
                const avgSale = totalRevenue / salesData.length;

                insights.push({
                    type: 'performance',
                    title: 'üí∞ Revenue Performance',
                    content: `You've closed ${salesData.length} sales (${closeRate.toFixed(1)}% close rate) with average value of $${avgSale.toFixed(2)} CAD. Total: $${totalRevenue.toFixed(2)} CAD. Remember: "No pain, no change." Keep using deep discovery to uncover compelling reasons to buy.`,
                    priority: 'low'
                });

                // Close rate coaching (DEEP DISCOVERY QUESTIONS)
                if (closeRate < 25 && totalMeetings >= 5) {
                    insights.push({
                        type: 'suggestion',
                        title: 'üîç Your Discovery Questions: Uncover Real Pain',
                        content: `Current close rate: ${closeRate.toFixed(1)}%. **ASK THESE IN EVERY DISCOVERY:** (1) "Tell me more about that problem..." [stay silent] (2) "How long has this been an issue?" (3) "What have you already tried?" (4) "What's this costing you monthly?" (5) "What happens if you don't fix it in the next 90 days?" **GOAL:** Get them saying the problem is urgent and expensive. Surface-level needs don't close. Compelling pain does.`,
                        priority: 'high'
                    });
                } else if (closeRate >= 40) {
                    insights.push({
                        type: 'milestone',
                        title: 'üéØ Winning Behavior: Excellent Qualification',
                        content: `Your ${closeRate.toFixed(1)}% close rate is outstanding! **KEEP DOING:** You're digging deep to uncover compelling pain. You're qualifying hard and only moving forward with real opportunities. This discipline is why you're closing more deals.`,
                        priority: 'low'
                    });
                }
            }

            // INSIGHT 5: Budget & Decision Process Qualification (EXACT QUESTIONS)
            if (totalMeetings >= 5 && salesData.length === 0) {
                insights.push({
                    type: 'alert',
                    title: 'üíµ Your Budget Questions: Qualify Faster',
                    content: `${totalMeetings} meetings, zero sales. You're meeting with tire-kickers. **ASK THESE IN FIRST CALL:** (1) "If this makes sense, what kind of budget have you allocated for this?" (2) "Who else besides you will be involved in making this decision?" (3) "Walk me through your typical buying process." **RULE:** No budget discussion = no second meeting. Disqualify fast. Your time is valuable.`,
                    priority: 'high'
                });
            }

            // INSIGHT 6: Activity Consistency & Daily Discipline (CALENDAR BLOCKING)
            const activeDays = dailyData.filter(day => (day.dials || 0) > 0).length;
            const consistencyRate = (activeDays / dailyData.length) * 100;

            if (consistencyRate < 70) {
                insights.push({
                    type: 'alert',
                    title: 'üìÖ Your Action Plan: Build Daily Consistency',
                    content: `Active ${activeDays} of ${dailyData.length} days (${consistencyRate.toFixed(0)}%). **DO THIS NOW:** (1) Open your calendar. (2) Block 9-11am EVERY day for prospecting - label it "Prospecting - DO NOT MOVE". (3) Turn off Slack/email during this time. (4) Set a daily alarm at 8:55am. **COMMITMENT:** Protect this block like a CEO meeting. Consistency compounds. Miss a day = start over.`,
                    priority: 'high'
                });
            } else if (consistencyRate >= 85) {
                insights.push({
                    type: 'milestone',
                    title: 'üìñ Winning Behavior: Elite Daily Discipline',
                    content: `${consistencyRate.toFixed(0)}% consistency is elite! **KEEP DOING:** Your daily prospecting block is working. You're treating sales as a predictable system. This discipline is the foundation of all your success. Don't break the streak.`,
                    priority: 'low'
                });
            }

            // INSIGHT 7: Remove Sales Pressure (NO-PRESSURE SCRIPT)
            if (totalConversations >= 10 && conversionRate < 20) {
                insights.push({
                    type: 'suggestion',
                    title: 'üîÑ Your Script: Remove Sales Pressure',
                    content: `Low conversion. **USE THIS EXACT PHRASE:** "I'm not sure if what we do is even a fit for you, but would it make sense to spend 10 minutes finding out? Worst case, we'll both know it's not a match. Fair enough?" **WHY THIS WORKS:** Removes "sales pressure." Makes prospects relax. Paradoxically INCREASES interest. **ACTION:** Say this verbatim on your next 10 calls.`,
                    priority: 'medium'
                });
            }

            return insights;
        }

        // ============================================
        // SANDLER CONVERSATION ANALYSIS
        // ============================================

        async function analyzeConversation() {
            const title = document.getElementById('conversation-title').value.trim();
            const type = document.getElementById('conversation-type').value;
            const audioFile = document.getElementById('audio-upload').files[0];
            const transcript = document.getElementById('transcript-input').value.trim();

            if (!title) {
                showAlert('Please enter a conversation title.', 'error');
                return;
            }

            if (!transcript && !audioFile) {
                showAlert('Please upload an audio file or paste a transcript.', 'error');
                return;
            }

            const methodologyInfo = getMethodologyInfo();
            showAlert(`üéØ Analyzing conversation with ${methodologyInfo.name}...`, 'success');

            try {
                let finalTranscript = transcript;

                // If audio file uploaded, transcribe it first
                if (audioFile && !transcript) {
                    showAlert('üéôÔ∏è Transcribing audio with Whisper...', 'success');

                    try {
                        // Create form data for audio file
                        const formData = new FormData();
                        formData.append('audio', audioFile);

                        // Call transcribe-audio Edge Function
                        const { data: transcriptionData, error: transcriptionError } = await supabaseClient.functions.invoke('transcribe-audio', {
                            body: formData
                        });

                        if (transcriptionError) {
                            throw new Error(transcriptionError.message || 'Failed to transcribe audio');
                        }

                        if (!transcriptionData || !transcriptionData.transcript) {
                            throw new Error('No transcript returned from transcription service');
                        }

                        finalTranscript = transcriptionData.transcript;
                        showAlert(`‚úÖ Audio transcribed successfully! Now analyzing with ${methodologyInfo.name}...`, 'success');

                        // Show the transcript to the user
                        document.getElementById('transcript-input').value = finalTranscript;

                    } catch (transcriptionError) {
                        console.error('Transcription error:', transcriptionError);
                        showAlert(`Transcription failed: ${transcriptionError.message}. Please paste transcript manually.`, 'error');
                        return;
                    }
                }

                // Analyze transcript with selected methodology
                const methodology = getMethodology();
                const analysis = await analyzeSalesConversation(finalTranscript, type, methodology);

                // If no analysis (API key not configured), return early
                if (!analysis) {
                    return;
                }

                // Save to database
                const { data, error } = await supabaseClient
                    .from('Conversation_Analyses')
                    .insert({
                        user_id: currentUser.id,
                        date: new Date().toISOString().split('T')[0],
                        conversation_title: title,
                        conversation_type: type,
                        transcript: finalTranscript,
                        overall_sandler_score: analysis.overall_score,
                        upfront_contract_score: analysis.upfront_contract_score,
                        pain_funnel_score: analysis.pain_funnel_score,
                        budget_discussion_score: analysis.budget_discussion_score,
                        decision_process_score: analysis.decision_process_score,
                        bonding_rapport_score: analysis.bonding_rapport_score,
                        talk_listen_ratio_score: analysis.talk_ratio_score,
                        what_went_well: analysis.what_went_well,
                        areas_to_improve: analysis.areas_to_improve,
                        specific_recommendations: analysis.recommendations,
                        talk_percentage: analysis.talk_percentage,
                        question_count: analysis.question_count,
                        pain_identified: analysis.pain_identified,
                        budget_discussed: analysis.budget_discussed,
                        decision_makers_identified: analysis.decision_makers_identified,
                        upfront_contract_set: analysis.upfront_contract_set,
                        negative_reverse_used: analysis.negative_reverse_used,
                        full_analysis_json: analysis
                    });

                if (error) throw error;

                // Display results
                displayAnalysisResults(analysis);

                // Celebrate with confetti!
                celebrateWithConfetti('default');

                showAlert('‚úÖ Conversation analyzed successfully!', 'success');

                // Clear inputs
                document.getElementById('conversation-title').value = '';
                document.getElementById('transcript-input').value = '';
                document.getElementById('audio-upload').value = '';

                // Reload history
                loadConversationHistory();

            } catch (error) {
                console.error('Error analyzing conversation:', error);
                showAlert('Failed to analyze conversation. Check console for details.', 'error');
            }
        }

        // Analyze conversation using selected sales methodology (with VERIFICATION)
        async function analyzeSalesConversation(transcript, callType, methodology = null) {
            // Get user's selected methodology if not provided
            if (!methodology) {
                methodology = getMethodology();
            }
            const methodologyInfo = METHODOLOGIES[methodology] || METHODOLOGIES['meddic'];
            // Use secure Supabase Edge Function (required for production)
            // API keys are stored securely on the server, never exposed to the client
            try {
                const scripts = getScripts(); // Get user's custom scripts

                const { data, error } = await supabaseClient.functions.invoke('analyze-conversation', {
                    body: { transcript, callType, methodology, scripts }
                });

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Edge Function Error:', error);
                showAlert(`AI Analysis failed: ${error.message}. Make sure the Supabase Edge Function is deployed.`, 'error');
                return null;
            }
        }

        // Display analysis results with beautiful coaching cards
        function displayAnalysisResults(analysis) {
            const container = document.getElementById('conversation-analysis-result');
            const methodologyInfo = getMethodologyInfo();
            const methodologyName = methodologyInfo.name;

            // Build tactical scripts sections
            let tacticalScriptsHTML = '';
            if (analysis.tactical_scripts) {
                const scripts = analysis.tactical_scripts;

                tacticalScriptsHTML = `
                    <h3 style="color: var(--brand-gold); font-size: 1.3rem; margin: 30px 0 15px 0;">
                        üìã Your Tactical Playbook
                    </h3>

                    ${scripts.opening_alternatives ? `
                    <div class="coaching-card priority-medium" style="margin-bottom: 15px;">
                        <div class="coaching-title">üéØ Opening Script Alternatives</div>
                        <div class="coaching-content">
                            <ol style="margin-left: 20px;">
                                ${scripts.opening_alternatives.map(script => `<li style="margin-bottom: 10px;"><strong>"${script}"</strong></li>`).join('')}
                            </ol>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.upfront_contract ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üìù Up-Front Contract Script</div>
                        <div class="coaching-content">
                            <p style="font-size: 1.05rem; line-height: 1.6;"><strong>"${scripts.upfront_contract}"</strong></p>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.pain_funnel_sequence ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üíé Pain Funnel Question Sequence</div>
                        <div class="coaching-content">
                            <p style="margin-bottom: 10px; opacity: 0.9;">Ask these questions in order, and after each answer say: "Tell me more about that"</p>
                            <ol style="margin-left: 20px;">
                                ${scripts.pain_funnel_sequence.map(q => `<li style="margin-bottom: 8px;">${q}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.budget_discussion ? `
                    <div class="coaching-card priority-medium" style="margin-bottom: 15px;">
                        <div class="coaching-title">üí∞ Budget Discussion Script</div>
                        <div class="coaching-content">
                            <p style="font-size: 1.05rem; line-height: 1.6;"><strong>"${scripts.budget_discussion}"</strong></p>
                        </div>
                    </div>
                    ` : ''}

                    ${scripts.objection_responses ? `
                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">üõ°Ô∏è Objection Handling Scripts</div>
                        <div class="coaching-content">
                            ${Object.entries(scripts.objection_responses).map(([objection, response]) => `
                                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <p style="color: var(--brand-pink); margin-bottom: 8px;"><strong>When they say:</strong> "${objection}"</p>
                                    <p style="color: var(--brand-teal);"><strong>You respond:</strong> "${response}"</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
            }

            // Build role-play examples
            let rolePlayHTML = '';
            if (analysis.role_play_examples && analysis.role_play_examples.length > 0) {
                rolePlayHTML = `
                    <div class="coaching-card priority-low" style="margin-bottom: 15px;">
                        <div class="coaching-title">üé≠ Role-Play Practice Scenarios</div>
                        <div class="coaching-content">
                            ${analysis.role_play_examples.map((example, i) => `
                                <div style="margin-bottom: 15px; padding: 12px; background: rgba(16, 195, 176, 0.1); border-radius: 8px;">
                                    <strong style="color: var(--brand-aqua);">Scenario ${i + 1}:</strong>
                                    <p style="margin-top: 8px; line-height: 1.6; white-space: pre-line;">${example}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Build next call playbook
            let nextCallHTML = '';
            if (analysis.next_call_playbook && analysis.next_call_playbook.length > 0) {
                nextCallHTML = `
                    <div class="coaching-card priority-high" style="border: 2px solid var(--brand-gold);">
                        <div class="coaching-title">üöÄ Your Next Call Playbook - USE THESE!</div>
                        <div class="coaching-content">
                            <ol style="margin-left: 20px;">
                                ${analysis.next_call_playbook.map(script => `
                                    <li style="margin-bottom: 12px; font-size: 1.05rem; line-height: 1.6;">${script}</li>
                                `).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(16, 195, 176, 0.2), rgba(61, 224, 210, 0.1)); padding: 25px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="color: var(--brand-aqua); font-size: 1.5rem; margin-bottom: 15px;">
                        üéØ ${methodologyName} Execution Score: ${analysis.overall_score}/10
                    </h3>

                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.upfront_contract_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.upfront_contract_score}/10
                            </div>
                            <div class="stat-label">Up-Front Contract</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.pain_funnel_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.pain_funnel_score}/10
                            </div>
                            <div class="stat-label">Pain Funnel</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.budget_discussion_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.budget_discussion_score}/10
                            </div>
                            <div class="stat-label">Budget Discussion</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: ${analysis.bonding_rapport_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-pink)'};">
                                ${analysis.bonding_rapport_score}/10
                            </div>
                            <div class="stat-label">Bonding & Rapport</div>
                        </div>
                    </div>

                    <p style="margin-bottom: 20px; opacity: 0.8; font-size: 0.95rem;">
                        <strong>Talk/Listen Ratio:</strong> You talked ${analysis.talk_percentage}% of the time.
                        ${analysis.talk_percentage > 40 ? '‚ö†Ô∏è Target is 30%. Practice asking more questions and listening.' : '‚úÖ Good balance!'}
                    </p>

                    <div class="coaching-card priority-low" style="margin-bottom: 15px;">
                        <div class="coaching-title">‚úÖ What You Did Well</div>
                        <div class="coaching-content">
                            <ul style="margin-left: 20px;">
                                ${analysis.what_went_well.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="coaching-card priority-high" style="margin-bottom: 15px;">
                        <div class="coaching-title">‚ö†Ô∏è Areas to Improve</div>
                        <div class="coaching-content">
                            <ul style="margin-left: 20px;">
                                ${analysis.areas_to_improve.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    ${tacticalScriptsHTML}

                    ${rolePlayHTML}

                    ${nextCallHTML}
                </div>
            `;
        }

        // Load conversation history
        async function loadConversationHistory() {
            try {
                const { data, error } = await supabaseClient
                    .from('Conversation_Analyses')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(10);

                if (error) {
                    // Check if table doesn't exist (common for new users)
                    if (error.message && error.message.includes('does not exist')) {
                        document.getElementById('conversation-history').innerHTML = '<p style="opacity: 0.7;">Conversation analysis feature coming soon! This will analyze your sales calls using your chosen methodology.</p>';
                        return;
                    }
                    throw error;
                }

                const container = document.getElementById('conversation-history');

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7;">No conversations analyzed yet. Upload your first call above!</p>';
                    return;
                }

                container.innerHTML = data.map(conv => `
                    <div class="history-item" style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; align-items: center;">
                        <div style="font-size: 2rem;">${conv.overall_sandler_score >= 8 ? 'üåü' : conv.overall_sandler_score >= 6 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div>
                            <strong style="color: var(--brand-aqua);">${conv.conversation_title}</strong><br>
                            <span style="opacity: 0.7; font-size: 0.85rem;">${conv.conversation_type.replace('_', ' ')} ‚Ä¢ ${conv.date}</span>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${conv.overall_sandler_score >= 7 ? 'var(--brand-teal)' : 'var(--brand-gold)'};">
                                ${conv.overall_sandler_score}/10
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Score</div>
                        </div>
                        <button class="btn-secondary" style="width: auto; margin: 0; padding: 8px 16px;" onclick="viewConversationDetails('${conv.id}')">
                            View Details
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading conversation history:', error);
                document.getElementById('conversation-history').innerHTML = '<p style="opacity: 0.7;">No conversation data available yet.</p>';
            }
        }

        // View conversation details (placeholder)
        function viewConversationDetails(id) {
            showAlert('Conversation details view coming soon!', 'success');
            // TODO: Implement detailed view with full transcript and analysis
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // HTML sanitization to prevent XSS attacks
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) {
                return '';
            }
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Safely set text content (prevents XSS)
        function setTextContent(element, text) {
            if (element && element.textContent !== undefined) {
                element.textContent = text;
            }
        }

        // Safely set HTML content (sanitizes input)
        function setSafeHTML(element, html) {
            if (element) {
                element.innerHTML = escapeHtml(html);
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ============================================
        // SETUP SECTION TOGGLE
        // ============================================

        function toggleSetup() {
            const setupSection = document.getElementById('setup-section');
            const toggleBtn = document.getElementById('setup-toggle-btn');
            const isHidden = setupSection.style.display === 'none';

            if (isHidden) {
                setupSection.style.display = 'contents';
                toggleBtn.textContent = 'Hide Setup';
                localStorage.setItem('setupVisible', 'true');
            } else {
                setupSection.style.display = 'none';
                toggleBtn.textContent = 'Show Setup';
                localStorage.setItem('setupVisible', 'false');
            }
        }

        // Load setup visibility state on page load
        function loadSetupState() {
            const setupVisible = localStorage.getItem('setupVisible');
            const setupSection = document.getElementById('setup-section');
            const toggleBtn = document.getElementById('setup-toggle-btn');

            // Default to visible if no preference stored, or if explicitly set to visible
            if (setupVisible === 'false') {
                setupSection.style.display = 'none';
                toggleBtn.textContent = 'Show Setup';
            } else {
                // Show setup by default
                setupSection.style.display = 'contents';
                toggleBtn.textContent = 'Hide Setup';
                localStorage.setItem('setupVisible', 'true');
            }
        }

        // ============================================
        // ICP (IDEAL CUSTOMER PROFILE) FUNCTIONS
        // ============================================

        function saveICP() {
            const icp = {
                industry: document.getElementById('icp-industry').value.trim(),
                companySize: document.getElementById('icp-company-size').value.trim(),
                jobTitles: document.getElementById('icp-job-titles').value.trim(),
                characteristics: document.getElementById('icp-characteristics').value.trim(),
                painPoints: document.getElementById('icp-pain-points').value.trim(),
                budget: document.getElementById('icp-budget').value.trim()
            };

            if (!icp.industry && !icp.companySize && !icp.jobTitles) {
                showAlert('Please fill in at least Industry, Company Size, or Job Titles', 'error');
                return;
            }

            localStorage.setItem('icp', JSON.stringify(icp));
            showAlert('‚úÖ Ideal Customer Profile saved!', 'success');
            celebrateWithConfetti('default');
            displayICP();
        }

        function loadICP() {
            const saved = localStorage.getItem('icp');
            if (saved) {
                const icp = JSON.parse(saved);
                document.getElementById('icp-industry').value = icp.industry || '';
                document.getElementById('icp-company-size').value = icp.companySize || '';
                document.getElementById('icp-job-titles').value = icp.jobTitles || '';
                document.getElementById('icp-characteristics').value = icp.characteristics || '';
                document.getElementById('icp-pain-points').value = icp.painPoints || '';
                document.getElementById('icp-budget').value = icp.budget || '';
                displayICP();
            }
        }

        function displayICP() {
            const saved = localStorage.getItem('icp');
            if (!saved) return;

            const icp = JSON.parse(saved);
            const display = document.getElementById('icp-display');
            const summary = document.getElementById('icp-summary');

            let html = '';
            if (icp.industry) html += `<strong>Industry:</strong> ${icp.industry}<br>`;
            if (icp.companySize) html += `<strong>Company Size:</strong> ${icp.companySize}<br>`;
            if (icp.jobTitles) html += `<strong>Target Titles:</strong> ${icp.jobTitles}<br>`;
            if (icp.characteristics) html += `<strong>Characteristics:</strong> ${icp.characteristics}<br>`;
            if (icp.painPoints) html += `<strong>Pain Points:</strong> ${icp.painPoints}<br>`;
            if (icp.budget) html += `<strong>Budget Range:</strong> ${icp.budget}`;

            if (html) {
                summary.innerHTML = html;
                display.style.display = 'block';
            }
        }

        // ============================================
        // SALES SCRIPTS FUNCTIONS
        // ============================================

        async function saveScripts() {
            try {
                // Verify all elements exist
                const elements = {
                    businessDescription: document.getElementById('script-business-description'),
                    icp: document.getElementById('script-icp'),
                    opening: document.getElementById('script-opening'),
                    valueProp: document.getElementById('script-value-prop'),
                    cta: document.getElementById('script-cta'),
                    objections: document.getElementById('script-objections')
                };

                // Check if any elements are missing
                const missingElements = Object.entries(elements)
                    .filter(([key, element]) => !element)
                    .map(([key]) => key);

                if (missingElements.length > 0) {
                    throw new Error(`Missing form elements: ${missingElements.join(', ')}`);
                }

                const scripts = {
                    businessDescription: elements.businessDescription.value.trim(),
                    icp: elements.icp.value.trim(),
                    opening: elements.opening.value.trim(),
                    valueProp: elements.valueProp.value.trim(),
                    cta: elements.cta.value.trim(),
                    objections: elements.objections.value.trim()
                };

                localStorage.setItem('salesScripts', JSON.stringify(scripts));
                showAlert('‚úÖ Scripts saved successfully!', 'success');
                console.log('Scripts saved to localStorage:', scripts);

                // Update the script display in Daily Actions section
                updateScriptDisplay();
            } catch (error) {
                console.error('Error saving scripts:', error);
                showAlert('‚ùå Failed to save scripts: ' + error.message, 'error');
            }
        }

        function loadScripts() {
            const saved = localStorage.getItem('salesScripts');
            if (saved) {
                const scripts = JSON.parse(saved);
                document.getElementById('script-business-description').value = scripts.businessDescription || '';
                document.getElementById('script-icp').value = scripts.icp || '';
                document.getElementById('script-opening').value = scripts.opening || '';
                document.getElementById('script-value-prop').value = scripts.valueProp || '';
                document.getElementById('script-cta').value = scripts.cta || '';
                document.getElementById('script-objections').value = scripts.objections || '';
            }
        }

        function getScripts() {
            const saved = localStorage.getItem('salesScripts');
            if (saved) {
                return JSON.parse(saved);
            }

            // Return default scripts if none saved
            return {
                businessDescription: 'AI Advantage Solutions - helping businesses automate tasks and save time',
                icp: 'Company Size: 50-200 employees, Industry: B2B SaaS, Uses CRM/sales tools, Growing sales team',
                opening: 'Hi [Name], this is John from AI Advantage Solutions here in Hamilton. I know I\'m catching you cold, so I\'ll be brief.',
                valueProp: 'I help mixed-income community providers like [Company] save up to 20 hours per week by automating repetitive tasks‚Äîthings like maintenance requests, tenant communications, and compliance tracking.',
                cta: 'I\'d love to show you how in a quick 15-minute online meeting. Do you have your calendar handy, or would [Date] at [Time] work better?',
                objections: 'I understand. A lot of our clients felt the same way initially. What if I could show you how one client saved 15 hours in their first week?'
            };
        }

        // Update the Cold Call Script display in Daily Actions section
        function updateScriptDisplay() {
            const scripts = getScripts();

            // Update Opening Script
            const openingEl = document.getElementById('display-opening');
            if (openingEl) {
                openingEl.textContent = scripts.opening || 'No opening script saved yet. Add your opening script in the Setup section above.';
            }

            // Update Value Proposition
            const valuePropEl = document.getElementById('display-value-prop');
            if (valuePropEl) {
                valuePropEl.textContent = scripts.valueProp || 'No value proposition saved yet. Add it in the Setup section above.';
            }

            // Update Call to Action
            const ctaEl = document.getElementById('display-cta');
            if (ctaEl) {
                ctaEl.textContent = scripts.cta || 'No call to action saved yet. Add it in the Setup section above.';
            }

            // Update Objection Handling
            const objectionsEl = document.getElementById('display-objections');
            if (objectionsEl) {
                objectionsEl.textContent = scripts.objections || 'No objection handling saved yet. Add it in the Setup section above.';
            }
        }

        async function rewriteScriptsWithAI() {
            try {
                const businessDescriptionEl = document.getElementById('script-business-description');
                const statusDiv = document.getElementById('scripts-rewrite-status');

                if (!businessDescriptionEl) {
                    throw new Error('Business description field not found');
                }

                const businessDescription = businessDescriptionEl.value.trim();

                if (!businessDescription) {
                    showAlert('‚ö†Ô∏è Please enter a business description first', 'error');
                    return;
                }

                if (!statusDiv) {
                    throw new Error('Status display element not found');
                }

                // Show loading state
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div class="loading">‚ú® Claude is rewriting your scripts...</div>';

                // Check if Supabase client is initialized
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized. Using demo mode.');
                }

                // Call Supabase Edge Function to generate scripts
                const { data, error } = await supabaseClient.functions.invoke('generate-scripts', {
                    body: {
                        businessDescription: businessDescription,
                        methodology: getMethodology()
                    }
                });

                if (error) throw error;

                if (data && data.scripts) {
                    // Populate the fields with AI-generated scripts
                    document.getElementById('script-opening').value = data.scripts.opening || '';
                    document.getElementById('script-value-prop').value = data.scripts.valueProp || '';
                    document.getElementById('script-cta').value = data.scripts.cta || '';
                    document.getElementById('script-objections').value = data.scripts.objections || '';

                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ Scripts rewritten successfully! Review and save them below.</div>';
                    celebrateWithConfetti('default');
                    showAlert('‚úÖ Scripts rewritten successfully!', 'success');
                } else {
                    throw new Error('No scripts returned from AI');
                }

            } catch (error) {
                console.error('Script rewriting error:', error);
                const statusDiv = document.getElementById('scripts-rewrite-status');

                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `<div class="alert alert-error">‚ö†Ô∏è AI rewrite unavailable. Using demo templates instead.</div>`;
                }

                showAlert('‚ö†Ô∏è AI rewrite unavailable. Using demo templates instead.', 'error');

                // Fallback: Generate demo scripts locally
                const businessDescription = document.getElementById('script-business-description').value.trim();
                generateDemoScripts(businessDescription);
            }
        }

        function generateDemoScripts(businessDescription) {
            // Demo script generation (basic templating as fallback)
            const opening = `Hi [Name], this is [Your Name] from [Your Company] here in [Location]. I know I'm catching you cold, so I'll be brief.`;
            const valueProp = businessDescription || 'I help [Target Customer] achieve [Specific Benefit] by [Your Solution].';
            const cta = `I'd love to show you how in a quick 15-minute online meeting. Do you have your calendar handy, or would [Day] at [Time] work better?`;
            const objections = `I understand. Many of our clients felt the same way initially. What if we could show you [specific outcome] in the first 30 days‚Äîwould that be worth 15 minutes?`;

            document.getElementById('script-opening').value = opening;
            document.getElementById('script-value-prop').value = valueProp;
            document.getElementById('script-cta').value = cta;
            document.getElementById('script-objections').value = objections;

            showAlert('Demo scripts generated. For AI-powered scripts, deploy the generate-scripts Edge Function.', 'success');
        }

        // ============================================
        // SALES METHODOLOGY FUNCTIONS
        // ============================================

        const METHODOLOGIES = {
            meddic: {
                name: 'MEDDIC/MEDDPICC',
                description: 'Qualify opportunities using Metrics, Economic Buyer, Decision Criteria, Decision Process, Identify Pain, Champion (+ Paper Process, Competition).',
                keyPrinciples: ['Metrics', 'Economic Buyer', 'Decision Criteria', 'Decision Process', 'Identify Pain', 'Champion'],
                coachingPrompt: 'MEDDIC/MEDDPICC methodology'
            },
            challenger: {
                name: 'Challenger Sale',
                description: 'Teach prospects something new, tailor messaging to their situation, and take control of the sale.',
                keyPrinciples: ['Teach for Differentiation', 'Tailor for Resonance', 'Take Control'],
                coachingPrompt: 'Challenger Sale methodology'
            },
            sandler: {
                name: 'Sandler Selling System',
                description: 'Focus on Pain Funnel, Up-Front Contracts, Negative Reverse Selling, and Budget discussions. Talk 30%, listen 70%.',
                keyPrinciples: ['Pain Funnel', 'Up-Front Contract', 'Negative Reverse Selling', 'Budget Before Presentation', 'Decision Before Presentation'],
                coachingPrompt: 'Sandler Selling System methodology'
            },
            spin: {
                name: 'SPIN Selling',
                description: 'Use Situation, Problem, Implication, and Need-Payoff questions to uncover pain and build value.',
                keyPrinciples: ['Situation Questions', 'Problem Questions', 'Implication Questions', 'Need-Payoff Questions'],
                coachingPrompt: 'SPIN Selling methodology'
            },
            gap: {
                name: 'Gap Selling',
                description: 'Focus on the gap between current state and future state. Problem-centric, not product-centric selling.',
                keyPrinciples: ['Current State Analysis', 'Future State Vision', 'Gap Identification', 'Impact of Inaction'],
                coachingPrompt: 'Gap Selling methodology'
            }
        };

        function saveMethodology() {
            const methodology = document.getElementById('sales-methodology').value;
            localStorage.setItem('salesMethodology', methodology);
            displayMethodology();
            showAlert(`‚úÖ Methodology set to ${METHODOLOGIES[methodology].name}`, 'success');
        }

        function loadMethodology() {
            const saved = localStorage.getItem('salesMethodology') || 'meddic';
            document.getElementById('sales-methodology').value = saved;
            displayMethodology();
        }

        function displayMethodology() {
            const methodology = document.getElementById('sales-methodology').value;
            const info = METHODOLOGIES[methodology];
            const container = document.getElementById('methodology-description');

            container.innerHTML = `
                <h3 style="color: var(--brand-gold); font-size: 1rem; margin-bottom: 10px;">${info.name}</h3>
                <p style="margin-bottom: 10px;">${info.description}</p>
                <div style="margin-top: 10px;">
                    <strong>Key Principles:</strong>
                    <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                        ${info.keyPrinciples.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function getMethodology() {
            return localStorage.getItem('salesMethodology') || 'sandler';
        }

        function getMethodologyInfo() {
            const methodology = getMethodology();
            return METHODOLOGIES[methodology];
        }

        // ============================================
        // PRODUCTS/SERVICES FUNCTIONS
        // ============================================

        function addProduct() {
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const description = document.getElementById('product-description').value.trim();

            if (!name || !price || price <= 0) {
                showAlert('Please enter a product name and valid price', 'error');
                return;
            }

            const products = getProducts();
            products.push({
                id: Date.now().toString(),
                name,
                price,
                description
            });

            localStorage.setItem('products', JSON.stringify(products));

            // Clear form
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-description').value = '';

            showAlert('‚úÖ Product added!', 'success');
            celebrateWithConfetti('default');
            loadProducts();
        }

        function getProducts() {
            const saved = localStorage.getItem('products');
            return saved ? JSON.parse(saved) : [];
        }

        function deleteProduct(productId) {
            if (!confirm('Delete this product?')) return;

            let products = getProducts();
            products = products.filter(p => p.id !== productId);
            localStorage.setItem('products', JSON.stringify(products));

            showAlert('Product deleted', 'success');
            loadProducts();
        }

        function loadProducts() {
            const products = getProducts();
            const listContainer = document.getElementById('products-list');
            const productSelect = document.getElementById('input-product');

            // Update products list display
            if (products.length === 0) {
                listContainer.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No products added yet. Add your first product above!</p>';
            } else {
                listContainer.innerHTML = products.map(p => `
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--brand-gold); font-size: 1rem;">${p.name}</div>
                            <div style="font-size: 1.2rem; color: var(--brand-teal); margin: 5px 0;">$${p.price.toFixed(2)}</div>
                            ${p.description ? `<div style="font-size: 0.85rem; opacity: 0.8;">${p.description}</div>` : ''}
                        </div>
                        <button onclick="deleteProduct('${p.id}')" style="background: var(--brand-pink); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
                    </div>
                `).join('');
            }

            // Update product select dropdown in sales form
            productSelect.innerHTML = '<option value="">Select a product...</option>' +
                products.map(p => `<option value="${p.id}">${p.name} - $${p.price.toFixed(2)}</option>`).join('');
        }

        function selectProduct() {
            const productId = document.getElementById('input-product').value;
            if (!productId) return;

            const products = getProducts();
            const product = products.find(p => p.id === productId);

            if (product) {
                document.getElementById('input-amount').value = product.price.toFixed(2);
            }
        }

        // ============================================
        // UPDATE RECORD SALE FUNCTION
        // ============================================

        async function recordSale() {
            const amount = parseFloat(document.getElementById('input-amount').value);
            const client = document.getElementById('input-client').value.trim();
            const productId = document.getElementById('input-product').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter a valid sale amount', 'error');
                return;
            }

            if (!client) {
                showAlert('Please enter client name', 'error');
                return;
            }

            // Get product name
            let productName = 'Custom Sale';
            if (productId) {
                const products = getProducts();
                const product = products.find(p => p.id === productId);
                if (product) productName = product.name;
            }

            try {
                const { error } = await supabaseClient
                    .from('Sales')
                    .insert({
                        user_id: currentUser.id,
                        amount_cad: amount,
                        client_name: client,
                        service_type: productName,
                        date: new Date().toISOString().split('T')[0]
                    });

                if (error) throw error;

                showAlert('‚úÖ Sale recorded successfully!', 'success');

                // Clear form
                document.getElementById('input-amount').value = '';
                document.getElementById('input-client').value = '';
                document.getElementById('input-product').value = '';

                // Refresh revenue data
                loadRevenueSummary();

            } catch (error) {
                console.error('Error recording sale:', error);
                showAlert('‚ö†Ô∏è Error recording sale. Please try again.', 'error');
            }
        }

        // ============================================
        // INITIALIZE DASHBOARD
        // ============================================

        window.addEventListener('DOMContentLoaded', () => {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                showAlert('‚ö†Ô∏è Please configure Supabase credentials in the code.', 'error');
            } else {
                // Load saved settings
                loadActivityGoalsForm();
                loadMethodology();
                loadICP();
                loadProducts();
                loadScripts();
                updateScriptDisplay(); // Display saved scripts in Daily Actions section
                loadSetupState();

                // Load monthly quota from localStorage if exists
                const savedQuota = localStorage.getItem('monthlyQuota');
                if (savedQuota) {
                    document.getElementById('monthly-quota').value = savedQuota;
                }

                // Load dashboard data
                loadDashboardData();
                loadConversationHistory();
            }
        });
    </script>
</body>
</html>
