<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrations - Sandler Revenue Factory</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .integration-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .integration-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .integration-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .integration-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .integration-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .integration-icon.hubspot { background: linear-gradient(135deg, #ff7a59 0%, #ff5630 100%); }
        .integration-icon.fathom { background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%); }
        .integration-icon.aircall { background: linear-gradient(135deg, #00d66f 0%, #00a859 100%); }

        .integration-title h3 {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .integration-title p {
            font-size: 14px;
            color: #718096;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-badge.pending {
            background: #feebc8;
            color: #7c2d12;
        }

        .integration-details {
            margin-bottom: 25px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #718096;
            font-size: 14px;
        }

        .detail-value {
            color: #2d3748;
            font-size: 14px;
            font-weight: 500;
        }

        .connect-button {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .connect-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .connect-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .connect-button.disconnect {
            background: #fed7d7;
            color: #742a2a;
        }

        .connect-button.disconnect:hover {
            background: #fc8181;
        }

        .connect-button.sync {
            background: #bee3f8;
            color: #2c5282;
            margin-top: 10px;
        }

        .connect-button.sync:hover {
            background: #90cdf4;
        }

        .connect-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .info-section h2 {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .info-section p {
            color: #718096;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .info-section ul {
            margin-left: 20px;
            color: #718096;
            line-height: 1.8;
        }

        .info-section li {
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîó Integrations</h1>
            <p>Connect your sales tools to enable automatic coaching intelligence</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Integrations Grid -->
        <div class="integrations-grid">
            <!-- HubSpot -->
            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-info">
                        <div class="integration-icon hubspot">üéØ</div>
                        <div class="integration-title">
                            <h3>HubSpot</h3>
                            <p>CRM & Activity Data</p>
                        </div>
                    </div>
                    <span class="status-badge disconnected" id="hubspot-status">Not Connected</span>
                </div>

                <div class="integration-details" id="hubspot-details">
                    <div class="detail-row">
                        <span class="detail-label">Activities Synced:</span>
                        <span class="detail-value" id="hubspot-activities">‚Äî</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Sync:</span>
                        <span class="detail-value" id="hubspot-last-sync">Never</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Auto-Sync:</span>
                        <span class="detail-value" id="hubspot-auto-sync">‚Äî</span>
                    </div>
                </div>

                <button class="connect-button primary" id="hubspot-connect" onclick="connectHubSpot()">
                    <span>Connect HubSpot</span>
                    <span>‚Üí</span>
                </button>
            </div>

            <!-- Fathom -->
            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-info">
                        <div class="integration-icon fathom">üéôÔ∏è</div>
                        <div class="integration-title">
                            <h3>Fathom</h3>
                            <p>Zoom Call Transcripts</p>
                        </div>
                    </div>
                    <span class="status-badge disconnected" id="fathom-status">Not Connected</span>
                </div>

                <div class="integration-details" id="fathom-details">
                    <div class="detail-row">
                        <span class="detail-label">Calls Synced:</span>
                        <span class="detail-value" id="fathom-calls">‚Äî</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Sync:</span>
                        <span class="detail-value" id="fathom-last-sync">Never</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Auto-Sync:</span>
                        <span class="detail-value" id="fathom-auto-sync">‚Äî</span>
                    </div>
                </div>

                <button class="connect-button primary" id="fathom-connect" onclick="connectFathom()">
                    <span>Connect Fathom</span>
                    <span>‚Üí</span>
                </button>
            </div>

            <!-- Aircall -->
            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-info">
                        <div class="integration-icon aircall">üìû</div>
                        <div class="integration-title">
                            <h3>Aircall</h3>
                            <p>Phone Call Recordings</p>
                        </div>
                    </div>
                    <span class="status-badge pending" id="aircall-status">Coming Soon</span>
                </div>

                <div class="integration-details" id="aircall-details">
                    <div class="detail-row">
                        <span class="detail-label">Calls Synced:</span>
                        <span class="detail-value" id="aircall-calls">‚Äî</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Sync:</span>
                        <span class="detail-value" id="aircall-last-sync">Never</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Auto-Sync:</span>
                        <span class="detail-value" id="aircall-auto-sync">‚Äî</span>
                    </div>
                </div>

                <button class="connect-button primary" id="aircall-connect" onclick="connectAircall()" disabled>
                    <span>Coming in Week 11</span>
                </button>
            </div>
        </div>

        <!-- Information Section -->
        <div class="info-section">
            <h2>üìñ How Integrations Work</h2>
            <p>Sandler Revenue Factory connects to your existing sales tools to automatically capture activity and conversation data. This enables AI-powered coaching with zero manual data entry.</p>

            <h2 style="margin-top: 30px;">üîí What Gets Synced?</h2>
            <ul>
                <li><strong>HubSpot:</strong> Calls, emails, meetings, deals, and contact data</li>
                <li><strong>Fathom:</strong> Zoom call transcripts and AI summaries</li>
                <li><strong>Aircall:</strong> Phone call recordings and metadata (coming soon)</li>
            </ul>

            <h2 style="margin-top: 30px;">üîê Security & Privacy</h2>
            <p>All integrations use secure OAuth 2.0 authentication. Your credentials are encrypted and never stored in plain text. You can revoke access at any time from this page or from the provider's settings.</p>

            <h2 style="margin-top: 30px;">‚öôÔ∏è Setup Instructions</h2>
            <p>To connect HubSpot or Fathom, you'll need to create a developer app in their platform. Click the "Connect" button above to start the setup process. We'll guide you through each step.</p>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://qwqlsbccwnwrdpcaccjz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3cWxzYmNjd253cmRwY2FjY2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5MjkxODAsImV4cCI6MjA1MTUwNTE4MH0.sNiod4a7-N_UtF8CWXU9xPMR_xKuXrPt4QXiLIQjFHs';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // OAuth Configuration (These will need to be replaced with actual values)
        const HUBSPOT_CLIENT_ID = 'YOUR_HUBSPOT_CLIENT_ID';
        const HUBSPOT_REDIRECT_URI = `${window.location.origin}/integrations-callback.html`;
        const FATHOM_CLIENT_ID = 'YOUR_FATHOM_CLIENT_ID';
        const FATHOM_REDIRECT_URI = `${window.location.origin}/integrations-callback.html`;

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Load integration status on page load
        async function loadIntegrationStatus() {
            try {
                // Check if user is logged in
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError || !user) {
                    showAlert('Please log in to manage integrations', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                // Load HubSpot status
                await loadHubSpotStatus();

                // Load Fathom status
                await loadFathomStatus();

                // Check for OAuth callback
                checkOAuthCallback();

            } catch (error) {
                console.error('Error loading integrations:', error);
                showAlert('Error loading integration status', 'error');
            }
        }

        async function loadHubSpotStatus() {
            try {
                const { data, error } = await supabase.rpc('get_hubspot_connection');

                if (error) throw error;

                if (data && data.length > 0) {
                    const connection = data[0];
                    updateIntegrationUI('hubspot', {
                        connected: connection.connection_status === 'active',
                        activities: connection.activities_synced || 0,
                        lastSync: connection.last_successful_sync,
                        autoSync: true
                    });
                }
            } catch (error) {
                console.error('Error loading HubSpot status:', error);
            }
        }

        async function loadFathomStatus() {
            try {
                const { data, error } = await supabase.rpc('get_fathom_connection');

                if (error) throw error;

                if (data && data.length > 0) {
                    const connection = data[0];
                    updateIntegrationUI('fathom', {
                        connected: connection.connection_status === 'active',
                        calls: connection.conversations_synced || 0,
                        lastSync: connection.last_successful_sync,
                        autoSync: true
                    });
                }
            } catch (error) {
                console.error('Error loading Fathom status:', error);
            }
        }

        function updateIntegrationUI(provider, status) {
            const statusBadge = document.getElementById(`${provider}-status`);
            const connectButton = document.getElementById(`${provider}-connect`);

            if (status.connected) {
                statusBadge.textContent = 'Connected';
                statusBadge.className = 'status-badge connected';

                connectButton.textContent = 'Disconnect';
                connectButton.className = 'connect-button disconnect';
                connectButton.onclick = () => disconnectIntegration(provider);

                // Update details
                if (provider === 'hubspot') {
                    document.getElementById('hubspot-activities').textContent = status.activities.toLocaleString();
                    document.getElementById('hubspot-last-sync').textContent = status.lastSync ? formatDate(status.lastSync) : 'Never';
                    document.getElementById('hubspot-auto-sync').textContent = status.autoSync ? 'Enabled' : 'Disabled';
                } else if (provider === 'fathom') {
                    document.getElementById('fathom-calls').textContent = status.calls.toLocaleString();
                    document.getElementById('fathom-last-sync').textContent = status.lastSync ? formatDate(status.lastSync) : 'Never';
                    document.getElementById('fathom-auto-sync').textContent = status.autoSync ? 'Enabled' : 'Disabled';
                }
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // Connect to HubSpot
        function connectHubSpot() {
            if (HUBSPOT_CLIENT_ID === 'YOUR_HUBSPOT_CLIENT_ID') {
                showAlert('HubSpot OAuth not configured yet. Please follow the setup guide.', 'info');
                alert(`To connect HubSpot, you need to:

1. Create a HubSpot developer account at https://developers.hubspot.com
2. Create a new app in your developer account
3. Add these OAuth scopes: crm.objects.contacts.read, crm.objects.deals.read, sales-email-read
4. Set the redirect URI to: ${HUBSPOT_REDIRECT_URI}
5. Copy your Client ID and update the HUBSPOT_CLIENT_ID in this file

Need help? Check the HubSpot Setup Guide in the documentation.`);
                return;
            }

            // Build OAuth URL
            const scopes = 'crm.objects.contacts.read crm.objects.deals.read sales-email-read';
            const state = generateRandomState();
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('oauth_provider', 'hubspot');

            const authUrl = `https://app.hubspot.com/oauth/authorize?client_id=${HUBSPOT_CLIENT_ID}&redirect_uri=${encodeURIComponent(HUBSPOT_REDIRECT_URI)}&scope=${encodeURIComponent(scopes)}&state=${state}`;

            window.location.href = authUrl;
        }

        // Connect to Fathom
        function connectFathom() {
            if (FATHOM_CLIENT_ID === 'YOUR_FATHOM_CLIENT_ID') {
                showAlert('Fathom OAuth not configured yet. Please follow the setup guide.', 'info');
                alert(`To connect Fathom, you need to:

1. Contact Fathom support to request API access
2. Provide your redirect URI: ${FATHOM_REDIRECT_URI}
3. Receive your Client ID and Client Secret
4. Update the FATHOM_CLIENT_ID in this file

Need help? Check the Fathom Setup Guide in the documentation.`);
                return;
            }

            const state = generateRandomState();
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('oauth_provider', 'fathom');

            // Note: This URL may need to be updated based on Fathom's actual OAuth endpoint
            const authUrl = `https://app.fathom.video/oauth/authorize?client_id=${FATHOM_CLIENT_ID}&redirect_uri=${encodeURIComponent(FATHOM_REDIRECT_URI)}&state=${state}`;

            window.location.href = authUrl;
        }

        // Connect to Aircall (coming soon)
        function connectAircall() {
            showAlert('Aircall integration coming in Week 11', 'info');
        }

        // Disconnect integration
        async function disconnectIntegration(provider) {
            if (!confirm(`Are you sure you want to disconnect ${provider}? This will stop automatic data syncing.`)) {
                return;
            }

            try {
                // Delete connection from database
                const { error } = await supabase
                    .from('API_Connections')
                    .delete()
                    .eq('provider', provider);

                if (error) throw error;

                showAlert(`${provider} disconnected successfully`, 'success');

                // Reset UI
                const statusBadge = document.getElementById(`${provider}-status`);
                statusBadge.textContent = 'Not Connected';
                statusBadge.className = 'status-badge disconnected';

                const connectButton = document.getElementById(`${provider}-connect`);
                connectButton.textContent = `Connect ${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
                connectButton.className = 'connect-button primary';
                connectButton.onclick = provider === 'hubspot' ? connectHubSpot : connectFathom;

            } catch (error) {
                console.error('Error disconnecting:', error);
                showAlert('Error disconnecting integration', 'error');
            }
        }

        // Generate random state for OAuth security
        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Check if we're returning from OAuth callback
        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const provider = urlParams.get('provider');
            const error = urlParams.get('error');

            if (success === 'true' && provider) {
                showAlert(`${provider.charAt(0).toUpperCase() + provider.slice(1)} connected successfully!`, 'success');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Reload status
                setTimeout(() => {
                    if (provider === 'hubspot') loadHubSpotStatus();
                    if (provider === 'fathom') loadFathomStatus();
                }, 1000);
            } else if (error) {
                showAlert(`Error connecting: ${error}`, 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadIntegrationStatus);
    </script>
</body>
</html>
